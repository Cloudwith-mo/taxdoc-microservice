<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TaxDoc MVP 2.0 - Full Production Version</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .container {
            background: white;
            border-radius: 12px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            padding: 40px;
            max-width: 900px;
            width: 90%;
        }
        
        .header {
            text-align: center;
            margin-bottom: 30px;
            position: relative;
        }
        
        .header h1 {
            color: #2d3748;
            font-size: 2.5rem;
            font-weight: 700;
            margin-bottom: 8px;
        }
        
        .version-badge {
            background: linear-gradient(135deg, #48bb78 0%, #38a169 100%);
            color: white;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
            position: absolute;
            top: 0;
            right: 0;
        }
        
        .header p {
            color: #718096;
            font-size: 1.1rem;
        }
        
        .production-notice {
            background: linear-gradient(135deg, #48bb78 0%, #38a169 100%);
            color: white;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
            margin-bottom: 20px;
        }
        
        .auth-section {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding: 15px;
            background: #f7fafc;
            border-radius: 8px;
        }
        
        .user-info {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .tier-badge {
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.8rem;
            font-weight: 600;
        }
        
        .tier-free { background: #e2e8f0; color: #4a5568; }
        .tier-premium { background: #ffd700; color: #744210; }
        
        .auth-buttons {
            display: flex;
            gap: 10px;
        }
        
        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
        }
        
        .btn-primary {
            background: #667eea;
            color: white;
        }
        
        .btn-secondary {
            background: #e2e8f0;
            color: #4a5568;
        }
        
        .btn:hover {
            transform: translateY(-1px);
        }
        
        .tabs {
            display: flex;
            border-bottom: 2px solid #e2e8f0;
            margin-bottom: 30px;
        }
        
        .tab {
            padding: 12px 24px;
            cursor: pointer;
            border: none;
            background: none;
            font-size: 1rem;
            font-weight: 500;
            color: #718096;
            border-bottom: 2px solid transparent;
            transition: all 0.3s ease;
        }
        
        .tab.active {
            color: #667eea;
            border-bottom-color: #667eea;
        }
        
        .tab:hover {
            color: #667eea;
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .upload-area {
            border: 2px dashed #cbd5e0;
            border-radius: 8px;
            padding: 40px;
            text-align: center;
            margin-bottom: 20px;
            transition: all 0.3s ease;
            cursor: pointer;
        }
        
        .upload-area:hover {
            border-color: #667eea;
            background-color: #f7fafc;
        }
        
        .upload-area.dragover {
            border-color: #667eea;
            background-color: #ebf8ff;
            transform: scale(1.02);
        }
        
        .upload-icon {
            font-size: 3rem;
            color: #a0aec0;
            margin-bottom: 16px;
        }
        
        .upload-text {
            color: #4a5568;
            font-size: 1.1rem;
            margin-bottom: 8px;
        }
        
        .upload-subtext {
            color: #718096;
            font-size: 0.9rem;
        }
        
        .file-preview {
            display: none;
            margin-top: 15px;
            padding: 15px;
            background: #f0fff4;
            border: 1px solid #9ae6b4;
            border-radius: 8px;
        }
        
        .preview-image {
            max-width: 200px;
            max-height: 150px;
            border-radius: 6px;
            margin-bottom: 10px;
        }
        
        #fileInput {
            display: none;
        }
        
        .process-btn {
            width: 100%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 16px;
            border-radius: 8px;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-bottom: 20px;
        }
        
        .process-btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(102, 126, 234, 0.4);
        }
        
        .process-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }
        
        .loading {
            display: none;
            text-align: center;
            margin: 20px 0;
        }
        
        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 16px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .results {
            display: none;
            margin-top: 30px;
        }
        
        .results h3 {
            color: #2d3748;
            margin-bottom: 20px;
            font-size: 1.3rem;
        }
        
        .field-grid {
            display: grid;
            gap: 12px;
        }
        
        .field-item {
            background: #f7fafc;
            padding: 16px;
            border-radius: 8px;
            border-left: 4px solid #667eea;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .field-content {
            flex: 1;
        }
        
        .field-label {
            font-weight: 600;
            color: #4a5568;
            font-size: 0.9rem;
            margin-bottom: 4px;
        }
        
        .field-value {
            color: #2d3748;
            font-size: 1.1rem;
        }
        
        .field-input {
            width: 100%;
            padding: 8px;
            border: 1px solid #cbd5e0;
            border-radius: 4px;
            font-size: 1.1rem;
            display: none;
        }
        
        .edit-mode .field-value {
            display: none;
        }
        
        .edit-mode .field-input {
            display: block;
        }
        
        .save-changes {
            background: #48bb78;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            margin: 15px 0;
            cursor: pointer;
            display: none;
        }
        
        .field-meta {
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            gap: 4px;
        }
        
        .confidence-badge {
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 0.8rem;
            font-weight: 600;
        }
        
        .confidence-high { background: #c6f6d5; color: #22543d; }
        .confidence-medium { background: #fef5e7; color: #744210; }
        .confidence-low { background: #fed7d7; color: #742a2a; }
        
        .source-icon {
            font-size: 0.8rem;
        }
        
        .error {
            background: #fed7d7;
            color: #c53030;
            padding: 16px;
            border-radius: 8px;
            margin-top: 20px;
            display: none;
        }
        
        .chat-container {
            background: #f7fafc;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
        }
        
        .chat-messages {
            background: white;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            padding: 20px;
            min-height: 300px;
            max-height: 400px;
            overflow-y: auto;
            margin-bottom: 15px;
        }
        
        .chat-input-area {
            display: flex;
            gap: 10px;
        }
        
        .chat-input {
            flex: 1;
            padding: 12px;
            border: 1px solid #cbd5e0;
            border-radius: 8px;
            font-size: 1rem;
        }
        
        .send-btn {
            background: #667eea;
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 8px;
            cursor: pointer;
        }
        
        .message {
            margin-bottom: 15px;
            display: flex;
        }
        
        .message.user {
            justify-content: flex-end;
        }
        
        .message-bubble {
            max-width: 70%;
            padding: 12px 16px;
            border-radius: 18px;
            word-wrap: break-word;
        }
        
        .message.user .message-bubble {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        
        .message.bot .message-bubble {
            background: #f7fafc;
            color: #2d3748;
            border: 1px solid #e2e8f0;
        }
        
        .analytics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .metric-card {
            background: #f7fafc;
            padding: 20px;
            border-radius: 12px;
            border-left: 4px solid #667eea;
            text-align: center;
        }
        
        .metric-value {
            font-size: 2.5rem;
            font-weight: 700;
            color: #2d3748;
            margin-bottom: 8px;
        }
        
        .metric-label {
            color: #718096;
            font-size: 0.9rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .success-message {
            background: #c6f6d5;
            color: #22543d;
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
            text-align: center;
        }
        
        .ai-insights {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 20px;
        }
        
        .sentiment-analysis {
            background: linear-gradient(135deg, #48bb78 0%, #38a169 100%);
            color: white;
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 20px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üõ°Ô∏è TaxDoc MVP 2.0</h1>
            <div class="version-badge">Production</div>
            <p>Full production version with real API integration</p>
        </div>
        
        <div class="production-notice">
            <strong>üöÄ Production Ready:</strong> Connected to live API with real document processing
        </div>
        
        <div class="auth-section" id="authSection">
            <div class="user-info" id="userInfo" style="display: none;">
                <span id="userName">üëã Welcome!</span>
                <span class="tier-badge tier-free" id="userTier">üÜì Free</span>
            </div>
            <div class="auth-buttons" id="authButtons">
                <button class="btn btn-primary" onclick="showAuthModal('login')">üîê Sign In</button>
                <button class="btn btn-secondary" onclick="showAuthModal('register')">üìù Sign Up</button>
            </div>
            <div class="auth-buttons" id="userActions" style="display: none;">
                <button class="btn btn-secondary" onclick="showPaymentModal()" id="upgradeBtn">üíé Upgrade</button>
                <button class="btn btn-secondary" onclick="logout()">üö™ Logout</button>
            </div>
        </div>
        
        <div class="tabs">
            <button class="tab active" onclick="switchTab('upload')">üìÑ Enhanced Upload</button>
            <button class="tab" onclick="switchTab('chat')">üí¨ AI Chat</button>
            <button class="tab" onclick="switchTab('analytics')">üìä Analytics</button>
        </div>
        
        <div class="tab-content active" id="upload-tab">
            <div class="upload-area" onclick="document.getElementById('fileInput').click()">
                <div class="upload-icon">üì±</div>
                <div class="upload-text">Drag & drop photos or documents</div>
                <div class="upload-subtext">üì∑ Photos ‚Ä¢ üìÑ PDFs ‚Ä¢ üñºÔ∏è Images (HEIC, JPEG, PNG)</div>
            </div>
            
            <div class="file-preview" id="filePreview">
                <img id="previewImage" class="preview-image" />
                <div id="fileInfo"></div>
            </div>
            
            <input type="file" id="fileInput" accept=".pdf,.png,.jpg,.jpeg,.heic" />
            
            <button class="process-btn" id="processBtn" disabled>Select a file to process</button>
            
            <div class="loading" id="loading">
                <div class="spinner"></div>
                <p>Processing with real AI pipeline...</p>
            </div>
            
            <div class="error" id="error"></div>
            
            <div class="results" id="results">
                <h3 id="formType"></h3>
                <div class="download-actions" id="downloadActions" style="display: none; margin-bottom: 20px;">
                    <button class="btn btn-primary" onclick="downloadExcel()" style="margin-right: 10px;">üìä Download Excel</button>
                    <button class="btn btn-primary" onclick="downloadCSV()" style="margin-right: 10px;">üìã Download CSV</button>
                    <button class="btn btn-secondary" onclick="downloadJSON()">üìÑ Download JSON</button>
                    <button class="btn btn-secondary" onclick="toggleEditMode()" id="editBtn" style="margin-left: 10px;">‚úèÔ∏è Edit Data</button>
                </div>
                <div class="field-grid" id="fieldGrid"></div>
            </div>
        </div>
        
        <div class="tab-content" id="chat-tab">
            <div class="chat-container">
                <h3>üí¨ AI Assistant with Real API</h3>
                <div class="chat-messages" id="chatMessages">
                    <div style="text-align: center; color: #718096; padding: 40px;">
                        <div style="font-size: 3rem; margin-bottom: 16px;">ü§ñ</div>
                        <p>Hi! I'm connected to the real AI system. Ask me about tax documents!</p>
                        <p style="font-size: 0.9rem; margin-top: 10px;">üí° Try: "What types of documents can you process?" or "How accurate is the extraction?"</p>
                    </div>
                </div>
                <div class="chat-input-area">
                    <input type="text" class="chat-input" id="chatInput" placeholder="Ask about your documents or tax questions..." />
                    <button class="send-btn" onclick="sendMessage()" id="sendBtn">üì§</button>
                </div>
                <div class="chat-suggestions" style="margin-top: 10px; display: flex; gap: 8px; flex-wrap: wrap;">
                    <button class="btn btn-secondary" style="font-size: 0.8rem; padding: 4px 8px;" onclick="quickChat('What documents can you process?')">üìÑ Supported docs</button>
                    <button class="btn btn-secondary" style="font-size: 0.8rem; padding: 4px 8px;" onclick="quickChat('When should I file my taxes?')">üìÖ Filing deadlines</button>
                    <button class="btn btn-secondary" style="font-size: 0.8rem; padding: 4px 8px;" onclick="quickChat('What deductions can I claim?')">üí∞ Deductions</button>
                    <button class="btn btn-secondary" style="font-size: 0.8rem; padding: 4px 8px;" id="docQuestionBtn" onclick="quickChat('Tell me about my document')" style="display: none;">üìã My Document</button>
                </div>
            </div>
        </div>
        
        <div class="tab-content" id="analytics-tab">
            <div class="analytics-grid">
                <div class="metric-card">
                    <div class="metric-value" id="totalDocs">0</div>
                    <div class="metric-label">Documents Processed</div>
                </div>
                <div class="metric-card">
                    <div class="metric-value" id="avgConfidence">0%</div>
                    <div class="metric-label">Average Confidence</div>
                </div>
                <div class="metric-card">
                    <div class="metric-value" id="userTierDisplay">Free</div>
                    <div class="metric-label">Current Tier</div>
                </div>
                <div class="metric-card">
                    <div class="metric-value" id="monthlyUsage">0/5</div>
                    <div class="metric-label">Monthly Usage</div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Configuration - Real API endpoints
        const API_BASE = 'https://iljpaj6ogl.execute-api.us-east-1.amazonaws.com/prod';
        
        // State management
        let currentUser = null;
        let userTier = 'free';
        let monthlyUsage = 0;
        let selectedFile = null;
        let processedDocuments = [];
        let currentDocumentId = null;
        let currentExtractionData = null;
        let isEditMode = false;
        let editedData = {};
        
        // Initialize app
        document.addEventListener('DOMContentLoaded', function() {
            setupEventListeners();
            loadUserData();
            updateAnalytics();
        });
        
        function setupEventListeners() {
            const fileInput = document.getElementById('fileInput');
            const uploadArea = document.querySelector('.upload-area');
            const processBtn = document.getElementById('processBtn');
            const chatInput = document.getElementById('chatInput');
            
            fileInput.addEventListener('change', handleFileSelect);
            processBtn.addEventListener('click', processDocument);
            chatInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') sendMessage();
            });
            
            // Drag and drop
            uploadArea.addEventListener('dragover', (e) => {
                e.preventDefault();
                uploadArea.classList.add('dragover');
            });
            
            uploadArea.addEventListener('dragleave', () => {
                uploadArea.classList.remove('dragover');
            });
            
            uploadArea.addEventListener('drop', (e) => {
                e.preventDefault();
                uploadArea.classList.remove('dragover');
                const files = e.dataTransfer.files;
                if (files.length > 0) {
                    fileInput.files = files;
                    handleFileSelect();
                }
            });
        }
        
        function loadUserData() {
            const saved = localStorage.getItem('taxdocMVP2User');
            if (saved) {
                currentUser = JSON.parse(saved);
                updateAuthUI();
            }
            
            const savedUsage = localStorage.getItem('taxdocMVP2Usage');
            if (savedUsage) {
                const usage = JSON.parse(savedUsage);
                monthlyUsage = usage.count || 0;
                processedDocuments = usage.documents || [];
            }
        }
        
        function saveUserData() {
            if (currentUser) {
                localStorage.setItem('taxdocMVP2User', JSON.stringify(currentUser));
            }
            localStorage.setItem('taxdocMVP2Usage', JSON.stringify({
                count: monthlyUsage,
                documents: processedDocuments
            }));
        }
        
        function handleFileSelect() {
            const file = document.getElementById('fileInput').files[0];
            if (file) {
                selectedFile = file;
                document.getElementById('processBtn').textContent = `Process ${file.name}`;
                document.getElementById('processBtn').disabled = false;
                
                // Show preview for images
                if (file.type.startsWith('image/')) {
                    showFilePreview(file);
                }
                
                hideResults();
                hideError();
            }
        }
        
        function showFilePreview(file) {
            const preview = document.getElementById('filePreview');
            const img = document.getElementById('previewImage');
            const info = document.getElementById('fileInfo');
            
            const reader = new FileReader();
            reader.onload = (e) => {
                img.src = e.target.result;
                info.innerHTML = `
                    <strong>${file.name}</strong><br>
                    Size: ${(file.size / 1024 / 1024).toFixed(2)} MB<br>
                    Type: ${file.type}
                `;
                preview.style.display = 'block';
            };
            reader.readAsDataURL(file);
        }
        
        async function processDocument() {
            if (!selectedFile) return;
            
            // Check usage limits for free tier
            if (userTier === 'free' && monthlyUsage >= 20) {
                showError('Monthly limit reached (20/20). Upgrade to Premium for unlimited processing.');
                return;
            }
            
            showLoading();
            hideResults();
            hideError();
            
            try {
                const base64 = await fileToBase64(selectedFile);
                
                const response = await fetch(`${API_BASE}/process-document`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        filename: selectedFile.name,
                        file_content: base64
                    })
                });
                
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error || `HTTP ${response.status}`);
                }
                
                const uploadResult = await response.json();
                
                // Poll for results
                const documentId = uploadResult.document_id;
                let attempts = 0;
                const maxAttempts = 30;
                
                const pollForResults = async () => {
                    try {
                        const resultResponse = await fetch(`${API_BASE}/result/${documentId}`);
                        const resultData = await resultResponse.json();
                        
                        if (resultData.status === 'completed' && resultData.data) {
                            currentDocumentId = documentId;
                            currentExtractionData = resultData;
                            showResults(resultData);
                            monthlyUsage++;
                            processedDocuments.push({
                                filename: selectedFile.name,
                                timestamp: new Date().toISOString(),
                                documentType: resultData.document_type || 'Unknown',
                                confidence: calculateAverageConfidence(resultData.data),
                                documentId: documentId
                            });
                            saveUserData();
                            updateAnalytics();
                            return;
                        }
                        
                        if (resultData.status === 'failed') {
                            throw new Error('Document processing failed');
                        }
                        
                        attempts++;
                        if (attempts < maxAttempts) {
                            setTimeout(pollForResults, 1000);
                        } else {
                            throw new Error('Processing timeout - please try again');
                        }
                        
                    } catch (pollError) {
                        showError(`Processing failed: ${pollError.message}`);
                        hideLoading();
                    }
                };
                
                setTimeout(pollForResults, 2000);
                
            } catch (err) {
                showError(`Processing failed: ${err.message}`);
                hideLoading();
            }
        }
        
        function showResults(result) {
            const formType = document.getElementById('formType');
            const fieldGrid = document.getElementById('fieldGrid');
            
            const docType = result.document_type || 'Document';
            const fieldCount = Object.keys(result.data || {}).length;
            
            formType.textContent = `${docType} - ${fieldCount} fields extracted ‚ú®`;
            fieldGrid.innerHTML = '';
            
            // Show AI insights if available
            if (result.ai_insights) {
                displayAIInsights(result.ai_insights);
            }
            
            // Show sentiment analysis if available
            if (result.sentiment_analysis) {
                displaySentimentAnalysis(result.sentiment_analysis);
            }
            
            // Display extracted fields
            const data = result.data || {};
            Object.entries(data).forEach(([key, value]) => {
                if (['confidence_scores', 'layers_used', 'extraction_method'].includes(key)) return;
                
                const fieldItem = document.createElement('div');
                fieldItem.className = 'field-item';
                fieldItem.setAttribute('data-field', key);
                
                const confidence = result.confidence_scores?.[key] || 0.95;
                
                fieldItem.innerHTML = `
                    <div class="field-content">
                        <div class="field-label">${formatFieldName(key)}</div>
                        <div class="field-value">${formatFieldValue(key, value)}</div>
                        <input type="text" class="field-input" value="${value}" data-field="${key}" />
                    </div>
                    <div class="field-meta">
                        <div class="confidence-badge ${getConfidenceClass(confidence)}">
                            ${Math.round(confidence * 100)}%
                        </div>
                        <div class="source-icon">üîç</div>
                    </div>
                `;
                
                fieldGrid.appendChild(fieldItem);
            });
            
            // Show success message
            const successDiv = document.createElement('div');
            successDiv.className = 'success-message';
            const avgConf = calculateAverageConfidence(data);
            successDiv.textContent = `üéâ Document processed successfully with ${Math.round(avgConf * 100)}% average confidence!`;
            fieldGrid.prepend(successDiv);
            
            // Show download actions and save button
            document.getElementById('downloadActions').style.display = 'block';
            
            // Show document-specific chat button
            document.getElementById('docQuestionBtn').style.display = 'inline-block';
            
            // Add save changes button
            const saveBtn = document.createElement('button');
            saveBtn.className = 'save-changes';
            saveBtn.textContent = 'üíæ Save Changes';
            saveBtn.onclick = saveEditedData;
            fieldGrid.appendChild(saveBtn);
            
            document.getElementById('results').style.display = 'block';
            hideLoading();
        }
        
        function displayAIInsights(insights) {
            const insightsDiv = document.createElement('div');
            insightsDiv.className = 'ai-insights';
            insightsDiv.innerHTML = `
                <h4 style="margin: 0 0 15px 0;">ü§ñ AI Insights</h4>
                <p style="margin: 0; line-height: 1.5;">${insights.summary || 'AI analysis completed successfully.'}</p>
            `;
            document.getElementById('fieldGrid').appendChild(insightsDiv);
        }
        
        function displaySentimentAnalysis(sentiment) {
            const sentimentDiv = document.createElement('div');
            sentimentDiv.className = 'sentiment-analysis';
            const overall = sentiment.overall_sentiment || 'neutral';
            const emoji = overall === 'positive' ? 'üòä' : overall === 'negative' ? 'üòû' : 'üòê';
            
            sentimentDiv.innerHTML = `
                <h4 style="margin: 0 0 15px 0;">üòä Sentiment Analysis</h4>
                <p style="margin: 0; line-height: 1.5;">
                    Overall sentiment: ${overall.charAt(0).toUpperCase() + overall.slice(1)} ${emoji}
                    ${sentiment.user_experience_score ? `(Score: ${sentiment.user_experience_score}/1.0)` : ''}
                </p>
            `;
            document.getElementById('fieldGrid').appendChild(sentimentDiv);
        }
        
        async function sendMessage() {
            const input = document.getElementById('chatInput');
            const message = input.value.trim();
            if (!message) return;
            
            addChatMessage(message, 'user');
            input.value = '';
            
            const sendBtn = document.getElementById('sendBtn');
            sendBtn.disabled = true;
            sendBtn.textContent = '‚è≥';
            
            const loadingId = addChatMessage('ü§î Thinking...', 'bot', true);
            
            try {
                // Prepare context for Claude
                let context = '';
                if (currentExtractionData) {
                    const data = getCurrentData();
                    context = `Document Context: ${currentExtractionData.document_type || 'Unknown document'}\n`;
                    context += `Extracted Data: ${JSON.stringify(data, null, 2)}\n`;
                    context += `Confidence Scores: ${JSON.stringify(currentExtractionData.confidence_scores || {}, null, 2)}\n`;
                }
                
                // Try the enhanced chatbot endpoint with Claude
                let response = await fetch(`${API_BASE}/enhanced-chat`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        message: message,
                        context: context,
                        document_id: currentDocumentId,
                        document_type: currentExtractionData?.document_type
                    })
                });
                
                let result;
                if (response.ok) {
                    result = await response.json();
                } else {
                    // Fallback to local processing
                    result = await handleGeneralQuestions(message);
                }
                
                document.getElementById(loadingId).remove();
                
                if (result && (result.response || result.answer || result.message)) {
                    const botMessage = result.response || result.answer || result.message;
                    addChatMessage(botMessage, 'bot');
                } else {
                    const fallbackResponse = getFallbackResponse(message);
                    addChatMessage(fallbackResponse, 'bot');
                }
                
            } catch (error) {
                document.getElementById(loadingId).remove();
                // Try local processing as fallback
                const localResult = await handleGeneralQuestions(message);
                if (localResult) {
                    addChatMessage(localResult.response, 'bot');
                } else {
                    const fallbackResponse = getFallbackResponse(message);
                    addChatMessage(fallbackResponse, 'bot');
                }
            } finally {
                sendBtn.disabled = false;
                sendBtn.textContent = 'üì§';
            }
        }
        
        async function handleGeneralQuestions(message) {
            const lowerMessage = message.toLowerCase();
            
            // Document-specific questions
            if (currentExtractionData && (lowerMessage.includes('my document') || lowerMessage.includes('this document') || lowerMessage.includes('extracted'))) {
                return handleDocumentQuestions(message, lowerMessage);
            }
            
            // Generic tax questions
            if (lowerMessage.includes('file') && (lowerMessage.includes('when') || lowerMessage.includes('deadline'))) {
                return {
                    response: "üìÖ Tax Filing Deadlines:\n\n‚Ä¢ Individual Returns (1040): April 15th (or next business day)\n‚Ä¢ Extensions: October 15th (file Form 4868 by April 15th)\n‚Ä¢ Quarterly Estimated Taxes: Jan 15, Apr 15, Jun 15, Sep 15\n‚Ä¢ Business Returns: March 15th (partnerships, S-corps) or April 15th (sole proprietors)\n\nüí° Best time to file: Early February through March for fastest refunds and to avoid last-minute rush!"
                };
            }
            
            if (lowerMessage.includes('deduction') || lowerMessage.includes('write off')) {
                return {
                    response: "üí∞ Common Tax Deductions:\n\n‚Ä¢ Standard Deduction 2024: $14,600 (single), $29,200 (married filing jointly)\n‚Ä¢ Home Office: $5/sq ft up to 300 sq ft or actual expenses\n‚Ä¢ Business Expenses: Equipment, software, travel, meals (50%)\n‚Ä¢ Charitable Donations: Cash and property donations\n‚Ä¢ Medical Expenses: Over 7.5% of AGI\n‚Ä¢ State/Local Taxes: Up to $10,000 (SALT cap)\n\nüìã Keep detailed records and receipts for all deductions!"
                };
            }
            
            if (lowerMessage.includes('refund') || lowerMessage.includes('owe')) {
                return {
                    response: "üí∏ Tax Refunds & Payments:\n\n‚Ä¢ Refund Timeline: 21 days for e-filed returns, 6-8 weeks for paper\n‚Ä¢ Direct Deposit: Fastest way to receive refunds\n‚Ä¢ Payment Options: Online, phone, mail, or installment plans\n‚Ä¢ Underpayment Penalty: Avoid by paying 90% of current year or 100% of prior year tax\n\nüîç Check refund status at IRS.gov/refunds with SSN, filing status, and refund amount!"
                };
            }
            
            if (lowerMessage.includes('audit') || lowerMessage.includes('irs')) {
                return {
                    response: "üîç IRS Audits & Compliance:\n\n‚Ä¢ Audit Rate: Less than 1% of returns are audited\n‚Ä¢ Red Flags: Large deductions, unreported income, math errors\n‚Ä¢ Record Keeping: Keep tax records for 3-7 years\n‚Ä¢ Audit Types: Correspondence (mail), office, or field audits\n‚Ä¢ Professional Help: Consider hiring a tax professional for complex situations\n\nüìã Always respond promptly to IRS notices and keep detailed documentation!"
                };
            }
            
            // System capability questions
            if (lowerMessage.includes('document') && lowerMessage.includes('process')) {
                return {
                    response: "üìÑ I can process 11+ document types including W-2, 1099-NEC, 1099-INT, 1099-DIV, 1099-MISC, 1098-E, 1098, 1095-A, 1040, bank statements, pay stubs, receipts, and invoices. The system uses a three-layer AI extraction pipeline with 87-99% accuracy!"
                };
            }
            
            if (lowerMessage.includes('accuracy') || lowerMessage.includes('confident')) {
                return {
                    response: "üéØ Our three-layer AI pipeline achieves 87-99% accuracy: Layer 1 uses Textract queries (99% on W-2, 98% on 1099-NEC), Layer 2 uses Claude 4 LLM for smart fallback, and Layer 3 uses regex patterns as a safety net. This ensures no important data is missed!"
                };
            }
            
            if (lowerMessage.includes('pipeline') || lowerMessage.includes('layer')) {
                return {
                    response: "üîß The three-layer extraction pipeline works as follows:\n\nüîç Layer 1: Textract Queries (Primary) - Natural language queries for structured extraction\nü§ñ Layer 2: Claude 4 LLM (Smart Fallback) - AI-powered extraction for low-confidence fields\n‚ö° Layer 3: Regex Patterns (Safety Net) - Pattern-based extraction for critical fields\n\nThis intelligent approach saves 60-80% of LLM costs while maintaining high accuracy!"
                };
            }
            
            return null;
        }
        
        function handleDocumentQuestions(message, lowerMessage) {
            const data = getCurrentData();
            const docType = currentExtractionData.document_type || 'document';
            
            if (lowerMessage.includes('total') || lowerMessage.includes('amount')) {
                const amounts = Object.entries(data).filter(([key, value]) => 
                    (key.includes('wage') || key.includes('income') || key.includes('compensation') || key.includes('total')) && 
                    typeof value === 'number'
                );
                
                if (amounts.length > 0) {
                    const amountList = amounts.map(([key, value]) => 
                        `‚Ä¢ ${formatFieldName(key)}: ${formatFieldValue(key, value)}`
                    ).join('\n');
                    return {
                        response: `üí∞ Here are the amounts from your ${docType}:\n\n${amountList}\n\n${getDocumentInsights(docType, data)}`
                    };
                }
            }
            
            if (lowerMessage.includes('tax') && (lowerMessage.includes('withheld') || lowerMessage.includes('paid'))) {
                const taxes = Object.entries(data).filter(([key, value]) => 
                    key.includes('tax') && typeof value === 'number'
                );
                
                if (taxes.length > 0) {
                    const taxList = taxes.map(([key, value]) => 
                        `‚Ä¢ ${formatFieldName(key)}: ${formatFieldValue(key, value)}`
                    ).join('\n');
                    return {
                        response: `üèõÔ∏è Tax information from your ${docType}:\n\n${taxList}\n\nüí° This shows taxes already withheld from your income. You may get a refund if too much was withheld!`
                    };
                }
            }
            
            if (lowerMessage.includes('employer') || lowerMessage.includes('company')) {
                const employer = data.employer_name || data.payer_name || data.company_name;
                if (employer) {
                    return {
                        response: `üè¢ Your ${docType} is from: ${employer}\n\nüìã Make sure this matches your records and that you have all documents from this employer for the tax year.`
                    };
                }
            }
            
            // General document summary
            const fieldCount = Object.keys(data).filter(key => 
                !['confidence_scores', 'layers_used', 'extraction_method'].includes(key)
            ).length;
            
            return {
                response: `üìÑ Your ${docType} Summary:\n\n‚Ä¢ Document Type: ${docType}\n‚Ä¢ Fields Extracted: ${fieldCount}\n‚Ä¢ Processing Confidence: ${Math.round(calculateAverageConfidence(data) * 100)}%\n\nüí¨ Ask me specific questions like:\n‚Ä¢ "What's my total income?"\n‚Ä¢ "How much tax was withheld?"\n‚Ä¢ "Who is my employer?"`
            };
        }
        
        function getDocumentInsights(docType, data) {
            if (docType.includes('W-2')) {
                return "üí° W-2 Tip: Compare Box 1 (wages) vs Box 2 (federal tax withheld) to estimate your refund or balance due.";
            }
            if (docType.includes('1099')) {
                return "üí° 1099 Tip: This is income where taxes weren't withheld. You may need to pay estimated taxes or owe at filing.";
            }
            if (docType.includes('bank')) {
                return "üí° Bank Statement Tip: Use this to track deductible expenses and verify income reported on tax forms.";
            }
            return "üí° Keep this document with your tax records for at least 3 years after filing.";
        }
        
        function getFallbackResponse(message) {
            const responses = [
                "I'm here to help with tax document processing! I can explain our AI extraction pipeline, supported document types, and accuracy rates.",
                "Great question! Our system processes tax forms, financial documents, and business receipts with high accuracy. What would you like to know more about?",
                "I can help you understand how our three-layer AI extraction works, or answer questions about the documents we support. Feel free to ask!",
                "Our AI system is designed to handle complex tax documents with 87-99% accuracy. What specific aspect would you like to learn about?"
            ];
            return responses[Math.floor(Math.random() * responses.length)];
        }
        
        function quickChat(message) {
            document.getElementById('chatInput').value = message;
            sendMessage();
        }
        
        function addChatMessage(message, sender, isLoading = false) {
            const container = document.getElementById('chatMessages');
            
            // Clear welcome message
            if (container.children.length === 1 && container.children[0].style.textAlign === 'center') {
                container.innerHTML = '';
            }
            
            const messageDiv = document.createElement('div');
            const messageId = 'msg-' + Date.now();
            messageDiv.id = messageId;
            messageDiv.className = `message ${sender}`;
            
            const bubble = document.createElement('div');
            bubble.className = 'message-bubble';
            bubble.textContent = message;
            
            messageDiv.appendChild(bubble);
            container.appendChild(messageDiv);
            container.scrollTop = container.scrollHeight;
            
            return messageId;
        }
        
        function calculateAverageConfidence(data) {
            const values = Object.values(data).filter(v => typeof v === 'number' && v <= 1);
            return values.length > 0 ? values.reduce((sum, val) => sum + val, 0) / values.length : 0.95;
        }
        
        function updateAnalytics() {
            document.getElementById('totalDocs').textContent = monthlyUsage;
            
            const avgConf = processedDocuments.length > 0 
                ? Math.round(processedDocuments.reduce((sum, doc) => sum + doc.confidence, 0) / processedDocuments.length * 100)
                : 95;
            document.getElementById('avgConfidence').textContent = avgConf + '%';
            
            document.getElementById('userTierDisplay').textContent = userTier === 'premium' ? 'Premium' : 'Free';
            document.getElementById('monthlyUsage').textContent = 
                userTier === 'premium' ? 'Unlimited' : `${monthlyUsage}/20`;
        }
        
        function updateAuthUI() {
            const authButtons = document.getElementById('authButtons');
            const userActions = document.getElementById('userActions');
            const userInfo = document.getElementById('userInfo');
            const userName = document.getElementById('userName');
            const userTierEl = document.getElementById('userTier');
            
            if (currentUser) {
                authButtons.style.display = 'none';
                userActions.style.display = 'flex';
                userInfo.style.display = 'flex';
                userName.textContent = `üëã ${currentUser.name}`;
                userTierEl.textContent = currentUser.tier === 'premium' ? 'üíé Premium' : 'üÜì Free';
                userTierEl.className = `tier-badge tier-${currentUser.tier}`;
                userTier = currentUser.tier;
                
                document.getElementById('upgradeBtn').style.display = 
                    currentUser.tier === 'premium' ? 'none' : 'block';
            } else {
                authButtons.style.display = 'flex';
                userActions.style.display = 'none';
                userInfo.style.display = 'none';
            }
            
            updateAnalytics();
        }
        
        // Mock authentication for demo
        function showAuthModal(mode) {
            const email = prompt(`Enter email for ${mode}:`);
            if (email) {
                currentUser = {
                    email: email,
                    name: email.split('@')[0],
                    tier: 'free'
                };
                updateAuthUI();
                saveUserData();
                alert(`üéâ Welcome ${currentUser.name}! You're signed in with a Free account.`);
            }
        }
        
        function showPaymentModal() {
            if (confirm('Upgrade to Premium for $29/month?\n\n‚úÖ Unlimited documents\n‚úÖ AI insights\n‚úÖ Priority support')) {
                if (currentUser) {
                    currentUser.tier = 'premium';
                    userTier = 'premium';
                    updateAuthUI();
                    saveUserData();
                    alert('üéâ Upgraded to Premium! You now have unlimited processing.');
                }
            }
        }
        
        function logout() {
            currentUser = null;
            monthlyUsage = 0;
            processedDocuments = [];
            localStorage.removeItem('taxdocMVP2User');
            localStorage.removeItem('taxdocMVP2Usage');
            updateAuthUI();
            alert('üëã Signed out successfully!');
        }
        
        // Utility functions
        function fileToBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = () => resolve(reader.result.split(',')[1]);
                reader.onerror = reject;
            });
        }
        
        function formatFieldName(key) {
            return key.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
        }
        
        function formatFieldValue(key, value) {
            if (key.includes('ssn') && typeof value === 'string' && value.length >= 9) {
                return '***-**-' + value.slice(-4);
            }
            if (typeof value === 'number' && (key.includes('wages') || key.includes('tax') || key.includes('compensation'))) {
                return '$' + value.toLocaleString();
            }
            return value;
        }
        
        function getConfidenceClass(confidence) {
            if (confidence >= 0.9) return 'confidence-high';
            if (confidence >= 0.7) return 'confidence-medium';
            return 'confidence-low';
        }
        
        function switchTab(tabName) {
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            document.getElementById(tabName + '-tab').classList.add('active');
            event.target.classList.add('active');
        }
        
        function showLoading() {
            document.getElementById('loading').style.display = 'block';
            document.getElementById('processBtn').disabled = true;
        }
        
        function hideLoading() {
            document.getElementById('loading').style.display = 'none';
            document.getElementById('processBtn').disabled = false;
        }
        
        function showError(message) {
            const error = document.getElementById('error');
            error.textContent = message;
            error.style.display = 'block';
        }
        
        function hideError() {
            document.getElementById('error').style.display = 'none';
        }
        
        function hideResults() {
            document.getElementById('results').style.display = 'none';
            document.getElementById('downloadActions').style.display = 'none';
            document.getElementById('docQuestionBtn').style.display = 'none';
            isEditMode = false;
            editedData = {};
        }
        
        // Download functions
        async function downloadExcel() {
            if (!currentDocumentId) {
                alert('No document processed yet. Please process a document first.');
                return;
            }
            
            try {
                const response = await fetch(`${API_BASE}/download-excel/${currentDocumentId}`);
                
                if (response.ok) {
                    const blob = await response.blob();
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `${selectedFile.name.split('.')[0]}_extracted_data.xlsx`;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    window.URL.revokeObjectURL(url);
                    
                    // Show success message
                    const successDiv = document.createElement('div');
                    successDiv.className = 'success-message';
                    successDiv.textContent = 'üìä Excel file downloaded successfully!';
                    successDiv.style.position = 'fixed';
                    successDiv.style.top = '20px';
                    successDiv.style.right = '20px';
                    successDiv.style.zIndex = '1000';
                    document.body.appendChild(successDiv);
                    
                    setTimeout(() => {
                        document.body.removeChild(successDiv);
                    }, 3000);
                } else {
                    throw new Error('Excel download not available');
                }
            } catch (error) {
                // Fallback: create Excel from current data
                downloadExcelFallback();
            }
        }
        
        function downloadExcelFallback() {
            if (!currentExtractionData) {
                alert('No extraction data available.');
                return;
            }
            
            // Create CSV content (Excel alternative)
            const data = currentExtractionData.data;
            let csvContent = 'Field,Value,Confidence\n';
            
            Object.entries(data).forEach(([key, value]) => {
                if (['confidence_scores', 'layers_used', 'extraction_method'].includes(key)) return;
                
                const confidence = currentExtractionData.confidence_scores?.[key] || 0.95;
                const cleanValue = String(value).replace(/,/g, ';'); // Replace commas to avoid CSV issues
                csvContent += `"${formatFieldName(key)}","${cleanValue}","${Math.round(confidence * 100)}%"\n`;
            });
            
            // Download CSV
            const blob = new Blob([csvContent], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `${selectedFile.name.split('.')[0]}_extracted_data.csv`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);
            
            alert('üìä Downloaded as CSV file (Excel alternative)');
        }
        
        function downloadCSV() {
            if (!currentExtractionData) {
                alert('No extraction data available.');
                return;
            }
            
            const data = getCurrentData();
            let csvContent = 'Field,Value,Confidence,Edited\n';
            
            Object.entries(data).forEach(([key, value]) => {
                if (['confidence_scores', 'layers_used', 'extraction_method'].includes(key)) return;
                
                const confidence = currentExtractionData.confidence_scores?.[key] || 0.95;
                const isEdited = editedData.hasOwnProperty(key) ? 'Yes' : 'No';
                const cleanValue = String(value).replace(/"/g, '""'); // Escape quotes
                csvContent += `"${formatFieldName(key)}","${cleanValue}","${Math.round(confidence * 100)}%","${isEdited}"\n`;
            });
            
            const blob = new Blob([csvContent], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `${selectedFile.name.split('.')[0]}_extracted_data.csv`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);
            
            showNotification('üìã CSV file downloaded successfully!');
        }
        
        function downloadJSON() {
            if (!currentExtractionData) {
                alert('No extraction data available.');
                return;
            }
            
            const jsonData = {
                document_info: {
                    filename: selectedFile.name,
                    document_type: currentExtractionData.document_type,
                    processed_at: new Date().toISOString(),
                    document_id: currentDocumentId,
                    edited: Object.keys(editedData).length > 0
                },
                extracted_data: getCurrentData(),
                original_data: currentExtractionData.data,
                edited_fields: editedData,
                confidence_scores: currentExtractionData.confidence_scores,
                ai_insights: currentExtractionData.ai_insights,
                sentiment_analysis: currentExtractionData.sentiment_analysis
            };
            
            const blob = new Blob([JSON.stringify(jsonData, null, 2)], { type: 'application/json' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `${selectedFile.name.split('.')[0]}_extracted_data.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);
            
            showNotification('üìÑ JSON file downloaded successfully!');
        }
        
        function toggleEditMode() {
            isEditMode = !isEditMode;
            const fieldGrid = document.getElementById('fieldGrid');
            const editBtn = document.getElementById('editBtn');
            const saveBtn = document.querySelector('.save-changes');
            
            if (isEditMode) {
                fieldGrid.classList.add('edit-mode');
                editBtn.textContent = '‚ùå Cancel Edit';
                if (saveBtn) saveBtn.style.display = 'block';
            } else {
                fieldGrid.classList.remove('edit-mode');
                editBtn.textContent = '‚úèÔ∏è Edit Data';
                if (saveBtn) saveBtn.style.display = 'none';
                // Reset any unsaved changes
                document.querySelectorAll('.field-input').forEach(input => {
                    const field = input.getAttribute('data-field');
                    const originalValue = currentExtractionData.data[field];
                    input.value = editedData[field] || originalValue;
                });
            }
        }
        
        function saveEditedData() {
            const inputs = document.querySelectorAll('.field-input');
            let hasChanges = false;
            
            inputs.forEach(input => {
                const field = input.getAttribute('data-field');
                const originalValue = currentExtractionData.data[field];
                const newValue = input.value.trim();
                
                if (newValue !== String(originalValue)) {
                    editedData[field] = newValue;
                    hasChanges = true;
                    
                    // Update the display value
                    const fieldItem = input.closest('.field-item');
                    const valueDiv = fieldItem.querySelector('.field-value');
                    valueDiv.textContent = formatFieldValue(field, newValue);
                }
            });
            
            if (hasChanges) {
                showNotification('üíæ Changes saved successfully!');
                toggleEditMode();
            } else {
                showNotification('üìù No changes detected.');
            }
        }
        
        function getCurrentData() {
            const data = { ...currentExtractionData.data };
            Object.keys(editedData).forEach(key => {
                data[key] = editedData[key];
            });
            return data;
        }
        
        function showNotification(message) {
            const notification = document.createElement('div');
            notification.className = 'success-message';
            notification.textContent = message;
            notification.style.position = 'fixed';
            notification.style.top = '20px';
            notification.style.right = '20px';
            notification.style.zIndex = '1000';
            notification.style.maxWidth = '300px';
            document.body.appendChild(notification);
            
            setTimeout(() => {
                if (document.body.contains(notification)) {
                    document.body.removeChild(notification);
                }
            }, 3000);
        }
    </script>
</body>
</html>