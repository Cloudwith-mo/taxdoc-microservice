<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TaxDoc MVP 2.0 - Full Production Version</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .container {
            background: white;
            border-radius: 12px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            padding: 40px;
            max-width: 900px;
            width: 90%;
        }
        
        .header {
            text-align: center;
            margin-bottom: 30px;
            position: relative;
        }
        
        .header h1 {
            color: #2d3748;
            font-size: 2.5rem;
            font-weight: 700;
            margin-bottom: 8px;
        }
        
        .version-badge {
            background: linear-gradient(135deg, #48bb78 0%, #38a169 100%);
            color: white;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
            position: absolute;
            top: 0;
            right: 0;
        }
        
        .header p {
            color: #718096;
            font-size: 1.1rem;
        }
        
        .production-notice {
            background: linear-gradient(135deg, #48bb78 0%, #38a169 100%);
            color: white;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
            margin-bottom: 20px;
        }
        
        .auth-section {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding: 15px;
            background: #f7fafc;
            border-radius: 8px;
        }
        
        .user-info {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .tier-badge {
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.8rem;
            font-weight: 600;
        }
        
        .tier-free { background: #e2e8f0; color: #4a5568; }
        .tier-premium { background: #ffd700; color: #744210; }
        
        .auth-buttons {
            display: flex;
            gap: 10px;
        }
        
        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
        }
        
        .btn-primary {
            background: #667eea;
            color: white;
        }
        
        .btn-secondary {
            background: #e2e8f0;
            color: #4a5568;
        }
        
        .btn:hover {
            transform: translateY(-1px);
        }
        
        .tabs {
            display: flex;
            border-bottom: 2px solid #e2e8f0;
            margin-bottom: 30px;
        }
        
        .tab {
            padding: 12px 24px;
            cursor: pointer;
            border: none;
            background: none;
            font-size: 1rem;
            font-weight: 500;
            color: #718096;
            border-bottom: 2px solid transparent;
            transition: all 0.3s ease;
        }
        
        .tab.active {
            color: #667eea;
            border-bottom-color: #667eea;
        }
        
        .tab:hover {
            color: #667eea;
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .upload-area {
            border: 2px dashed #cbd5e0;
            border-radius: 8px;
            padding: 40px;
            text-align: center;
            margin-bottom: 20px;
            transition: all 0.3s ease;
            cursor: pointer;
        }
        
        .upload-area:hover {
            border-color: #667eea;
            background-color: #f7fafc;
        }
        
        .upload-area.dragover {
            border-color: #667eea;
            background-color: #ebf8ff;
            transform: scale(1.02);
        }
        
        .upload-icon {
            font-size: 3rem;
            color: #a0aec0;
            margin-bottom: 16px;
        }
        
        .upload-text {
            color: #4a5568;
            font-size: 1.1rem;
            margin-bottom: 8px;
        }
        
        .upload-subtext {
            color: #718096;
            font-size: 0.9rem;
        }
        
        .file-preview {
            display: none;
            margin-top: 15px;
            padding: 15px;
            background: #f0fff4;
            border: 1px solid #9ae6b4;
            border-radius: 8px;
        }
        
        .preview-image {
            max-width: 200px;
            max-height: 150px;
            border-radius: 6px;
            margin-bottom: 10px;
        }
        
        #fileInput {
            display: none;
        }
        
        .process-btn {
            width: 100%;
            background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
            color: white;
            border: none;
            padding: 16px;
            border-radius: 8px;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-bottom: 20px;
        }
        
        .process-btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(44, 62, 80, 0.4);
        }
        
        .process-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }
        
        .loading {
            display: none;
            text-align: center;
            margin: 20px 0;
        }
        
        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 16px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .results {
            display: none;
            margin-top: 30px;
        }
        
        .results h3 {
            color: #2d3748;
            margin-bottom: 20px;
            font-size: 1.3rem;
        }
        
        .field-grid {
            display: grid;
            gap: 12px;
        }
        
        .field-item {
            background: #f7fafc;
            padding: 16px;
            border-radius: 8px;
            border-left: 4px solid #667eea;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .field-content {
            flex: 1;
        }
        
        .field-label {
            font-weight: 600;
            color: #4a5568;
            font-size: 0.9rem;
            margin-bottom: 4px;
        }
        
        .field-value {
            color: #2d3748;
            font-size: 1.1rem;
        }
        
        .field-input {
            width: 100%;
            padding: 8px;
            border: 1px solid #cbd5e0;
            border-radius: 4px;
            font-size: 1.1rem;
            display: none;
        }
        
        .edit-mode .field-value {
            display: none;
        }
        
        .edit-mode .field-input {
            display: block;
        }
        
        .save-changes {
            background: #48bb78;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            margin: 15px 0;
            cursor: pointer;
            display: none;
        }
        
        .field-meta {
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            gap: 4px;
        }
        
        .confidence-badge {
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 0.8rem;
            font-weight: 600;
        }
        
        .confidence-high { background: #c6f6d5; color: #22543d; }
        .confidence-medium { background: #fef5e7; color: #744210; }
        .confidence-low { background: #fed7d7; color: #742a2a; }
        
        .source-icon {
            font-size: 0.8rem;
        }
        
        .error {
            background: #fed7d7;
            color: #c53030;
            padding: 16px;
            border-radius: 8px;
            margin-top: 20px;
            display: none;
        }
        
        .chat-container {
            background: #f7fafc;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
        }
        
        .chat-messages {
            background: white;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            padding: 20px;
            min-height: 300px;
            max-height: 400px;
            overflow-y: auto;
            margin-bottom: 15px;
        }
        
        .chat-input-area {
            display: flex;
            gap: 10px;
        }
        
        .chat-input {
            flex: 1;
            padding: 12px;
            border: 1px solid #cbd5e0;
            border-radius: 8px;
            font-size: 1rem;
        }
        
        .send-btn {
            background: #667eea;
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 8px;
            cursor: pointer;
        }
        
        .message {
            margin-bottom: 15px;
            display: flex;
        }
        
        .message.user {
            justify-content: flex-end;
        }
        
        .message-bubble {
            max-width: 70%;
            padding: 12px 16px;
            border-radius: 18px;
            word-wrap: break-word;
            white-space: pre-wrap;
            overflow-wrap: break-word;
        }
        
        .message.user .message-bubble {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        
        .message.bot .message-bubble {
            background: #f7fafc;
            color: #2d3748;
            border: 1px solid #e2e8f0;
        }
        
        .documents-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .document-card {
            background: #f7fafc;
            padding: 20px;
            border-radius: 12px;
            border-left: 4px solid #667eea;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .document-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(0,0,0,0.1);
        }
        
        .exports-list {
            display: grid;
            gap: 15px;
        }
        
        .export-item {
            background: #f7fafc;
            padding: 15px;
            border-radius: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .usage-warning {
            background: #fed7d7;
            color: #c53030;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            text-align: center;
        }
        
        .success-message {
            background: #c6f6d5;
            color: #22543d;
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
            text-align: center;
        }
        
        .ai-insights {
            background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
            color: white;
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 20px;
        }
        
        .sentiment-analysis {
            background: linear-gradient(135deg, #48bb78 0%, #38a169 100%);
            color: white;
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 20px;
        }
        
        .analytics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .metric-card {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            text-align: center;
        }
        
        .metric-value {
            font-size: 2em;
            font-weight: bold;
            color: #2c3e50;
            margin-bottom: 8px;
        }
        
        .metric-label {
            color: #666;
            font-size: 0.9rem;
        }
        
        .chart-container {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-top: 20px;
        }
        
        .pricing-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .pricing-card {
            background: white;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            text-align: center;
            position: relative;
            border: 2px solid transparent;
            transition: all 0.3s ease;
        }
        
        .pricing-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.15);
        }
        
        .pricing-card.popular {
            border-color: #2c3e50;
            transform: scale(1.05);
        }
        
        .pricing-card.popular::before {
            content: '🔥 Most Popular';
            position: absolute;
            top: -12px;
            left: 50%;
            transform: translateX(-50%);
            background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
            color: white;
            padding: 6px 20px;
            border-radius: 20px;
            font-size: 0.8em;
            font-weight: bold;
        }
        
        .pricing-card h4 {
            margin: 0 0 15px 0;
            color: #2c3e50;
            font-size: 1.4rem;
        }
        
        .price {
            font-size: 3rem;
            font-weight: bold;
            color: #2c3e50;
            margin: 20px 0;
        }
        
        .price span {
            font-size: 0.4em;
            color: #666;
        }
        
        .pricing-card ul {
            list-style: none;
            padding: 0;
            margin: 25px 0;
            text-align: left;
        }
        
        .pricing-card li {
            padding: 8px 0;
            border-bottom: 1px solid #f0f0f0;
            font-size: 0.9rem;
        }
        
        .pricing-card li:last-child {
            border-bottom: none;
        }
        
        .plan-btn {
            width: 100%;
            padding: 15px;
            border: none;
            border-radius: 8px;
            font-weight: bold;
            cursor: pointer;
            margin-top: 20px;
            font-size: 1rem;
            transition: all 0.3s ease;
        }
        
        .plan-btn:hover {
            transform: translateY(-2px);
        }
        
        .plan-btn.current {
            background: #95a5a6;
            color: white;
        }
        
        .starter .plan-btn, .professional .plan-btn, .enterprise .plan-btn {
            background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
            color: white;
        }
        
        .usage-summary {
            background: white;
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .usage-bar {
            width: 100%;
            height: 25px;
            background: #ecf0f1;
            border-radius: 15px;
            overflow: hidden;
            margin: 15px 0;
        }
        
        .usage-fill {
            height: 100%;
            background: linear-gradient(90deg, #2c3e50, #34495e);
            transition: width 0.3s ease;
            border-radius: 15px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>🛡️ TaxDoc MVP 2.0</h1>
            <div class="version-badge">Production</div>
            <p>Full production version with real API integration</p>
        </div>
        
        <div class="production-notice">
            <strong>🚀 Production Ready:</strong> Connected to live API with real document processing
        </div>
        
        <div class="auth-section" id="authSection">
            <div class="user-info" id="userInfo" style="display: none;">
                <span id="userName">👋 Welcome!</span>
                <span class="tier-badge tier-free" id="userTier">🆓 Free</span>
            </div>
            <div class="auth-buttons" id="authButtons">
                <button class="btn btn-primary" onclick="showAuthModal('login')">🔐 Sign In</button>
                <button class="btn btn-secondary" onclick="showAuthModal('register')">📝 Sign Up</button>
            </div>
            <div class="auth-buttons" id="userActions" style="display: none;">
                <button class="btn btn-secondary" onclick="showPaymentModal()" id="upgradeBtn">💎 Upgrade</button>
                <button class="btn btn-secondary" onclick="logout()">🚪 Logout</button>
            </div>
        </div>
        
        <div class="tabs">
            <button class="tab active" onclick="switchTab('import')">📥 Import</button>
            <button class="tab" onclick="switchTab('documents')">📄 Documents</button>
            <button class="tab" onclick="switchTab('exports')">📤 Exports</button>
            <button class="tab" onclick="switchTab('analytics')">📊 Analytics</button>
            <button class="tab" onclick="switchTab('chatbot')">🤖 AI Chatbot</button>
            <button class="tab" onclick="switchTab('subscriptions')">💎 Subscriptions</button>
        </div>
        
        <div class="tab-content active" id="import-tab">
            <div class="upload-methods" style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
                <div class="upload-area" onclick="document.getElementById('fileInput').click()">
                    <div class="upload-icon">📱</div>
                    <div class="upload-text">Drag & Drop Upload</div>
                    <div class="upload-subtext">📷 Photos • 📄 PDFs • 🖼️ Images</div>
                </div>
                
                <div class="upload-area" onclick="document.getElementById('batchInput').click()">
                    <div class="upload-icon">📁</div>
                    <div class="upload-text">Batch Upload</div>
                    <div class="upload-subtext">📎 Multiple files at once</div>
                </div>
            </div>
            
            <div class="email-upload" style="background: #f0f8ff; padding: 15px; border-radius: 8px; margin-bottom: 20px; text-align: center;">
                <div style="font-size: 1.1rem; font-weight: 600; margin-bottom: 8px;">📧 Email Upload</div>
                <div style="color: #666;">Forward documents to: <strong>taxflowsai@gmail.com</strong></div>
                <div style="font-size: 0.9rem; color: #888; margin-top: 5px;">From your registered email address</div>
            </div>
            
            <div class="file-preview" id="filePreview">
                <img id="previewImage" class="preview-image" />
                <div id="fileInfo"></div>
            </div>
            
            <div class="batch-preview" id="batchPreview" style="display: none; margin-top: 15px;">
                <h4>Selected Files:</h4>
                <div id="batchFileList"></div>
            </div>
            
            <input type="file" id="fileInput" accept=".pdf,.png,.jpg,.jpeg,.heic" />
            <input type="file" id="batchInput" accept=".pdf,.png,.jpg,.jpeg,.heic" multiple style="display: none;" />
            
            <button class="process-btn" id="processBtn" disabled>Select files to process</button>
            
            <div class="loading" id="loading">
                <div class="spinner"></div>
                <p>Processing with real AI pipeline...</p>
            </div>
            
            <div class="error" id="error"></div>
            
            <div class="results" id="results">
                <h3 id="formType"></h3>
                <div class="download-actions" id="downloadActions" style="display: none; margin-bottom: 20px;">
                    <button class="btn btn-primary" onclick="downloadExcel()" style="margin-right: 10px;">📊 Download Excel</button>
                    <button class="btn btn-primary" onclick="downloadCSV()" style="margin-right: 10px;">📋 Download CSV</button>
                    <button class="btn btn-secondary" onclick="downloadJSON()">📄 Download JSON</button>
                    <button class="btn btn-secondary" onclick="toggleEditMode()" id="editBtn" style="margin-left: 10px;">✏️ Edit Data</button>
                </div>
                <div class="field-grid" id="fieldGrid"></div>
            </div>
        </div>
        
        <div class="tab-content" id="documents-tab">
            <div class="documents-grid" id="documentsGrid">
                <div style="text-align: center; color: #718096; padding: 40px;">
                    <div style="font-size: 3rem; margin-bottom: 16px;">📄</div>
                    <p>No documents processed yet. Import documents to get started!</p>
                </div>
            </div>
        </div>
        
        <div class="tab-content" id="exports-tab">
            <div class="exports-list" id="exportsList">
                <div style="text-align: center; color: #718096; padding: 40px;">
                    <div style="font-size: 3rem; margin-bottom: 16px;">📤</div>
                    <p>No exports yet. Process documents to create exports!</p>
                </div>
            </div>
        </div>
        
        <div class="tab-content" id="analytics-tab">
            <h3>📊 Analytics Dashboard</h3>
            <div class="analytics-grid">
                <div class="metric-card">
                    <div class="metric-value" id="totalDocs">0</div>
                    <div class="metric-label">Documents Processed</div>
                </div>
                <div class="metric-card">
                    <div class="metric-value" id="avgConfidence">0%</div>
                    <div class="metric-label">Average Confidence</div>
                </div>
                <div class="metric-card">
                    <div class="metric-value" id="userTierDisplay">Free</div>
                    <div class="metric-label">Current Tier</div>
                </div>
                <div class="metric-card">
                    <div class="metric-value" id="monthlyUsage">0/20</div>
                    <div class="metric-label">Monthly Usage</div>
                </div>
            </div>
            <div class="chart-container">
                <h4>Processing Trends</h4>
                <canvas id="analyticsChart" width="400" height="200" style="background: #f7fafc; border-radius: 8px;"></canvas>
            </div>
        </div>
        
        <div class="tab-content" id="chatbot-tab">
            <div class="chat-container">
                <h3>🤖 AI Assistant with Real API</h3>
                <div class="chat-messages" id="chatMessages">
                    <div style="text-align: center; color: #718096; padding: 40px;">
                        <div style="font-size: 3rem; margin-bottom: 16px;">🤖</div>
                        <p>Hi! I'm connected to the real AI system. Ask me about tax documents!</p>
                        <p style="font-size: 0.9rem; margin-top: 10px;">💡 Try: "What types of documents can you process?" or "How accurate is the extraction?"</p>
                    </div>
                </div>
                <div class="chat-input-area">
                    <input type="text" class="chat-input" id="chatInput" placeholder="Ask about your documents or tax questions..." />
                    <button class="send-btn" onclick="sendMessage()" id="sendBtn">📤</button>
                </div>
                <div class="chat-suggestions" style="margin-top: 10px; display: flex; gap: 8px; flex-wrap: wrap;">
                    <button class="btn btn-secondary" style="font-size: 0.8rem; padding: 4px 8px;" onclick="quickChat('What documents can you process?')">📄 Supported docs</button>
                    <button class="btn btn-secondary" style="font-size: 0.8rem; padding: 4px 8px;" onclick="quickChat('When should I file my taxes?')">📅 Filing deadlines</button>
                    <button class="btn btn-secondary" style="font-size: 0.8rem; padding: 4px 8px;" onclick="quickChat('What deductions can I claim?')">💰 Deductions</button>
                    <button class="btn btn-secondary" style="font-size: 0.8rem; padding: 4px 8px;" id="docQuestionBtn" onclick="quickChat('Tell me about my document')" style="display: none;">📋 My Document</button>
                </div>
            </div>
        </div>
        
        <div class="tab-content" id="subscriptions-tab">
            <h3>💎 Subscription Plans</h3>
            <div class="pricing-grid">
                <div class="pricing-card free">
                    <h4>Free</h4>
                    <div class="price">$0<span>/month</span></div>
                    <ul>
                        <li>✅ 20 documents per month</li>
                        <li>✅ Basic AI extraction</li>
                        <li>✅ CSV export</li>
                        <li>✅ Email support</li>
                        <li>❌ AI insights</li>
                        <li>❌ Priority support</li>
                    </ul>
                    <button class="plan-btn current">Current Plan</button>
                </div>
                <div class="pricing-card starter">
                    <h4>Starter</h4>
                    <div class="price">$29<span>/month</span></div>
                    <ul>
                        <li>✅ 100 documents per month</li>
                        <li>✅ Advanced AI extraction</li>
                        <li>✅ Multiple export formats</li>
                        <li>✅ AI insights & sentiment</li>
                        <li>✅ Priority support</li>
                        <li>✅ API access</li>
                    </ul>
                    <button class="plan-btn" onclick="upgradePlan('starter')">Upgrade Now</button>
                </div>
                <div class="pricing-card professional popular">
                    <h4>Professional</h4>
                    <div class="price">$79<span>/month</span></div>
                    <ul>
                        <li>✅ 500 documents per month</li>
                        <li>✅ Premium AI insights</li>
                        <li>✅ Batch processing</li>
                        <li>✅ Custom integrations</li>
                        <li>✅ Advanced analytics</li>
                        <li>✅ Phone support</li>
                        <li>✅ White-label options</li>
                    </ul>
                    <button class="plan-btn" onclick="upgradePlan('professional')">Most Popular</button>
                </div>
                <div class="pricing-card enterprise">
                    <h4>Enterprise</h4>
                    <div class="price">$199<span>/month</span></div>
                    <ul>
                        <li>✅ Unlimited documents</li>
                        <li>✅ Custom AI models</li>
                        <li>✅ Dedicated infrastructure</li>
                        <li>✅ 24/7 dedicated support</li>
                        <li>✅ SLA guarantee (99.9%)</li>
                        <li>✅ On-premise deployment</li>
                        <li>✅ Custom training</li>
                    </ul>
                    <button class="plan-btn" onclick="upgradePlan('enterprise')">Contact Sales</button>
                </div>
            </div>
            <div class="usage-summary">
                <h4>📈 Current Usage</h4>
                <div class="usage-bar">
                    <div class="usage-fill" id="usageBar" style="width: 0%"></div>
                </div>
                <p id="usageText">0 of 20 documents used this month</p>
                <div style="margin-top: 15px; font-size: 0.9rem; color: #666;">
                    <p>💡 <strong>Why upgrade?</strong></p>
                    <ul style="margin: 10px 0; padding-left: 20px;">
                        <li>Process more documents without limits</li>
                        <li>Get AI-powered insights and recommendations</li>
                        <li>Access advanced features like batch processing</li>
                        <li>Priority support for faster issue resolution</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Configuration - Real API endpoints
        const API_BASE = 'https://iljpaj6ogl.execute-api.us-east-1.amazonaws.com/prod';
        
        // State management
        let currentUser = null;
        let userTier = 'free';
        let monthlyUsage = 0;
        let selectedFile = null;
        let processedDocuments = [];
        let currentDocumentId = null;
        let currentExtractionData = null;
        let isEditMode = false;
        let editedData = {};
        let isBlocked = false;
        let batchResults = [];
        let allExports = [];
        
        // Subscription tiers
        const TIERS = {
            free: { limit: 20, price: 0, name: 'Free' },
            starter: { limit: 100, price: 29, name: 'Starter' },
            professional: { limit: 500, price: 79, name: 'Professional' },
            enterprise: { limit: -1, price: 199, name: 'Enterprise' }
        };
        
        // Initialize app
        document.addEventListener('DOMContentLoaded', function() {
            setupEventListeners();
            loadUserData();
            updateAnalytics();
        });
        
        function setupEventListeners() {
            const fileInput = document.getElementById('fileInput');
            const uploadArea = document.querySelector('.upload-area');
            const processBtn = document.getElementById('processBtn');
            const chatInput = document.getElementById('chatInput');
            
            fileInput.addEventListener('change', handleFileSelect);
            document.getElementById('batchInput').addEventListener('change', handleBatchSelect);
            processBtn.addEventListener('click', processDocument);
            chatInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') sendMessage();
            });
            
            // Drag and drop
            uploadArea.addEventListener('dragover', (e) => {
                e.preventDefault();
                uploadArea.classList.add('dragover');
            });
            
            uploadArea.addEventListener('dragleave', () => {
                uploadArea.classList.remove('dragover');
            });
            
            uploadArea.addEventListener('drop', (e) => {
                e.preventDefault();
                uploadArea.classList.remove('dragover');
                const files = e.dataTransfer.files;
                if (files.length > 0) {
                    fileInput.files = files;
                    handleFileSelect();
                }
            });
        }
        
        function loadUserData() {
            const saved = localStorage.getItem('taxdocMVP2User');
            if (saved) {
                currentUser = JSON.parse(saved);
                updateAuthUI();
            }
            
            const savedUsage = localStorage.getItem('taxdocMVP2Usage');
            if (savedUsage) {
                const usage = JSON.parse(savedUsage);
                monthlyUsage = usage.count || 0;
                processedDocuments = usage.documents || [];
            }
        }
        
        function saveUserData() {
            if (currentUser) {
                localStorage.setItem('taxdocMVP2User', JSON.stringify(currentUser));
            }
            localStorage.setItem('taxdocMVP2Usage', JSON.stringify({
                count: monthlyUsage,
                documents: processedDocuments
            }));
        }
        
        function handleFileSelect() {
            const file = document.getElementById('fileInput').files[0];
            if (file) {
                selectedFile = file;
                document.getElementById('processBtn').textContent = `Process ${file.name}`;
                document.getElementById('processBtn').disabled = false;
                
                // Store image data for preview
                if (file.type.startsWith('image/')) {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        selectedFile.imageData = e.target.result;
                    };
                    reader.readAsDataURL(file);
                    showFilePreview(file);
                }
                
                hideResults();
                hideError();
            }
        }
        
        function showFilePreview(file) {
            const preview = document.getElementById('filePreview');
            const img = document.getElementById('previewImage');
            const info = document.getElementById('fileInfo');
            
            const reader = new FileReader();
            reader.onload = (e) => {
                img.src = e.target.result;
                info.innerHTML = `
                    <strong>${file.name}</strong><br>
                    Size: ${(file.size / 1024 / 1024).toFixed(2)} MB<br>
                    Type: ${file.type}
                `;
                preview.style.display = 'block';
            };
            reader.readAsDataURL(file);
        }
        
        async function processDocument() {
            if (!selectedFile) return;
            
            // Check usage limits
            const tierLimit = TIERS[userTier]?.limit || 20;
            if (tierLimit > 0 && monthlyUsage >= tierLimit) {
                if (!currentUser) {
                    showUsageWarning();
                    return;
                }
                showError(`Monthly limit reached (${monthlyUsage}/${tierLimit}). Upgrade your plan to continue.`);
                return;
            }
            
            showLoading();
            hideResults();
            hideError();
            
            try {
                // Handle batch upload (FileList) vs single file
                if (selectedFile.length) {
                    // Batch processing
                    await processBatchFiles(selectedFile);
                } else {
                    // Single file processing
                    await processSingleFile(selectedFile);
                }
                
            } catch (err) {
                showError(`Processing failed: ${err.message}`);
                hideLoading();
            }
        }
        
        async function processSingleFile(file) {
            const base64 = await fileToBase64(file);
            
            const response = await fetch(`${API_BASE}/process-document`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    filename: file.name,
                    file_content: base64
                })
            });
            
            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(errorData.error || `HTTP ${response.status}`);
            }
            
            const uploadResult = await response.json();
            
            // Poll for results
            const documentId = uploadResult.document_id;
            let attempts = 0;
            const maxAttempts = 30;
            
            const pollForResults = async () => {
                try {
                    const resultResponse = await fetch(`${API_BASE}/result/${documentId}`);
                    const resultData = await resultResponse.json();
                    
                    if (resultData.status === 'completed' && resultData.data) {
                        currentDocumentId = documentId;
                        currentExtractionData = resultData;
                        showResults(resultData);
                        monthlyUsage++;
                        processedDocuments.push({
                            filename: file.name,
                            timestamp: new Date().toISOString(),
                            documentType: resultData.document_type || resultData.data?.document_type || 'Document',
                            confidence: calculateAverageConfidence(resultData.data),
                            documentId: documentId,
                            extractedData: resultData,
                            imageData: selectedFile.imageData || null
                        });
                        saveUserData();
                        updateAnalytics();
                        return;
                    }
                    
                    if (resultData.status === 'failed') {
                        throw new Error('Document processing failed');
                    }
                    
                    attempts++;
                    if (attempts < maxAttempts) {
                        setTimeout(pollForResults, 1000);
                    } else {
                        throw new Error('Processing timeout - please try again');
                    }
                    
                } catch (pollError) {
                    showError(`Processing failed: ${pollError.message}`);
                    hideLoading();
                }
            };
            
            setTimeout(pollForResults, 2000);
        }
        
        async function processBatchFiles(fileList) {
            const files = Array.from(fileList);
            batchResults = [];
            
            showNotification(`Processing ${files.length} files...`);
            showBatchProgress(files);
            
            for (let i = 0; i < files.length; i++) {
                const file = files[i];
                const result = {
                    filename: file.name,
                    status: 'processing',
                    timestamp: new Date().toISOString(),
                    error: null,
                    documentId: null,
                    extractedData: null
                };
                
                batchResults.push(result);
                updateBatchProgress(i, 'processing');
                
                try {
                    const documentId = await processSingleFileForBatch(file);
                    result.status = 'completed';
                    result.documentId = documentId;
                    updateBatchProgress(i, 'completed');
                } catch (error) {
                    result.status = 'failed';
                    result.error = error.message;
                    updateBatchProgress(i, 'failed');
                }
            }
            
            hideLoading();
            showBatchResults();
            const completed = batchResults.filter(r => r.status === 'completed').length;
            const failed = batchResults.filter(r => r.status === 'failed').length;
            showNotification(`Batch complete: ${completed} processed, ${failed} failed`);
        }
        
        async function processSingleFileForBatch(file) {
            const base64 = await fileToBase64(file);
            
            const response = await fetch(`${API_BASE}/process-document`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    filename: file.name,
                    file_content: base64
                })
            });
            
            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(errorData.error || `HTTP ${response.status}`);
            }
            
            const uploadResult = await response.json();
            const documentId = uploadResult.document_id;
            
            // Wait for processing
            let attempts = 0;
            const maxAttempts = 30;
            
            while (attempts < maxAttempts) {
                await new Promise(resolve => setTimeout(resolve, 1000));
                
                const resultResponse = await fetch(`${API_BASE}/result/${documentId}`);
                const resultData = await resultResponse.json();
                
                if (resultData.status === 'completed' && resultData.data) {
                    monthlyUsage++;
                    processedDocuments.push({
                        filename: file.name,
                        timestamp: new Date().toISOString(),
                        documentType: resultData.document_type || resultData.data?.document_type || 'Document',
                        confidence: calculateAverageConfidence(resultData.data),
                        documentId: documentId,
                        extractedData: resultData,
                        imageData: file.imageData || null
                    });
                    saveUserData();
                    return documentId;
                }
                
                if (resultData.status === 'failed') {
                    throw new Error('Document processing failed');
                }
                
                attempts++;
            }
            
            throw new Error('Processing timeout');
        }
        
        function showBatchProgress(files) {
            const progressDiv = document.createElement('div');
            progressDiv.id = 'batchProgress';
            progressDiv.innerHTML = `
                <h4>Batch Processing Progress</h4>
                <div id="batchProgressList"></div>
            `;
            progressDiv.style.cssText = 'background: #f7fafc; padding: 20px; border-radius: 8px; margin: 20px 0;';
            
            const list = progressDiv.querySelector('#batchProgressList');
            files.forEach((file, index) => {
                const item = document.createElement('div');
                item.id = `batch-item-${index}`;
                item.innerHTML = `
                    <span>${file.name}</span>
                    <span id="batch-status-${index}" style="float: right; color: #666;">⏳ Waiting...</span>
                `;
                item.style.cssText = 'padding: 8px; border-bottom: 1px solid #e2e8f0;';
                list.appendChild(item);
            });
            
            document.getElementById('results').appendChild(progressDiv);
            document.getElementById('results').style.display = 'block';
        }
        
        function updateBatchProgress(index, status) {
            const statusEl = document.getElementById(`batch-status-${index}`);
            if (statusEl) {
                switch (status) {
                    case 'processing':
                        statusEl.innerHTML = '🔄 Processing...';
                        statusEl.style.color = '#667eea';
                        break;
                    case 'completed':
                        statusEl.innerHTML = '✅ Completed';
                        statusEl.style.color = '#48bb78';
                        break;
                    case 'failed':
                        statusEl.innerHTML = '❌ Failed';
                        statusEl.style.color = '#e53e3e';
                        break;
                }
            }
        }
        
        function showBatchResults() {
            const resultsDiv = document.createElement('div');
            resultsDiv.innerHTML = `
                <h4>Batch Results</h4>
                <div class="batch-results-grid" style="display: grid; gap: 10px; margin-top: 15px;">
                    ${batchResults.map((result, index) => `
                        <div class="batch-result-item" style="background: white; padding: 15px; border-radius: 8px; border-left: 4px solid ${result.status === 'completed' ? '#48bb78' : '#e53e3e'};">
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <div>
                                    <strong>${result.filename}</strong>
                                    <div style="font-size: 0.9rem; color: #666; margin-top: 4px;">
                                        ${result.status === 'completed' ? '✅ Successfully processed' : '❌ ' + result.error}
                                    </div>
                                </div>
                                <div style="display: flex; gap: 5px;">
                                    ${result.status === 'completed' ? `
                                        <button class="btn btn-primary" onclick="viewBatchResult('${result.documentId}', '${result.filename}')" style="font-size: 0.9rem;">👁️ View</button>
                                        <button class="btn btn-secondary" onclick="downloadBatchResult('${result.documentId}', '${result.filename}')" style="font-size: 0.9rem;">📊 Excel</button>
                                        <button class="btn btn-secondary" onclick="downloadBatchCSV('${result.documentId}', '${result.filename}')" style="font-size: 0.9rem;">📋 CSV</button>
                                    ` : ''}
                                </div>
                            </div>
                        </div>
                    `).join('')}
                </div>
            `;
            
            const progressDiv = document.getElementById('batchProgress');
            if (progressDiv) {
                progressDiv.replaceWith(resultsDiv);
            }
        }
        
        async function viewBatchResult(documentId, filename) {
            try {
                const response = await fetch(`${API_BASE}/result/${documentId}`);
                const resultData = await response.json();
                
                if (resultData.data) {
                    // Set current data for viewing
                    currentDocumentId = documentId;
                    currentExtractionData = resultData;
                    
                    // Create a temporary selected file object
                    selectedFile = { name: filename };
                    
                    // Show results in the main results area
                    showResults(resultData);
                    
                    // Scroll to results
                    document.getElementById('results').scrollIntoView({ behavior: 'smooth' });
                } else {
                    showNotification('No extraction data available for this document.');
                }
            } catch (error) {
                showNotification('Failed to load document results: ' + error.message);
            }
        }
        
        async function downloadBatchResult(documentId, filename) {
            try {
                const response = await fetch(`${API_BASE}/download-excel/${documentId}`);
                if (response.ok) {
                    const blob = await response.blob();
                    downloadBlob(blob, `${filename.split('.')[0]}_extracted_data.xlsx`);
                    addToExports('Excel', `${filename.split('.')[0]}_extracted_data.xlsx`, documentId);
                } else {
                    throw new Error('Excel download failed');
                }
            } catch (error) {
                showNotification('Excel download failed, trying CSV...');
                downloadBatchCSV(documentId, filename);
            }
        }
        
        async function downloadBatchCSV(documentId, filename) {
            try {
                const response = await fetch(`${API_BASE}/result/${documentId}`);
                const resultData = await response.json();
                
                if (resultData.data) {
                    const csvContent = generateCSV(resultData.data);
                    const blob = new Blob([csvContent], { type: 'text/csv' });
                    downloadBlob(blob, `${filename.split('.')[0]}_extracted_data.csv`);
                    addToExports('CSV', `${filename.split('.')[0]}_extracted_data.csv`, documentId);
                }
            } catch (error) {
                showNotification('CSV download failed: ' + error.message);
            }
        }
        
        function downloadBlob(blob, filename) {
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);
        }
        
        function generateCSV(data) {
            let csvContent = 'Field,Value\n';
            Object.entries(data).forEach(([key, value]) => {
                if (['confidence_scores', 'layers_used', 'extraction_method'].includes(key)) return;
                const cleanValue = String(value).replace(/"/g, '""');
                csvContent += `"${formatFieldName(key)}","${cleanValue}"\n`;
            });
            return csvContent;
        }
        
        function showResults(result) {
            const formType = document.getElementById('formType');
            const fieldGrid = document.getElementById('fieldGrid');
            
            const docType = result.document_type || 'Document';
            const fieldCount = Object.keys(result.data || {}).length;
            
            formType.textContent = `${docType} - ${fieldCount} fields extracted ✨`;
            fieldGrid.innerHTML = '';
            
            // Show AI insights if available
            if (result.ai_insights) {
                displayAIInsights(result.ai_insights);
            }
            
            // Show sentiment analysis if available
            if (result.sentiment_analysis) {
                displaySentimentAnalysis(result.sentiment_analysis);
            }
            
            // Display extracted fields
            const data = result.data || {};
            Object.entries(data).forEach(([key, value]) => {
                if (['confidence_scores', 'layers_used', 'extraction_method'].includes(key)) return;
                
                const fieldItem = document.createElement('div');
                fieldItem.className = 'field-item';
                fieldItem.setAttribute('data-field', key);
                
                const confidence = result.confidence_scores?.[key] || 0.95;
                
                fieldItem.innerHTML = `
                    <div class="field-content">
                        <div class="field-label">${formatFieldName(key)}</div>
                        <div class="field-value">${formatFieldValue(key, value)}</div>
                        <input type="text" class="field-input" value="${value}" data-field="${key}" />
                    </div>
                    <div class="field-meta">
                        <div class="confidence-badge ${getConfidenceClass(confidence)}">
                            ${Math.round(confidence * 100)}%
                        </div>
                        <div class="source-icon">🔍</div>
                    </div>
                `;
                
                fieldGrid.appendChild(fieldItem);
            });
            
            // Show success message
            const successDiv = document.createElement('div');
            successDiv.className = 'success-message';
            const avgConf = calculateAverageConfidence(data);
            successDiv.textContent = `🎉 Document processed successfully with ${Math.round(avgConf * 100)}% average confidence!`;
            fieldGrid.prepend(successDiv);
            
            // Show download actions and save button
            document.getElementById('downloadActions').style.display = 'block';
            
            // Show document-specific chat button
            document.getElementById('docQuestionBtn').style.display = 'inline-block';
            
            // Add save changes button
            const saveBtn = document.createElement('button');
            saveBtn.className = 'save-changes';
            saveBtn.textContent = '💾 Save Changes';
            saveBtn.onclick = saveEditedData;
            fieldGrid.appendChild(saveBtn);
            
            document.getElementById('results').style.display = 'block';
            hideLoading();
        }
        
        function displayAIInsights(insights) {
            const insightsDiv = document.createElement('div');
            insightsDiv.className = 'ai-insights';
            insightsDiv.innerHTML = `
                <h4 style="margin: 0 0 15px 0;">🤖 AI Insights</h4>
                <p style="margin: 0; line-height: 1.5;">${insights.summary || 'AI analysis completed successfully.'}</p>
            `;
            document.getElementById('fieldGrid').appendChild(insightsDiv);
        }
        
        function displaySentimentAnalysis(sentiment) {
            const sentimentDiv = document.createElement('div');
            sentimentDiv.className = 'sentiment-analysis';
            const overall = sentiment.overall_sentiment || 'neutral';
            const emoji = overall === 'positive' ? '😊' : overall === 'negative' ? '😞' : '😐';
            
            sentimentDiv.innerHTML = `
                <h4 style="margin: 0 0 15px 0;">😊 Sentiment Analysis</h4>
                <p style="margin: 0; line-height: 1.5;">
                    Overall sentiment: ${overall.charAt(0).toUpperCase() + overall.slice(1)} ${emoji}
                    ${sentiment.user_experience_score ? `(Score: ${sentiment.user_experience_score}/1.0)` : ''}
                </p>
            `;
            document.getElementById('fieldGrid').appendChild(sentimentDiv);
        }
        
        async function sendMessage() {
            const input = document.getElementById('chatInput');
            const message = input.value.trim();
            if (!message) return;
            
            addChatMessage(message, 'user');
            input.value = '';
            
            const sendBtn = document.getElementById('sendBtn');
            sendBtn.disabled = true;
            sendBtn.textContent = '⏳';
            
            const loadingId = addChatMessage('🤔 Thinking...', 'bot', true);
            
            try {
                // Prepare context for Claude
                let context = '';
                if (currentExtractionData) {
                    const data = getCurrentData();
                    context = `Document Context: ${currentExtractionData.document_type || 'Unknown document'}\n`;
                    context += `Extracted Data: ${JSON.stringify(data, null, 2)}\n`;
                    context += `Confidence Scores: ${JSON.stringify(currentExtractionData.confidence_scores || {}, null, 2)}\n`;
                }
                
                // Try the enhanced chatbot endpoint with Claude
                let response = await fetch(`${API_BASE}/enhanced-chat`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        message: message,
                        context: context,
                        document_id: currentDocumentId,
                        document_type: currentExtractionData?.document_type
                    })
                });
                
                let result;
                if (response.ok) {
                    result = await response.json();
                } else {
                    // Fallback to local processing
                    result = await handleGeneralQuestions(message);
                }
                
                document.getElementById(loadingId).remove();
                
                if (result && (result.response || result.answer || result.message)) {
                    const botMessage = result.response || result.answer || result.message;
                    addChatMessage(botMessage, 'bot');
                } else {
                    const fallbackResponse = getFallbackResponse(message);
                    addChatMessage(fallbackResponse, 'bot');
                }
                
            } catch (error) {
                document.getElementById(loadingId).remove();
                // Try local processing as fallback
                const localResult = await handleGeneralQuestions(message);
                if (localResult) {
                    addChatMessage(localResult.response, 'bot');
                } else {
                    const fallbackResponse = getFallbackResponse(message);
                    addChatMessage(fallbackResponse, 'bot');
                }
            } finally {
                sendBtn.disabled = false;
                sendBtn.textContent = '📤';
            }
        }
        
        async function handleGeneralQuestions(message) {
            const lowerMessage = message.toLowerCase();
            
            // Tax form questions
            if (lowerMessage.includes('w-2') || lowerMessage.includes('w2')) {
                return {
                    response: "📄 **W-2 Form (Wage and Tax Statement)**\n\nA W-2 is a tax document that shows:\n• Your annual wages and salary\n• Federal, state, and local taxes withheld\n• Social Security and Medicare taxes paid\n• Other deductions (401k, health insurance, etc.)\n\n**Key boxes:**\n• Box 1: Wages, tips, other compensation\n• Box 2: Federal income tax withheld\n• Box 3: Social Security wages\n• Box 4: Social Security tax withheld\n\n💡 You'll receive a W-2 from each employer by January 31st for the previous tax year."
                };
            }
            
            if (lowerMessage.includes('1099') && !lowerMessage.includes('w-2')) {
                return {
                    response: "📄 **1099 Forms (Various Types)**\n\n1099 forms report various types of income:\n\n**Common types:**\n• **1099-NEC**: Non-employee compensation (freelance work)\n• **1099-INT**: Interest income from banks\n• **1099-DIV**: Dividend income from investments\n• **1099-MISC**: Miscellaneous income\n• **1099-R**: Retirement distributions\n\n**Key difference from W-2:**\n• No taxes are typically withheld\n• You may need to pay estimated taxes\n• Often requires Schedule C for business income\n\n💡 You'll receive 1099s by January 31st if you earned $600+ from a source."
                };
            }
            
            if (lowerMessage.includes('deduction') || lowerMessage.includes('write off')) {
                return {
                    response: "💰 **Tax Deductions**\n\nDeductions reduce your taxable income:\n\n**Standard vs. Itemized:**\n• Standard: $13,850 (single) / $27,700 (married) for 2023\n• Itemized: List specific expenses if they exceed standard\n\n**Common deductions:**\n• Mortgage interest\n• State and local taxes (up to $10,000)\n• Charitable donations\n• Medical expenses (over 7.5% of income)\n• Business expenses (if self-employed)\n\n**Business deductions:**\n• Home office expenses\n• Business meals (50%)\n• Travel expenses\n• Equipment and supplies\n\n💡 Keep receipts and records for all deductions!"
                };
            }
            
            if (lowerMessage.includes('deadline') || lowerMessage.includes('when') && lowerMessage.includes('file')) {
                return {
                    response: "📅 **Tax Filing Deadlines**\n\n**Individual Returns (Form 1040):**\n• **April 15, 2024** for 2023 tax year\n• Can request 6-month extension to October 15\n• Extension is for filing, not payment!\n\n**Quarterly Estimated Taxes:**\n• Q1: April 15\n• Q2: June 15\n• Q3: September 15\n• Q4: January 15 (next year)\n\n**Business Returns:**\n• Partnerships/S-Corps: March 15\n• C-Corporations: April 15\n\n**Important documents needed:**\n• W-2s and 1099s (received by January 31)\n• Previous year's tax return\n• Receipts for deductions\n\n⚠️ File even if you can't pay - penalties are higher for not filing!"
                };
            }
            
            if (lowerMessage.includes('refund') || lowerMessage.includes('owe')) {
                return {
                    response: "💵 **Tax Refunds vs. Owing**\n\n**You get a refund when:**\n• More tax was withheld than you actually owe\n• You qualify for refundable credits (Earned Income Credit, Child Tax Credit)\n• You made estimated tax payments that exceed your liability\n\n**You owe money when:**\n• Not enough tax was withheld from paychecks\n• You have self-employment income\n• You received income with no withholding (1099s)\n• You took early retirement distributions\n\n**How to avoid owing:**\n• Adjust W-4 withholding at work\n• Make quarterly estimated payments\n• Consider tax-advantaged accounts (401k, IRA)\n\n💡 Aim to break even - large refunds mean you gave the government an interest-free loan!"
                };
            }
            
            if (lowerMessage.includes('self employed') || lowerMessage.includes('freelance') || lowerMessage.includes('contractor')) {
                return {
                    response: "👨‍💼 **Self-Employment Taxes**\n\n**What you need to know:**\n• Pay both employee and employer portion of Social Security/Medicare (15.3%)\n• File Schedule C for business income/expenses\n• Make quarterly estimated tax payments\n• Can deduct business expenses\n\n**Required forms:**\n• Schedule C: Profit or Loss from Business\n• Schedule SE: Self-Employment Tax\n• Form 1040: Individual Income Tax Return\n\n**Quarterly payment dates:**\n• April 15, June 15, September 15, January 15\n\n**Deductible business expenses:**\n• Home office (if used exclusively for business)\n• Business equipment and supplies\n• Professional development and training\n• Business meals (50%)\n• Business travel\n\n💡 Keep detailed records and separate business/personal expenses!"
                };
            }
            
            // Return null to try Claude API for other questions
            return null;
        }
        
        function handleDocumentQuestions(message, lowerMessage) {
            const data = getCurrentData();
            const docType = currentExtractionData.document_type || 'document';
            
            if (lowerMessage.includes('total') || lowerMessage.includes('amount')) {
                const amounts = Object.entries(data).filter(([key, value]) => 
                    (key.includes('wage') || key.includes('income') || key.includes('compensation') || key.includes('total')) && 
                    typeof value === 'number'
                );
                
                if (amounts.length > 0) {
                    const amountList = amounts.map(([key, value]) => 
                        `• ${formatFieldName(key)}: ${formatFieldValue(key, value)}`
                    ).join('\n');
                    return {
                        response: `💰 Here are the amounts from your ${docType}:\n\n${amountList}\n\n${getDocumentInsights(docType, data)}`
                    };
                }
            }
            
            if (lowerMessage.includes('tax') && (lowerMessage.includes('withheld') || lowerMessage.includes('paid'))) {
                const taxes = Object.entries(data).filter(([key, value]) => 
                    key.includes('tax') && typeof value === 'number'
                );
                
                if (taxes.length > 0) {
                    const taxList = taxes.map(([key, value]) => 
                        `• ${formatFieldName(key)}: ${formatFieldValue(key, value)}`
                    ).join('\n');
                    return {
                        response: `🏛️ Tax information from your ${docType}:\n\n${taxList}\n\n💡 This shows taxes already withheld from your income. You may get a refund if too much was withheld!`
                    };
                }
            }
            
            if (lowerMessage.includes('employer') || lowerMessage.includes('company')) {
                const employer = data.employer_name || data.payer_name || data.company_name;
                if (employer) {
                    return {
                        response: `🏢 Your ${docType} is from: ${employer}\n\n📋 Make sure this matches your records and that you have all documents from this employer for the tax year.`
                    };
                }
            }
            
            // General document summary
            const fieldCount = Object.keys(data).filter(key => 
                !['confidence_scores', 'layers_used', 'extraction_method'].includes(key)
            ).length;
            
            return {
                response: `📄 Your ${docType} Summary:\n\n• Document Type: ${docType}\n• Fields Extracted: ${fieldCount}\n• Processing Confidence: ${Math.round(calculateAverageConfidence(data) * 100)}%\n\n💬 Ask me specific questions like:\n• "What's my total income?"\n• "How much tax was withheld?"\n• "Who is my employer?"`
            };
        }
        
        function getDocumentInsights(docType, data) {
            if (docType.includes('W-2')) {
                return "💡 W-2 Tip: Compare Box 1 (wages) vs Box 2 (federal tax withheld) to estimate your refund or balance due.";
            }
            if (docType.includes('1099')) {
                return "💡 1099 Tip: This is income where taxes weren't withheld. You may need to pay estimated taxes or owe at filing.";
            }
            if (docType.includes('bank')) {
                return "💡 Bank Statement Tip: Use this to track deductible expenses and verify income reported on tax forms.";
            }
            return "💡 Keep this document with your tax records for at least 3 years after filing.";
        }
        
        function getFallbackResponse(message) {
            return "I'm having trouble connecting to my AI brain right now. Please try again in a moment.";
        }
        
        function quickChat(message) {
            document.getElementById('chatInput').value = message;
            sendMessage();
        }
        
        function addChatMessage(message, sender, isLoading = false) {
            const container = document.getElementById('chatMessages');
            
            // Clear welcome message
            if (container.children.length === 1 && container.children[0].style.textAlign === 'center') {
                container.innerHTML = '';
            }
            
            const messageDiv = document.createElement('div');
            const messageId = 'msg-' + Date.now();
            messageDiv.id = messageId;
            messageDiv.className = `message ${sender}`;
            
            const bubble = document.createElement('div');
            bubble.className = 'message-bubble';
            bubble.textContent = message;
            
            messageDiv.appendChild(bubble);
            container.appendChild(messageDiv);
            container.scrollTop = container.scrollHeight;
            
            return messageId;
        }
        
        function calculateAverageConfidence(data) {
            const values = Object.values(data).filter(v => typeof v === 'number' && v <= 1);
            return values.length > 0 ? values.reduce((sum, val) => sum + val, 0) / values.length : 0.95;
        }
        
        function updateAnalytics() {
            document.getElementById('totalDocs').textContent = monthlyUsage;
            
            const avgConf = processedDocuments.length > 0 
                ? Math.round(processedDocuments.reduce((sum, doc) => sum + doc.confidence, 0) / processedDocuments.length * 100)
                : 95;
            document.getElementById('avgConfidence').textContent = avgConf + '%';
            
            document.getElementById('userTierDisplay').textContent = userTier === 'premium' ? 'Premium' : 'Free';
            document.getElementById('monthlyUsage').textContent = 
                userTier === 'premium' ? 'Unlimited' : `${monthlyUsage}/20`;
        }
        
        function updateAuthUI() {
            const authButtons = document.getElementById('authButtons');
            const userActions = document.getElementById('userActions');
            const userInfo = document.getElementById('userInfo');
            const userName = document.getElementById('userName');
            const userTierEl = document.getElementById('userTier');
            
            if (currentUser) {
                authButtons.style.display = 'none';
                userActions.style.display = 'flex';
                userInfo.style.display = 'flex';
                userName.textContent = `👋 ${currentUser.name}`;
                userTierEl.textContent = currentUser.tier === 'premium' ? '💎 Premium' : '🆓 Free';
                userTierEl.className = `tier-badge tier-${currentUser.tier}`;
                userTier = currentUser.tier;
                
                document.getElementById('upgradeBtn').style.display = 
                    currentUser.tier === 'premium' ? 'none' : 'block';
            } else {
                authButtons.style.display = 'flex';
                userActions.style.display = 'none';
                userInfo.style.display = 'none';
            }
            
            updateAnalytics();
        }
        
        // Mock authentication for demo
        function showAuthModal(mode) {
            const email = prompt(`Enter email for ${mode}:`);
            if (email) {
                currentUser = {
                    email: email,
                    name: email.split('@')[0],
                    tier: 'free'
                };
                updateAuthUI();
                saveUserData();
                alert(`🎉 Welcome ${currentUser.name}! You're signed in with a Free account.`);
            }
        }
        
        function showPaymentModal() {
            if (confirm('Upgrade to Premium for $29/month?\n\n✅ Unlimited documents\n✅ AI insights\n✅ Priority support')) {
                if (currentUser) {
                    currentUser.tier = 'premium';
                    userTier = 'premium';
                    updateAuthUI();
                    saveUserData();
                    alert('🎉 Upgraded to Premium! You now have unlimited processing.');
                }
            }
        }
        
        function logout() {
            currentUser = null;
            monthlyUsage = 0;
            processedDocuments = [];
            localStorage.removeItem('taxdocMVP2User');
            localStorage.removeItem('taxdocMVP2Usage');
            updateAuthUI();
            alert('👋 Signed out successfully!');
        }
        
        // Utility functions
        function fileToBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = () => resolve(reader.result.split(',')[1]);
                reader.onerror = reject;
            });
        }
        
        function formatFieldName(key) {
            return key.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
        }
        
        function formatFieldValue(key, value) {
            if (key.includes('ssn') && typeof value === 'string' && value.length >= 9) {
                return '***-**-' + value.slice(-4);
            }
            if (typeof value === 'number' && (key.includes('wages') || key.includes('tax') || key.includes('compensation'))) {
                return '$' + value.toLocaleString();
            }
            return value;
        }
        
        function getConfidenceClass(confidence) {
            if (confidence >= 0.9) return 'confidence-high';
            if (confidence >= 0.7) return 'confidence-medium';
            return 'confidence-low';
        }
        
        function switchTab(tabName) {
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            document.getElementById(tabName + '-tab').classList.add('active');
            event.target.classList.add('active');
            
            if (tabName === 'documents') {
                updateDocumentsView();
            } else if (tabName === 'exports') {
                updateExportsView();
            } else if (tabName === 'analytics') {
                updateAnalyticsView();
            } else if (tabName === 'subscriptions') {
                updateSubscriptionsView();
            }
        }
        
        function showLoading() {
            document.getElementById('loading').style.display = 'block';
            document.getElementById('processBtn').disabled = true;
        }
        
        function hideLoading() {
            document.getElementById('loading').style.display = 'none';
            document.getElementById('processBtn').disabled = false;
        }
        
        function showError(message) {
            const error = document.getElementById('error');
            error.textContent = message;
            error.style.display = 'block';
        }
        
        function hideError() {
            document.getElementById('error').style.display = 'none';
        }
        
        function handleBatchSelect() {
            const files = document.getElementById('batchInput').files;
            if (files.length > 0) {
                const batchPreview = document.getElementById('batchPreview');
                const fileList = document.getElementById('batchFileList');
                
                fileList.innerHTML = '';
                for (let i = 0; i < files.length; i++) {
                    const file = files[i];
                    // Store image data for each file
                    if (file.type.startsWith('image/')) {
                        const reader = new FileReader();
                        reader.onload = (e) => {
                            file.imageData = e.target.result;
                        };
                        reader.readAsDataURL(file);
                    }
                    
                    const fileDiv = document.createElement('div');
                    fileDiv.style.cssText = 'padding: 8px; background: #f7fafc; margin: 5px 0; border-radius: 4px;';
                    fileDiv.textContent = `${i + 1}. ${file.name} (${(file.size / 1024 / 1024).toFixed(2)} MB)`;
                    fileList.appendChild(fileDiv);
                }
                
                batchPreview.style.display = 'block';
                document.getElementById('processBtn').textContent = `Process ${files.length} files`;
                document.getElementById('processBtn').disabled = false;
                selectedFile = files;
                hideResults();
                hideError();
            }
        }
        
        function hideResults() {
            document.getElementById('results').style.display = 'none';
            document.getElementById('downloadActions').style.display = 'none';
            document.getElementById('docQuestionBtn').style.display = 'none';
            document.getElementById('batchPreview').style.display = 'none';
            isEditMode = false;
            editedData = {};
        }
        
        // Download functions
        async function downloadExcel() {
            if (!currentDocumentId) {
                alert('No document processed yet. Please process a document first.');
                return;
            }
            
            try {
                const response = await fetch(`${API_BASE}/download-excel/${currentDocumentId}`);
                
                if (response.ok) {
                    const blob = await response.blob();
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `${selectedFile.name.split('.')[0]}_extracted_data.xlsx`;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    window.URL.revokeObjectURL(url);
                    
                    // Show success message
                    const successDiv = document.createElement('div');
                    successDiv.className = 'success-message';
                    successDiv.textContent = '📊 Excel file downloaded successfully!';
                    successDiv.style.position = 'fixed';
                    successDiv.style.top = '20px';
                    successDiv.style.right = '20px';
                    successDiv.style.zIndex = '1000';
                    document.body.appendChild(successDiv);
                    
                    setTimeout(() => {
                        document.body.removeChild(successDiv);
                    }, 3000);
                } else {
                    throw new Error('Excel download not available');
                }
            } catch (error) {
                // Fallback: create Excel from current data
                downloadExcelFallback();
            }
        }
        
        function downloadExcelFallback() {
            if (!currentExtractionData) {
                alert('No extraction data available.');
                return;
            }
            
            // Create CSV content (Excel alternative)
            const data = currentExtractionData.data;
            let csvContent = 'Field,Value,Confidence\n';
            
            Object.entries(data).forEach(([key, value]) => {
                if (['confidence_scores', 'layers_used', 'extraction_method'].includes(key)) return;
                
                const confidence = currentExtractionData.confidence_scores?.[key] || 0.95;
                const cleanValue = String(value).replace(/,/g, ';'); // Replace commas to avoid CSV issues
                csvContent += `"${formatFieldName(key)}","${cleanValue}","${Math.round(confidence * 100)}%"\n`;
            });
            
            // Download CSV
            const blob = new Blob([csvContent], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `${selectedFile.name.split('.')[0]}_extracted_data.csv`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);
            
            alert('📊 Downloaded as CSV file (Excel alternative)');
        }
        
        function downloadCSV() {
            if (!currentExtractionData) {
                alert('No extraction data available.');
                return;
            }
            
            const data = getCurrentData();
            let csvContent = 'Field,Value\n';
            
            Object.entries(data).forEach(([key, value]) => {
                if (['confidence_scores', 'layers_used', 'extraction_method'].includes(key)) return;
                
                const cleanValue = String(value).replace(/"/g, '""');
                csvContent += `"${formatFieldName(key)}","${cleanValue}"\n`;
            });
            
            const blob = new Blob([csvContent], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `${selectedFile.name.split('.')[0]}_extracted_data.csv`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);
            
            showNotification('📋 CSV file downloaded successfully!');
            addToExports('CSV', `${selectedFile.name.split('.')[0]}_extracted_data.csv`);
        }
        
        function downloadJSON() {
            if (!currentExtractionData) {
                alert('No extraction data available.');
                return;
            }
            
            const jsonData = {
                document_info: {
                    filename: selectedFile.name,
                    document_type: currentExtractionData.document_type,
                    processed_at: new Date().toISOString(),
                    document_id: currentDocumentId,
                    edited: Object.keys(editedData).length > 0
                },
                extracted_data: getCurrentData(),
                original_data: currentExtractionData.data,
                edited_fields: editedData,
                confidence_scores: currentExtractionData.confidence_scores,
                ai_insights: currentExtractionData.ai_insights,
                sentiment_analysis: currentExtractionData.sentiment_analysis
            };
            
            const blob = new Blob([JSON.stringify(jsonData, null, 2)], { type: 'application/json' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `${selectedFile.name.split('.')[0]}_extracted_data.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);
            
            showNotification('📄 JSON file downloaded successfully!');
        }
        
        function toggleEditMode() {
            isEditMode = !isEditMode;
            const fieldGrid = document.getElementById('fieldGrid');
            const editBtn = document.getElementById('editBtn');
            const saveBtn = document.querySelector('.save-changes');
            
            if (isEditMode) {
                fieldGrid.classList.add('edit-mode');
                editBtn.textContent = '❌ Cancel Edit';
                if (saveBtn) saveBtn.style.display = 'block';
            } else {
                fieldGrid.classList.remove('edit-mode');
                editBtn.textContent = '✏️ Edit Data';
                if (saveBtn) saveBtn.style.display = 'none';
                // Reset any unsaved changes
                document.querySelectorAll('.field-input').forEach(input => {
                    const field = input.getAttribute('data-field');
                    const originalValue = currentExtractionData.data[field];
                    input.value = editedData[field] || originalValue;
                });
            }
        }
        
        function saveEditedData() {
            const inputs = document.querySelectorAll('.field-input');
            let hasChanges = false;
            
            inputs.forEach(input => {
                const field = input.getAttribute('data-field');
                const originalValue = currentExtractionData.data[field];
                const newValue = input.value.trim();
                
                if (newValue !== String(originalValue)) {
                    editedData[field] = newValue;
                    hasChanges = true;
                    
                    // Update the display value
                    const fieldItem = input.closest('.field-item');
                    const valueDiv = fieldItem.querySelector('.field-value');
                    valueDiv.textContent = formatFieldValue(field, newValue);
                }
            });
            
            if (hasChanges) {
                showNotification('💾 Changes saved successfully!');
                toggleEditMode();
            } else {
                showNotification('📝 No changes detected.');
            }
        }
        
        function getCurrentData() {
            const data = { ...currentExtractionData.data };
            Object.keys(editedData).forEach(key => {
                data[key] = editedData[key];
            });
            return data;
        }
        
        function showUsageWarning() {
            const warningDiv = document.createElement('div');
            warningDiv.className = 'usage-warning';
            warningDiv.innerHTML = `
                <h3>Monthly Limit Reached</h3>
                <p>You've used all 20 free documents this month. Sign up to continue processing!</p>
                <button class="btn btn-primary" onclick="showAuthModal('register')" style="margin-top: 10px;">Sign Up Now</button>
            `;
            
            const container = document.querySelector('.container');
            container.insertBefore(warningDiv, container.firstChild);
            
            // Disable upload functionality
            document.getElementById('processBtn').disabled = true;
            document.getElementById('fileInput').disabled = true;
            document.getElementById('batchInput').disabled = true;
        }
        
        function updateDocumentsView() {
            const grid = document.getElementById('documentsGrid');
            
            if (processedDocuments.length === 0) {
                grid.innerHTML = `
                    <div style="text-align: center; color: #718096; padding: 40px;">
                        <div style="font-size: 3rem; margin-bottom: 16px;">📄</div>
                        <p>No documents processed yet. Import documents to get started!</p>
                    </div>
                `;
                return;
            }
            
            grid.innerHTML = '';
            processedDocuments.forEach((doc, index) => {
                const fieldCount = doc.extractedData ? Object.keys(doc.extractedData.data || {}).filter(k => !['confidence_scores', 'layers_used', 'extraction_method'].includes(k)).length : 0;
                
                const card = document.createElement('div');
                card.className = 'document-card';
                card.style.cssText = 'display: flex; gap: 15px; align-items: flex-start;';
                
                // Get document preview
                const previewSrc = getDocumentPreview(doc);
                
                card.innerHTML = `
                    <div class="doc-preview" style="flex-shrink: 0;">
                        <img src="${previewSrc}" alt="${doc.filename}" style="width: 120px; height: 150px; object-fit: cover; border-radius: 8px; border: 2px solid #e2e8f0;" onerror="this.src='data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTIwIiBoZWlnaHQ9IjE1MCIgdmlld0JveD0iMCAwIDEyMCAxNTAiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+CjxyZWN0IHdpZHRoPSIxMjAiIGhlaWdodD0iMTUwIiBmaWxsPSIjRjdGQUZDIi8+CjxwYXRoIGQ9Ik00MCA2MEg4MFY2NEg0MFY2MFpNNDAgNzJIODBWNzZINDBWNzJaTTQwIDg0SDgwVjg4SDQwVjg0WiIgZmlsbD0iIzlDQTNBRiIvPgo8cGF0aCBkPSJNNTUgNDBINjVWNTBINTVWNDBaIiBmaWxsPSIjNjY3RUVBIi8+Cjx0ZXh0IHg9IjYwIiB5PSIxMjAiIHRleHQtYW5jaG9yPSJtaWRkbGUiIGZpbGw9IiM5Q0EzQUYiIGZvbnQtc2l6ZT0iMTIiPkRvY3VtZW50PC90ZXh0Pgo8L3N2Zz4K'">
                    </div>
                    <div class="doc-details" style="flex: 1;">
                        <h4 style="margin: 0 0 8px 0; color: #2d3748;">${doc.filename}</h4>
                        <div style="display: grid; gap: 4px; margin-bottom: 15px; font-size: 0.9rem;">
                            <div><strong>Type:</strong> <span style="color: #667eea;">${doc.documentType}</span></div>
                            <div><strong>Fields:</strong> ${fieldCount} extracted</div>
                            <div><strong>Confidence:</strong> <span style="color: ${doc.confidence > 0.9 ? '#48bb78' : doc.confidence > 0.7 ? '#ed8936' : '#e53e3e'};">${Math.round(doc.confidence * 100)}%</span></div>
                            <div><strong>Processed:</strong> ${new Date(doc.timestamp).toLocaleDateString()}</div>
                        </div>
                        <div style="display: flex; gap: 8px; flex-wrap: wrap;">
                            <button class="btn btn-primary" onclick="viewDocumentPopup(${index})" style="font-size: 0.9rem;">👁️ View</button>
                            <button class="btn btn-secondary" onclick="downloadDocJSON('${doc.documentId}', '${doc.filename}')" style="font-size: 0.9rem;">📄 JSON</button>
                        </div>
                    </div>
                `;
                grid.appendChild(card);
            });
        }
        
        function getDocumentPreview(doc) {
            return doc.imageData || 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTIwIiBoZWlnaHQ9IjE1MCIgdmlld0JveD0iMCAwIDEyMCAxNTAiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+CjxyZWN0IHdpZHRoPSIxMjAiIGhlaWdodD0iMTUwIiBmaWxsPSIjRjdGQUZDIi8+CjxwYXRoIGQ9Ik00MCA2MEg4MFY2NEg0MFY2MFpNNDAgNzJIODBWNzZINDBWNzJaTTQwIDg0SDgwVjg4SDQwVjg0WiIgZmlsbD0iIzlDQTNBRiIvPgo8cGF0aCBkPSJNNTUgNDBINjVWNTBINTVWNDBaIiBmaWxsPSIjNjY3RUVBIi8+Cjx0ZXh0IHg9IjYwIiB5PSIxMjAiIHRleHQtYW5jaG9yPSJtaWRkbGUiIGZpbGw9IiM5Q0EzQUYiIGZvbnQtc2l6ZT0iMTIiPkRvY3VtZW50PC90ZXh0Pgo8L3N2Zz4K';
        }
        
        async function downloadDocExcel(documentId, filename) {
            try {
                const response = await fetch(`${API_BASE}/download-excel/${documentId}`);
                if (response.ok) {
                    const blob = await response.blob();
                    downloadBlob(blob, `${filename.split('.')[0]}_extracted_data.xlsx`);
                    addToExports('Excel', `${filename.split('.')[0]}_extracted_data.xlsx`, documentId);
                    showNotification('📊 Excel downloaded successfully!');
                } else {
                    throw new Error('Excel download failed');
                }
            } catch (error) {
                downloadDocCSV(documentId, filename);
            }
        }
        
        async function downloadDocCSV(documentId, filename) {
            try {
                const response = await fetch(`${API_BASE}/result/${documentId}`);
                const resultData = await response.json();
                
                if (resultData.data) {
                    const csvContent = generateCSV(resultData.data);
                    const blob = new Blob([csvContent], { type: 'text/csv' });
                    downloadBlob(blob, `${filename.split('.')[0]}_extracted_data.csv`);
                    addToExports('CSV', `${filename.split('.')[0]}_extracted_data.csv`, documentId);
                    showNotification('📋 CSV downloaded successfully!');
                }
            } catch (error) {
                showNotification('Download failed: ' + error.message);
            }
        }
        
        function viewDocumentPopup(index) {
            const doc = processedDocuments[index];
            showExportModal(doc);
        }
        
        async function downloadDocJSON(documentId, filename) {
            try {
                const response = await fetch(`${API_BASE}/result/${documentId}`);
                const resultData = await response.json();
                
                if (resultData.data) {
                    const jsonData = {
                        document_info: {
                            filename: filename,
                            document_type: resultData.document_type,
                            processed_at: new Date().toISOString(),
                            document_id: documentId
                        },
                        extracted_data: resultData.data,
                        confidence_scores: resultData.confidence_scores,
                        ai_insights: resultData.ai_insights,
                        sentiment_analysis: resultData.sentiment_analysis
                    };
                    
                    const blob = new Blob([JSON.stringify(jsonData, null, 2)], { type: 'application/json' });
                    downloadBlob(blob, `${filename.split('.')[0]}_extracted_data.json`);
                    addToExports('JSON', `${filename.split('.')[0]}_extracted_data.json`, documentId);
                    showNotification('📄 JSON downloaded successfully!');
                }
            } catch (error) {
                showNotification('Download failed: ' + error.message);
            }
        }
        
        function updateExportsView() {
            const list = document.getElementById('exportsList');
            const exports = JSON.parse(localStorage.getItem('taxdocExports') || '[]');
            
            if (exports.length === 0) {
                list.innerHTML = `
                    <div style="text-align: center; color: #718096; padding: 40px;">
                        <div style="font-size: 3rem; margin-bottom: 16px;">📤</div>
                        <p>No exports yet. Process documents to create exports!</p>
                    </div>
                `;
                return;
            }
            
            list.innerHTML = '';
            exports.forEach((exp, index) => {
                const item = document.createElement('div');
                item.className = 'export-item';
                item.innerHTML = `
                    <div style="flex: 1;">
                        <strong>${exp.filename}</strong>
                        <div style="font-size: 0.9rem; color: #666; margin-top: 4px;">
                            ${exp.type} • ${new Date(exp.timestamp).toLocaleString()}
                        </div>
                    </div>
                    <div style="display: flex; gap: 8px;">
                        ${exp.documentId ? `<button class="btn btn-secondary" onclick="viewExportDocument('${exp.documentId}')" style="font-size: 0.9rem;">👁️ View</button>` : ''}
                        <button class="btn btn-secondary" onclick="redownloadExport('${exp.filename}', '${exp.type}')" style="font-size: 0.9rem;">📥 Download</button>
                    </div>
                `;
                list.appendChild(item);
            });
        }
        
        async function viewExportDocument(documentId) {
            try {
                const response = await fetch(`${API_BASE}/result/${documentId}`);
                const resultData = await response.json();
                
                if (resultData.data) {
                    const doc = processedDocuments.find(d => d.documentId === documentId);
                    if (doc) {
                        doc.extractedData = resultData;
                        showExportModal(doc);
                    } else {
                        showExportModal({
                            filename: 'Exported Document',
                            documentType: resultData.document_type || resultData.data?.document_type || 'Document',
                            timestamp: new Date().toISOString(),
                            confidence: calculateAverageConfidence(resultData.data),
                            documentId: documentId,
                            extractedData: resultData,
                            imageData: null
                        });
                    }
                }
            } catch (error) {
                showNotification('Failed to load document: ' + error.message);
            }
        }
        
        function redownloadExport(filename, type) {
            showNotification(`Re-downloading ${filename}...`);
        }
        
        function addToExports(type, filename, documentId = null) {
            const exports = JSON.parse(localStorage.getItem('taxdocExports') || '[]');
            const exportItem = {
                type: type,
                filename: filename,
                timestamp: new Date().toISOString(),
                documentId: documentId
            };
            
            exports.unshift(exportItem);
            allExports = exports.slice(0, 50);
            localStorage.setItem('taxdocExports', JSON.stringify(allExports));
        }
        
        function showPaymentModal() {
            const modal = document.createElement('div');
            modal.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; display: flex; align-items: center; justify-content: center;';
            
            modal.innerHTML = `
                <div style="background: white; padding: 30px; border-radius: 12px; max-width: 600px; width: 90%;">
                    <h2 style="margin: 0 0 20px 0; text-align: center;">Choose Your Plan</h2>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px;">
                        <div class="plan-card" onclick="selectPlan('starter')" style="border: 2px solid #e2e8f0; padding: 20px; border-radius: 8px; text-align: center; cursor: pointer;">
                            <h3>Starter</h3>
                            <div style="font-size: 2rem; font-weight: bold; color: #667eea;">$29</div>
                            <div style="color: #666; margin: 10px 0;">per month</div>
                            <div>100 documents/month</div>
                        </div>
                        <div class="plan-card" onclick="selectPlan('professional')" style="border: 2px solid #e2e8f0; padding: 20px; border-radius: 8px; text-align: center; cursor: pointer;">
                            <h3>Professional</h3>
                            <div style="font-size: 2rem; font-weight: bold; color: #667eea;">$79</div>
                            <div style="color: #666; margin: 10px 0;">per month</div>
                            <div>500 documents/month</div>
                        </div>
                        <div class="plan-card" onclick="selectPlan('enterprise')" style="border: 2px solid #e2e8f0; padding: 20px; border-radius: 8px; text-align: center; cursor: pointer;">
                            <h3>Enterprise</h3>
                            <div style="font-size: 2rem; font-weight: bold; color: #667eea;">$199</div>
                            <div style="color: #666; margin: 10px 0;">per month</div>
                            <div>Unlimited documents</div>
                        </div>
                    </div>
                    <button onclick="closeModal()" style="margin-top: 20px; width: 100%; padding: 10px; background: #e2e8f0; border: none; border-radius: 6px; cursor: pointer;">Cancel</button>
                </div>
            `;
            
            document.body.appendChild(modal);
            window.currentModal = modal;
        }
        
        function selectPlan(plan) {
            if (currentUser) {
                currentUser.tier = plan;
                userTier = plan;
                updateAuthUI();
                saveUserData();
                closeModal();
                alert(`🎉 Upgraded to ${TIERS[plan].name}! You now have ${TIERS[plan].limit === -1 ? 'unlimited' : TIERS[plan].limit} documents per month.`);
            }
        }
        
        function closeModal() {
            if (window.currentModal) {
                document.body.removeChild(window.currentModal);
                window.currentModal = null;
            }
        }
        
        function showExportModal(doc) {
            const modal = document.createElement('div');
            modal.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 1000; display: flex; align-items: center; justify-content: center; overflow-y: auto;';
            
            const extractedData = doc.extractedData?.data || {};
            const fieldCount = Object.keys(extractedData).filter(k => !['confidence_scores', 'layers_used', 'extraction_method'].includes(k)).length;
            const previewSrc = getDocumentPreview(doc);
            
            modal.innerHTML = `
                <div style="background: white; border-radius: 12px; max-width: 1200px; width: 95%; max-height: 95%; overflow: hidden; margin: 20px; display: flex; flex-direction: column;">
                    <div style="display: flex; justify-content: space-between; align-items: center; padding: 20px; border-bottom: 2px solid #e2e8f0;">
                        <div>
                            <h2 style="margin: 0; color: #2d3748;">${doc.filename}</h2>
                            <p style="margin: 5px 0 0 0; color: #666;">${doc.documentType} • ${fieldCount} fields • ${Math.round(doc.confidence * 100)}% confidence</p>
                        </div>
                        <button onclick="closeDocumentModal()" style="background: #e2e8f0; border: none; padding: 8px 12px; border-radius: 6px; cursor: pointer; font-size: 1.2rem;">✕</button>
                    </div>
                    
                    <div style="padding: 20px; display: flex; gap: 20px; flex: 1; overflow: hidden;">
                        <div style="flex: 1; max-width: 400px;">
                            <h3 style="margin: 0 0 15px 0; color: #2d3748;">Document Preview</h3>
                            <div style="background: #f7fafc; border-radius: 8px; padding: 15px; text-align: center;">
                                <img src="${previewSrc}" alt="${doc.filename}" style="max-width: 100%; max-height: 500px; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.1);" onerror="this.src='data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMzAwIiBoZWlnaHQ9IjQwMCIgdmlld0JveD0iMCAwIDMwMCA0MDAiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+CjxyZWN0IHdpZHRoPSIzMDAiIGhlaWdodD0iNDAwIiBmaWxsPSIjRjdGQUZDIiBzdHJva2U9IiNFMkU4RjAiIHN0cm9rZS13aWR0aD0iMiIvPgo8cGF0aCBkPSJNMTAwIDEwMEgyMDBWMTEwSDEwMFYxMDBaTTEwMCAxMzBIMjAwVjE0MEgxMDBWMTMwWk0xMDAgMTYwSDIwMFYxNzBIMTAwVjE2MFpNMTAwIDE5MEgyMDBWMjAwSDEwMFYxOTBaTTEwMCAyMjBIMjAwVjIzMEgxMDBWMjIwWiIgZmlsbD0iIzlDQTNBRiIvPgo8cGF0aCBkPSJNMTM1IDYwSDE2NVY5MEgxMzVWNjBaIiBmaWxsPSIjNjY3RUVBIi8+Cjx0ZXh0IHg9IjE1MCIgeT0iMzIwIiB0ZXh0LWFuY2hvcj0ibWlkZGxlIiBmaWxsPSIjOUNBM0FGIiBmb250LXNpemU9IjE4Ij5Eb2N1bWVudCBQcmV2aWV3PC90ZXh0Pgo8dGV4dCB4PSIxNTAiIHk9IjM0NSIgdGV4dC1hbmNob3I9Im1pZGRsZSIgZmlsbD0iIzlDQTNBRiIgZm9udC1zaXplPSIxNCI+Tm90IEF2YWlsYWJsZTwvdGV4dD4KPHN2Zz4K'">
                            </div>
                            <div style="margin-top: 15px; display: flex; gap: 8px; justify-content: center;">
                                <button class="btn btn-primary" onclick="downloadModalExcel('${doc.documentId}', '${doc.filename}')" style="font-size: 0.9rem;">📊 Excel</button>
                                <button class="btn btn-secondary" onclick="downloadModalCSV('${doc.documentId}', '${doc.filename}')" style="font-size: 0.9rem;">📋 CSV</button>
                                <button class="btn btn-secondary" onclick="downloadModalJSON('${doc.documentId}', '${doc.filename}')" style="font-size: 0.9rem;">📄 JSON</button>
                            </div>
                        </div>
                        
                        <div style="flex: 1; overflow-y: auto;">
                            <h3 style="margin: 0 0 15px 0; color: #2d3748;">Extracted Data</h3>
                            <div class="modal-field-grid" style="display: grid; gap: 12px;">
                                ${Object.entries(extractedData).filter(([key]) => !['confidence_scores', 'layers_used', 'extraction_method'].includes(key)).map(([key, value]) => {
                                    const confidence = doc.extractedData?.confidence_scores?.[key] || 0.95;
                                    return `
                                        <div style="background: #f7fafc; padding: 16px; border-radius: 8px; border-left: 4px solid #667eea;">
                                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                                <div style="flex: 1;">
                                                    <div style="font-weight: 600; color: #4a5568; font-size: 0.9rem; margin-bottom: 4px;">${formatFieldName(key)}</div>
                                                    <div style="color: #2d3748; font-size: 1.1rem;">${formatFieldValue(key, value)}</div>
                                                </div>
                                                <div style="text-align: right;">
                                                    <div class="confidence-badge ${getConfidenceClass(confidence)}" style="padding: 2px 8px; border-radius: 12px; font-size: 0.8rem; font-weight: 600;">
                                                        ${Math.round(confidence * 100)}%
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    `;
                                }).join('')}
                            </div>
                            
                            <div style="margin-top: 20px; padding-top: 15px; border-top: 1px solid #e2e8f0; font-size: 0.9rem; color: #666;">
                                Processed: ${new Date(doc.timestamp).toLocaleString()}
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            window.currentModal = modal;
        }
        
        function closeDocumentModal() {
            closeModal();
        }
        
        async function downloadModalExcel(documentId, filename) {
            await downloadDocExcel(documentId, filename);
        }
        
        async function downloadModalCSV(documentId, filename) {
            await downloadDocCSV(documentId, filename);
        }
        
        async function downloadModalJSON(documentId, filename) {
            try {
                const response = await fetch(`${API_BASE}/result/${documentId}`);
                const resultData = await response.json();
                
                if (resultData.data) {
                    const jsonData = {
                        document_info: {
                            filename: filename,
                            document_type: resultData.document_type,
                            processed_at: new Date().toISOString(),
                            document_id: documentId
                        },
                        extracted_data: resultData.data,
                        confidence_scores: resultData.confidence_scores,
                        ai_insights: resultData.ai_insights,
                        sentiment_analysis: resultData.sentiment_analysis
                    };
                    
                    const blob = new Blob([JSON.stringify(jsonData, null, 2)], { type: 'application/json' });
                    downloadBlob(blob, `${filename.split('.')[0]}_extracted_data.json`);
                    addToExports('JSON', `${filename.split('.')[0]}_extracted_data.json`, documentId);
                    showNotification('📄 JSON downloaded successfully!');
                }
            } catch (error) {
                showNotification('JSON download failed: ' + error.message);
            }
        }
        
        function showNotification(message) {
            const notification = document.createElement('div');
            notification.className = 'success-message';
            notification.textContent = message;
            notification.style.position = 'fixed';
            notification.style.top = '20px';
            notification.style.right = '20px';
            notification.style.zIndex = '1000';
            notification.style.maxWidth = '300px';
            document.body.appendChild(notification);
            
            setTimeout(() => {
                if (document.body.contains(notification)) {
                    document.body.removeChild(notification);
                }
            }, 3000);
        }
        
        function updateAnalyticsView() {
            updateAnalytics();
            // Update usage bar
            const tierLimit = TIERS[userTier]?.limit || 20;
            const usagePercent = tierLimit > 0 ? (monthlyUsage / tierLimit) * 100 : 0;
            document.getElementById('usageBar').style.width = Math.min(usagePercent, 100) + '%';
            
            // Draw processing trends chart
            drawProcessingTrends();
        }
        
        function drawProcessingTrends() {
            const canvas = document.getElementById('analyticsChart');
            const ctx = canvas.getContext('2d');
            
            // Clear canvas
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            if (processedDocuments.length === 0) {
                // Show "No data" message
                ctx.fillStyle = '#9CA3AF';
                ctx.font = '16px Arial';
                ctx.textAlign = 'center';
                ctx.fillText('No processing data yet', canvas.width / 2, canvas.height / 2);
                ctx.fillText('Upload documents to see trends', canvas.width / 2, canvas.height / 2 + 25);
                return;
            }
            
            // Group documents by day
            const dailyData = {};
            processedDocuments.forEach(doc => {
                const date = new Date(doc.timestamp).toLocaleDateString();
                dailyData[date] = (dailyData[date] || 0) + 1;
            });
            
            const dates = Object.keys(dailyData).slice(-7); // Last 7 days
            const counts = dates.map(date => dailyData[date]);
            const maxCount = Math.max(...counts, 1);
            
            // Chart dimensions
            const padding = 40;
            const chartWidth = canvas.width - 2 * padding;
            const chartHeight = canvas.height - 2 * padding;
            const barWidth = chartWidth / dates.length;
            
            // Draw bars
            ctx.fillStyle = '#667eea';
            dates.forEach((date, index) => {
                const barHeight = (counts[index] / maxCount) * chartHeight;
                const x = padding + index * barWidth + barWidth * 0.1;
                const y = canvas.height - padding - barHeight;
                const width = barWidth * 0.8;
                
                ctx.fillRect(x, y, width, barHeight);
                
                // Draw count on top of bar
                ctx.fillStyle = '#2d3748';
                ctx.font = '12px Arial';
                ctx.textAlign = 'center';
                ctx.fillText(counts[index], x + width / 2, y - 5);
                
                // Draw date label
                ctx.fillStyle = '#666';
                ctx.font = '10px Arial';
                const shortDate = new Date(date).toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
                ctx.fillText(shortDate, x + width / 2, canvas.height - padding + 15);
                
                ctx.fillStyle = '#667eea';
            });
            
            // Draw title
            ctx.fillStyle = '#2d3748';
            ctx.font = 'bold 14px Arial';
            ctx.textAlign = 'center';
            ctx.fillText('Documents Processed (Last 7 Days)', canvas.width / 2, 20);
        }
        
        function updateSubscriptionsView() {
            const tierLimit = TIERS[userTier]?.limit || 20;
            const usagePercent = tierLimit > 0 ? (monthlyUsage / tierLimit) * 100 : 0;
            
            document.getElementById('usageBar').style.width = Math.min(usagePercent, 100) + '%';
            document.getElementById('usageText').textContent = 
                tierLimit === -1 ? 'Unlimited usage' : `${monthlyUsage} of ${tierLimit} documents used this month`;
            
            // Update current plan button
            document.querySelectorAll('.plan-btn').forEach(btn => {
                btn.classList.remove('current');
                if (btn.textContent === 'Current Plan') {
                    btn.textContent = 'Upgrade Now';
                }
            });
            
            const currentCard = document.querySelector(`.pricing-card.${userTier}`);
            if (currentCard) {
                const btn = currentCard.querySelector('.plan-btn');
                btn.textContent = 'Current Plan';
                btn.classList.add('current');
            }
        }
        
        function upgradePlan(plan) {
            if (plan === 'enterprise') {
                alert('🏢 Enterprise Plan\n\nContact our sales team for custom pricing and features:\n\n📧 sales@taxflowsai.com\n📞 1-800-TAXFLOW\n\nWe\'ll set up a demo and discuss your specific needs!');
                return;
            }
            
            const planInfo = TIERS[plan];
            if (confirm(`Upgrade to ${planInfo.name}?\n\n💰 Price: $${planInfo.price}/month\n📄 Documents: ${planInfo.limit === -1 ? 'Unlimited' : planInfo.limit + ' per month'}\n\n✅ Advanced AI extraction\n✅ Priority support\n✅ Multiple export formats`)) {
                if (currentUser) {
                    currentUser.tier = plan;
                    userTier = plan;
                    updateAuthUI();
                    saveUserData();
                    updateSubscriptionsView();
                    alert(`🎉 Successfully upgraded to ${planInfo.name}!\n\nYou now have ${planInfo.limit === -1 ? 'unlimited' : planInfo.limit} documents per month.`);
                } else {
                    alert('Please sign in first to upgrade your plan.');
                    showAuthModal('login');
                }
            }
        }
    </script>
</body>
</html>