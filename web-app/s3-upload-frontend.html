<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TaxDoc AI - S3 Upload</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: #f5f7fa; }
        .container { max-width: 800px; margin: 0 auto; padding: 20px; }
        .upload-area { 
            border: 2px dashed #3498db; border-radius: 12px; padding: 40px; text-align: center; 
            background: white; margin-bottom: 30px; cursor: pointer; transition: all 0.3s;
        }
        .upload-area:hover { border-color: #2980b9; background: #f8f9fa; }
        .upload-area.dragover { border-color: #27ae60; background: #e8f5e8; }
        .btn { 
            background: #3498db; color: white; border: none; padding: 12px 24px; 
            border-radius: 6px; cursor: pointer; font-size: 16px; transition: all 0.3s;
        }
        .btn:hover { background: #2980b9; }
        .btn:disabled { background: #bdc3c7; cursor: not-allowed; }
        .progress { 
            width: 100%; height: 20px; background: #ecf0f1; border-radius: 10px; 
            overflow: hidden; margin: 10px 0;
        }
        .progress-bar { 
            height: 100%; background: #3498db; transition: width 0.3s; 
            border-radius: 10px;
        }
        .status { 
            padding: 15px; border-radius: 8px; margin: 10px 0; 
            font-weight: 500;
        }
        .status.success { background: #d5f4e6; color: #27ae60; }
        .status.error { background: #ffeaa7; color: #e17055; }
        .status.processing { background: #dff9fb; color: #00b894; }
        .document-list { margin-top: 30px; }
        .document-item { 
            background: white; padding: 15px; border-radius: 8px; 
            margin-bottom: 10px; box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>TaxDoc AI - S3 Upload</h1>
        <p>Fast, reliable document processing with S3 direct upload</p>

        <div class="upload-area" id="uploadArea">
            <h3>Drop files here or click to upload</h3>
            <p>Supports PDF, PNG, JPEG - No size limits</p>
            <input type="file" id="fileInput" multiple accept=".pdf,.png,.jpg,.jpeg" style="display: none;">
            <button class="btn" onclick="document.getElementById('fileInput').click()">Choose Files</button>
        </div>

        <div id="uploadStatus"></div>
        <div class="document-list" id="documentList"></div>
    </div>

    <script>
        const API_BASE = 'https://iljpaj6ogl.execute-api.us-east-1.amazonaws.com/prod';
        let documents = [];

        // File upload handling
        const uploadArea = document.getElementById('uploadArea');
        const fileInput = document.getElementById('fileInput');
        const uploadStatus = document.getElementById('uploadStatus');
        const documentList = document.getElementById('documentList');

        uploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadArea.classList.add('dragover');
        });

        uploadArea.addEventListener('dragleave', () => {
            uploadArea.classList.remove('dragover');
        });

        uploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadArea.classList.remove('dragover');
            handleFiles(e.dataTransfer.files);
        });

        fileInput.addEventListener('change', (e) => {
            handleFiles(e.target.files);
        });

        async function handleFiles(files) {
            for (let file of files) {
                await processFileS3(file);
            }
        }

        function getAuthHeaders() {
            try {
                const token = window.DocGPTAuth?.getIdToken?.();
                return token ? { 'Authorization': `Bearer ${token}` } : {};
            } catch (e) {
                return {};
            }
        }

        async function processFileS3(file) {
            const docId = generateId();
            
            try {
                showStatus('Getting upload URL...', 'processing');
                
                // Step 1: Get presigned URL with fallbacks
                let urlResponse = await fetch(`${API_BASE}/upload-url?filename=${encodeURIComponent(file.name)}&contentType=${encodeURIComponent(file.type)}`, { headers: { ...getAuthHeaders() } });
                if (!urlResponse.ok) {
                    // try legacy aliases
                    const tryPaths = ['presign', 'presign1'];
                    for (const p of tryPaths) {
                        const r = await fetch(`${API_BASE}/${p}?filename=${encodeURIComponent(file.name)}&contentType=${encodeURIComponent(file.type)}`, { headers: { ...getAuthHeaders() } });
                        if (r.ok) { urlResponse = r; break; }
                    }
                }
                
                if (!urlResponse.ok) {
                    throw new Error(`Failed to get upload URL: ${urlResponse.status}`);
                }
                
                const { url, key } = await urlResponse.json();
                
                showStatus('Uploading to S3...', 'processing');
                
                // Step 2: Upload directly to S3
                const uploadResponse = await fetch(url, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': file.type
                    },
                    body: file
                });
                
                if (!uploadResponse.ok) {
                    throw new Error(`S3 upload failed: ${uploadResponse.status}`);
                }
                
                showStatus('Starting document processing...', 'processing');
                
                // Step 3: Trigger processing
                const processResponse = await fetch(`${API_BASE}/process`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        ...getAuthHeaders()
                    },
                    body: JSON.stringify({
                        s3Key: key,
                        filename: file.name,
                        userId: 'demo-user'
                    })
                });
                
                const result = await processResponse.json();
                
                if (processResponse.ok) {
                    showStatus(`Document queued for processing (ID: ${result.docId})`, 'success');
                    
                    // Add to document list
                    documents.unshift({
                        docId: result.docId,
                        filename: file.name,
                        status: result.status,
                        uploadedAt: new Date().toLocaleString()
                    });
                    
                    updateDocumentList();
                } else {
                    throw new Error(result.error || 'Processing failed');
                }
                
            } catch (error) {
                console.error('Upload error:', error);
                showStatus(`Upload failed: ${error.message}`, 'error');
            }
        }

        function showStatus(message, type) {
            uploadStatus.innerHTML = `<div class="status ${type}">${message}</div>`;
            
            if (type === 'success' || type === 'error') {
                setTimeout(() => {
                    uploadStatus.innerHTML = '';
                }, 5000);
            }
        }

        function updateDocumentList() {
            documentList.innerHTML = `
                <h3>Uploaded Documents</h3>
                ${documents.map(doc => `
                    <div class="document-item">
                        <strong>${doc.filename}</strong>
                        <br>
                        <small>ID: ${doc.docId} | Status: ${doc.status} | Uploaded: ${doc.uploadedAt}</small>
                    </div>
                `).join('')}
            `;
        }

        function generateId() {
            return 'doc_' + Math.random().toString(36).substr(2, 9);
        }
    </script>
</body>
</html>