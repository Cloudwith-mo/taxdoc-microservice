<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ParsePilot - Autopilot for your paperwork</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: #f8fafc; }
        
        .header { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 2rem; text-align: center; }
        .header h1 { font-size: 2.5rem; margin-bottom: 0.5rem; }
        .header p { font-size: 1.2rem; opacity: 0.9; }
        
        .nav-tabs { background: white; padding: 1rem; box-shadow: 0 2px 10px rgba(0,0,0,0.1); display: flex; gap: 1rem; justify-content: center; flex-wrap: wrap; }
        .nav-tab { padding: 0.75rem 1.5rem; border: none; background: #f1f5f9; border-radius: 8px; cursor: pointer; font-weight: 500; transition: all 0.3s; }
        .nav-tab.active { background: #667eea; color: white; }
        .nav-tab:hover { background: #e2e8f0; }
        .nav-tab.active:hover { background: #5a67d8; }
        
        .container { max-width: 1200px; margin: 2rem auto; padding: 0 1rem; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        .tab-btn.active {
            border-bottom-color: #667eea !important;
            color: #667eea;
            font-weight: 600;
        }
        
        .upload-area { background: white; border: 2px dashed #cbd5e0; border-radius: 12px; padding: 3rem; text-align: center; margin-bottom: 2rem; transition: all 0.3s; }
        .upload-area:hover { border-color: #667eea; background: #f7fafc; }
        .upload-area.dragover { border-color: #667eea; background: #edf2f7; }
        
        .template-editor { background: white; border-radius: 12px; padding: 2rem; box-shadow: 0 4px 20px rgba(0,0,0,0.1); }
        .template-grid { display: grid; grid-template-columns: 1fr 300px; gap: 2rem; margin-top: 1rem; }
        .document-preview { position: relative; border: 1px solid #e2e8f0; border-radius: 8px; overflow: hidden; }
        .document-preview img { width: 100%; height: auto; display: block; }
        .field-overlay { position: absolute; border: 2px solid #667eea; background: rgba(102, 126, 234, 0.1); cursor: pointer; }
        
        .field-properties { background: #f8fafc; padding: 1.5rem; border-radius: 8px; }
        .field-item { background: white; padding: 1rem; margin-bottom: 0.5rem; border-radius: 6px; border: 1px solid #e2e8f0; }
        
        .batch-processor { background: white; border-radius: 12px; padding: 2rem; box-shadow: 0 4px 20px rgba(0,0,0,0.1); }
        .file-list { margin-top: 1rem; }
        .file-item { display: flex; align-items: center; justify-content: between; padding: 1rem; border: 1px solid #e2e8f0; border-radius: 8px; margin-bottom: 0.5rem; }
        .status { padding: 0.25rem 0.75rem; border-radius: 20px; font-size: 0.875rem; font-weight: 500; }
        .status.pending { background: #fef3c7; color: #92400e; }
        .status.processing { background: #dbeafe; color: #1e40af; }
        .status.completed { background: #d1fae5; color: #065f46; }
        .status.failed { background: #fee2e2; color: #991b1b; }
        
        .btn { padding: 0.75rem 1.5rem; border: none; border-radius: 10px; font-weight: 600; cursor: pointer; transition: all 0.3s; box-shadow: 0 2px 8px rgba(0,0,0,0.1); position: relative; overflow: hidden; }
        .btn:hover { transform: translateY(-1px); box-shadow: 0 4px 12px rgba(0,0,0,0.15); }
        .btn-primary { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; }
        .btn-primary:hover { background: linear-gradient(135deg, #5a67d8 0%, #6b46c1 100%); }
        .btn-secondary { background: linear-gradient(135deg, #f1f5f9 0%, #e2e8f0 100%); color: #4a5568; border: 1px solid #cbd5e0; }
        .btn-secondary:hover { background: linear-gradient(135deg, #e2e8f0 0%, #cbd5e0 100%); }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
        .progress-bar { position: relative; overflow: hidden; }
        .progress-bar::after { content: ''; position: absolute; top: 0; left: -100%; width: 100%; height: 100%; background: linear-gradient(90deg, transparent, rgba(255,255,255,0.4), transparent); animation: shimmer 2s infinite; }
        @keyframes shimmer { 0% { left: -100%; } 100% { left: 100%; } }
        
        .analytics-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1.5rem; margin-bottom: 2rem; }
        .metric-card { background: white; padding: 1.5rem; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.1); }
        .metric-value { font-size: 2rem; font-weight: 700; color: #667eea; }
        .metric-label { color: #64748b; font-size: 0.875rem; margin-top: 0.5rem; }
        
        .processing-status { background: white; padding: 1.5rem; border-radius: 12px; margin-bottom: 1rem; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .progress-bar { width: 100%; height: 8px; background: #e2e8f0; border-radius: 4px; overflow: hidden; margin-top: 1rem; }
        .progress-fill { height: 100%; background: #667eea; transition: width 0.3s; }
        
        .results-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 1.5rem; }
        .result-card { background: white; padding: 1.5rem; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.1); }
        
        @media (max-width: 768px) {
            .template-grid { grid-template-columns: 1fr; }
            .nav-tabs { flex-direction: column; }
            .analytics-grid { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>
    <div class="header" style="display: flex; justify-content: space-between; align-items: center; padding: 1.5rem 2rem;">
        <div>
            <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 8px;">
                <div style="width: 48px; height: 48px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 12px; display: flex; align-items: center; justify-content: center; position: relative; overflow: hidden; box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);">
                    <div style="position: absolute; width: 100%; height: 100%; background: radial-gradient(circle at 30% 30%, rgba(255,255,255,0.3) 0%, transparent 50%); border-radius: 12px;"></div>
                    <div style="color: white; font-size: 24px; font-weight: bold; z-index: 1;">‚ö°</div>
                    <div style="position: absolute; top: 8px; right: 8px; width: 6px; height: 6px; background: #00ff88; border-radius: 50%; box-shadow: 0 0 8px #00ff88; animation: pulse 2s infinite;"></div>
                </div>
                <h1 style="margin: 0; font-size: 2.2rem; font-weight: 700; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text;">ParsePilot</h1>
            </div>
            <p style="margin: 0; font-size: 1.1rem; opacity: 0.95; font-weight: 500;">Automate ‚Ä¢ Extract ‚Ä¢ Accelerate</p>
            <p style="margin: 4px 0 0 0; font-size: 0.9rem; opacity: 0.8;">Powered by TurboParse‚Ñ¢ AI Engine</p>
        </div>
        <div class="auth-section" style="position: relative;">
            <button class="user-dropdown" id="userDropdown" style="background: rgba(255,255,255,0.2); color: white; border: none; padding: 10px 15px; border-radius: 6px; cursor: pointer; display: flex; align-items: center; gap: 8px;">
                <span id="userDisplayName">Guest User</span>
                <span>‚ñº</span>
            </button>
            <div class="dropdown-menu" id="dropdownMenu" style="position: absolute; top: 100%; right: 0; background: white; border: 1px solid #ddd; border-radius: 6px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); min-width: 200px; display: none; z-index: 1000;">
                <div class="dropdown-item" id="profileItem" style="padding: 12px 16px; border-bottom: 1px solid #f0f0f0; color: #333;">
                    <strong id="userEmail">guest@example.com</strong><br>
                    <small>Free Plan</small>
                </div>
                <div class="dropdown-item" onclick="showSettings()" style="padding: 12px 16px; border-bottom: 1px solid #f0f0f0; cursor: pointer; color: #333; transition: background 0.2s;">Account Settings</div>
                <div class="dropdown-item" onclick="showBilling()" style="padding: 12px 16px; border-bottom: 1px solid #f0f0f0; cursor: pointer; color: #333; transition: background 0.2s;">Billing & Plans</div>
                <div class="dropdown-item" id="authAction" onclick="toggleAuth()" style="padding: 12px 16px; cursor: pointer; color: #333; transition: background 0.2s;">Sign In</div>
            </div>
        </div>
    </div>

    <div class="nav-tabs">
        <button class="nav-tab active" onclick="showTab('upload')">üì§ Upload Documents</button>
        <button class="nav-tab" onclick="showTab('documents')">üìÑ My Documents</button>
        <button class="nav-tab" onclick="showTab('chatbot')">ü§ñ AI Chatbot</button>
        <button class="nav-tab" onclick="showTab('analytics')">üìä Analytics</button>
        <button class="nav-tab" onclick="showTab('pay')">üí≥ Plans</button>
        <button class="nav-tab" onclick="showTab('integrations')">üîó Integrations</button>
    </div>

    <div class="container">


        <!-- Upload & Batch Tab -->
        <div id="upload" class="tab-content active">
            <div class="upload-area" id="uploadArea">
                <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 16px;">
                    <div style="width: 40px; height: 40px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 10px; display: flex; align-items: center; justify-content: center;">
                        <span style="color: white; font-size: 20px;">üì§</span>
                    </div>
                    <div>
                        <h3 style="margin: 0; color: #1a202c;">Upload Documents</h3>
                        <p style="margin: 0; color: #64748b; font-size: 0.9rem;">From doc to data, on autopilot</p>
                    </div>
                </div>
                <p style="font-size: 0.875rem; color: #64748b; margin-top: 1rem;">Supports PDF, PNG, JPG ‚Ä¢ Max 10MB per file</p>
                <div id="uploadTrialInfo" style="background: #f0f9ff; padding: 1rem; border-radius: 6px; margin-top: 1rem; border-left: 4px solid #0ea5e9;">
                    <strong>üöÅ Free Trial:</strong> Process up to 50 documents per month with TurboParse‚Ñ¢ acceleration!
                </div>
                <input type="file" id="fileInput" multiple accept=".pdf,.png,.jpg,.jpeg" style="display: none;">
            </div>
            
            <div style="margin-top: 1rem; display: flex; gap: 1rem; justify-content: center;">
                <button class="btn btn-primary" onclick="processSelectedFiles()" id="processBtn" disabled>üöÄ Process Documents</button>
                <button class="btn btn-secondary" onclick="refreshPage()">üîÑ Refresh</button>
            </div>
            
            <div id="processingStatus" class="processing-status" style="display: none;">
                <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 16px;">
                    <div style="width: 32px; height: 32px; border: 3px solid #667eea; border-top: 3px solid transparent; border-radius: 50%; animation: spin 1s linear infinite;"></div>
                    <h4 style="margin: 0;">Processing with TurboParse‚Ñ¢...</h4>
                </div>
                <div class="progress-bar">
                    <div class="progress-fill" id="progressFill" style="width: 0%; background: linear-gradient(90deg, #667eea, #764ba2);"></div>
                </div>
                <p id="statusText" style="margin-top: 8px; color: #64748b;">Initializing AI extraction...</p>
            </div>
            <style>
                @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
            </style>

            <div id="results" class="results-grid" style="display: none;"></div>
        </div>

        <!-- Documents Tab -->
        <div id="documents" class="tab-content">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                <h3>üìÑ My Documents</h3>
                <div style="display: flex; align-items: center; gap: 1rem;">
                    <span style="font-size: 0.875rem; color: #667eea; font-weight: 500;">Powered by TurboParse‚Ñ¢</span>
                    <button class="btn btn-secondary" onclick="loadDocuments()">üîÑ Refresh</button>
                </div>
            </div>
            
            <div class="analytics-grid" style="margin-bottom: 2rem;">
                <div class="metric-card">
                    <div class="metric-value" id="totalDocsCount">0</div>
                    <div class="metric-label">Total Documents</div>
                </div>
                <div class="metric-card">
                    <div class="metric-value" id="processedDocsCount">0</div>
                    <div class="metric-label">Processed</div>
                </div>
                <div class="metric-card">
                    <div class="metric-value" id="avgConfidenceScore">0%</div>
                    <div class="metric-label">Avg Confidence</div>
                </div>
                <div class="metric-card">
                    <div class="metric-value" id="thisMonthCount">0</div>
                    <div class="metric-label">This Month</div>
                </div>
            </div>
            
            <input type="text" id="searchBar" placeholder="Search documents by content, type, or extracted fields..." style="width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 6px; margin-bottom: 20px; font-size: 16px;">
            
            <div style="display: flex; gap: 10px; margin-bottom: 20px; flex-wrap: wrap;" id="filterTabs">
                <div class="filter-tab active" data-filter="all" style="padding: 8px 16px; border: 1px solid #ddd; border-radius: 20px; background: #667eea; color: white; cursor: pointer; transition: all 0.3s;">All Documents</div>
                <div class="filter-tab" data-filter="W-2" style="padding: 8px 16px; border: 1px solid #ddd; border-radius: 20px; background: white; cursor: pointer; transition: all 0.3s;">W-2 Forms</div>
                <div class="filter-tab" data-filter="1099-NEC" style="padding: 8px 16px; border: 1px solid #ddd; border-radius: 20px; background: white; cursor: pointer; transition: all 0.3s;">1099-NEC</div>
                <div class="filter-tab" data-filter="INVOICE" style="padding: 8px 16px; border: 1px solid #ddd; border-radius: 20px; background: white; cursor: pointer; transition: all 0.3s;">Invoices</div>
                <div class="filter-tab" data-filter="RECEIPT" style="padding: 8px 16px; border: 1px solid #ddd; border-radius: 20px; background: white; cursor: pointer; transition: all 0.3s;">Receipts</div>
                <div class="filter-tab" data-filter="PAYSTUB" style="padding: 8px 16px; border: 1px solid #ddd; border-radius: 20px; background: white; cursor: pointer; transition: all 0.3s;">Paystubs</div>
                <div class="filter-tab" data-filter="BANK_STATEMENT" style="padding: 8px 16px; border: 1px solid #ddd; border-radius: 20px; background: white; cursor: pointer; transition: all 0.3s;">Bank Statements</div>
                <div class="filter-tab" data-filter="UNKNOWN" style="padding: 8px 16px; border: 1px solid #ddd; border-radius: 20px; background: white; cursor: pointer; transition: all 0.3s;">Other</div>
            </div>
            
            <div id="documentsResults" class="results-grid">
                <p>Loading documents...</p>
            </div>
        </div>

        <!-- AI Chatbot Tab -->
        <div id="chatbot" class="tab-content">
            <div style="background: white; padding: 2rem; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.1);">
                <h3>ü§ñ AI Document Assistant</h3>
                <p>Point. Parse. Proceed. Ask questions about your processed documents</p>
                <div id="chatArea" style="background: #f8fafc; padding: 1rem; border-radius: 8px; margin: 1rem 0; min-height: 300px;">
                    <div style="margin-bottom: 1rem; padding: 1rem; background: #667eea; color: white; border-radius: 6px;">
                        <strong>AI:</strong> Hello! I'm your ParsePilot assistant. Ask me about any extracted data from your processed documents - invoices, receipts, forms, contracts, and more.
                    </div>
                </div>
                <div style="display: flex; gap: 1rem;">
                    <input type="text" id="chatInput" placeholder="Ask about your documents..." style="flex: 1; padding: 0.75rem; border: 1px solid #e2e8f0; border-radius: 6px;">
                    <button class="btn btn-primary" onclick="sendChatMessage()">Send</button>
                </div>
            </div>
        </div>

        <!-- Pay Tab -->
        <div id="pay" class="tab-content">
            <div style="background: white; padding: 2rem; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.1); text-align: center;">
                <h3>üí≥ ParsePilot Plans</h3>
                <p>Guided, reliable document automation for every need</p>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 2rem; margin: 2rem 0;">
                    <div style="border: 1px solid #e2e8f0; padding: 2rem; border-radius: 8px;">
                        <h4>Free Trial</h4>
                        <div style="font-size: 2rem; font-weight: bold; color: #10b981;">$0/mo</div>
                        <ul style="text-align: left; margin: 1rem 0;">
                            <li>50 documents/month</li>
                            <li>Basic AI extraction</li>
                            <li>CSV/JSON export</li>
                        </ul>
                        <button class="btn btn-secondary" onclick="startFreeTrial()">Start Free Trial</button>
                        <div id="trialStatus" style="margin-top: 1rem; font-size: 0.875rem;"></div>
                    </div>
                    <div style="border: 1px solid #e2e8f0; padding: 2rem; border-radius: 8px;">
                        <h4>Micro Plan</h4>
                        <div style="font-size: 2rem; font-weight: bold; color: #f59e0b;">$0.99</div>
                        <ul style="text-align: left; margin: 1rem 0;">
                            <li>5 additional documents</li>
                            <li>One-time purchase</li>
                            <li>All extraction features</li>
                        </ul>
                        <button class="btn btn-warning" onclick="subscribe('micro')">Buy Now</button>
                    </div>
                    <div style="border: 1px solid #e2e8f0; padding: 2rem; border-radius: 8px;">
                        <h4>Pro Plan</h4>
                        <div style="font-size: 2rem; font-weight: bold; color: #667eea;">$29/mo</div>
                        <ul style="text-align: left; margin: 1rem 0;">
                            <li>1,000 documents/month</li>
                            <li>TurboParse‚Ñ¢ acceleration</li>
                            <li>Batch processing & async</li>
                        </ul>
                        <button class="btn btn-primary" onclick="subscribe('pro')">Subscribe</button>
                    </div>
                    <div style="border: 2px solid #667eea; padding: 2rem; border-radius: 8px;">
                        <h4>Enterprise</h4>
                        <div style="font-size: 2rem; font-weight: bold; color: #667eea;">$99/mo</div>
                        <ul style="text-align: left; margin: 1rem 0;">
                            <li>Unlimited documents</li>
                            <li>TurboParse‚Ñ¢ 5√ó faster batching</li>
                            <li>API access & custom models</li>
                        </ul>
                        <button class="btn btn-primary" onclick="subscribe('enterprise')">Subscribe</button>
                    </div>
                </div>
            </div>
        </div>





        <!-- Analytics Tab -->
        <div id="analytics" class="tab-content">
            <h3>üìä Processing Analytics</h3>
            
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
                <h3>üìä Processing Analytics</h3>
                <button class="btn btn-secondary" onclick="loadAnalytics()">üîÑ Refresh</button>
            </div>
            
            <div class="analytics-grid">
                <div class="metric-card">
                    <div class="metric-value" id="totalDocs">0</div>
                    <div class="metric-label">Total Documents</div>
                </div>
                <div class="metric-card">
                    <div class="metric-value" id="processedDocs">0</div>
                    <div class="metric-label">Processed</div>
                </div>
                <div class="metric-card">
                    <div class="metric-value" id="successRate">0%</div>
                    <div class="metric-label">Success Rate</div>
                </div>
                <div class="metric-card">
                    <div class="metric-value" id="avgConfidence">0%</div>
                    <div class="metric-label">Avg Confidence</div>
                </div>
                <div class="metric-card">
                    <div class="metric-value" id="processingTimeP50">0s</div>
                    <div class="metric-label">Processing Time (P50)</div>
                </div>
                <div class="metric-card">
                    <div class="metric-value" id="processingTimeP95">0s</div>
                    <div class="metric-label">Processing Time (P95)</div>
                </div>
                <div class="metric-card">
                    <div class="metric-value" id="storageUsed">0 MB</div>
                    <div class="metric-label">Storage Used</div>
                </div>
                <div class="metric-card">
                    <div class="metric-value" id="creditsRemaining">0</div>
                    <div class="metric-label">Credits Remaining</div>
                </div>
            </div>
            
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 2rem; margin-bottom: 2rem;">
                <div style="background: white; padding: 1.5rem; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.1);">
                    <h4>Document Types</h4>
                    <div id="documentTypes"></div>
                </div>
                <div style="background: white; padding: 1.5rem; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.1);">
                    <h4>Recent Activity</h4>
                    <div id="recentActivity"></div>
                </div>
            </div>


        </div>

        <!-- Integrations Tab -->
        <div id="integrations" class="tab-content">
            <h3>üîó Integrations & Export</h3>
            
            <div class="results-grid">
                <div class="result-card">
                    <h4>üìß Email Integration</h4>
                    <p>Forward documents to your unique email address for automatic processing</p>
                    <div style="background: #f8fafc; padding: 1rem; border-radius: 6px; margin: 1rem 0; font-family: monospace;">
                        [Generate your unique email address]
                    </div>
                    <button class="btn btn-primary">Generate Email</button>
                </div>

                <div class="result-card">
                    <h4>üìä Google Sheets</h4>
                    <p>Automatically export extracted data to Google Sheets</p>
                    <button class="btn btn-secondary" onclick="connectGoogleSheets()">Connect Sheets</button>
                </div>

                <div class="result-card">
                    <h4>‚ö° Zapier Integration</h4>
                    <p>Connect to 5000+ apps via Zapier webhooks</p>
                    <input type="url" placeholder="Webhook URL" style="width: 100%; padding: 0.5rem; border: 1px solid #e2e8f0; border-radius: 6px; margin: 0.5rem 0;">
                    <button class="btn btn-primary">Save Webhook</button>
                </div>

                <div class="result-card">
                    <h4>üîÑ API Access</h4>
                    <p>Programmatic access to document processing</p>
                    <div style="background: #f8fafc; padding: 1rem; border-radius: 6px; margin: 1rem 0; font-family: monospace; font-size: 0.875rem;">
                        POST /api/v1/process<br>
                        Authorization: Bearer your-api-key
                    </div>
                    <button class="btn btn-secondary">Generate API Key</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Edit Document Modal -->
    <div id="editModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 2000; align-items: center; justify-content: center;">
        <div style="background: white; border-radius: 12px; padding: 30px; max-width: 600px; width: 90%; max-height: 80vh; overflow-y: auto;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; padding-bottom: 15px; border-bottom: 1px solid #eee;">
                <h3 style="margin: 0;">Edit Document Fields</h3>
                <button onclick="closeEditModal()" style="background: none; border: none; font-size: 24px; cursor: pointer; color: #999; padding: 0; width: 30px; height: 30px;">&times;</button>
            </div>
            <div id="editForm">
                <!-- Form fields will be populated here -->
            </div>
            <div style="margin-top: 20px; display: flex; gap: 10px; justify-content: flex-end;">
                <button class="btn btn-secondary" onclick="closeEditModal()">Cancel</button>
                <button class="btn" onclick="saveDocument()" style="background: #27ae60; color: white;">Save Changes</button>
                <button class="btn btn-primary" onclick="downloadDocument()">Download</button>
            </div>
        </div>
    </div>

    <script>
        let currentFiles = [];
        let documents = [];
        let currentEditingDoc = null;
        const API_BASE = "https://iljpaj6ogl.execute-api.us-east-1.amazonaws.com/prod";

        // ===== ParsePilot Cognito Auth (Code + PKCE) =====
        const auth = (() => {
            const cfg = {
                domain: "https://parsepilot-auth.auth.us-east-1.amazoncognito.com",
                clientId: "9m6a4ar65gri6slu6jsch9ec",
                redirectUri: "https://d11rn2gcciu6ti.cloudfront.net/mvp2-enhanced.html",
                logoutUri: "https://d11rn2gcciu6ti.cloudfront.net/mvp2-enhanced.html",
                scope: "openid profile email"
            };

            const LS = {
                idToken: "taxdoc_token",
                access: "taxdoc_access", 
                refresh: "taxdoc_refresh",
                user: "taxdoc_user",
                username: "taxdoc_username",
                exp: "taxdoc_exp"
            };

            const b64url = s => btoa(String.fromCharCode(...new TextEncoder().encode(s)))
                .replace(/\+/g,'-').replace(/\//g,'_').replace(/=+$/,'');
            
            function parseJwt(t) {
                try { return JSON.parse(atob(t.split('.')[1].replace(/-/g,'+').replace(/_/g,'/'))); }
                catch { return {}; }
            }
            
            function set(k,v){ localStorage.setItem(k, typeof v==='string'?v:JSON.stringify(v)); }
            function get(k){ return localStorage.getItem(k); }
            function del(k){ localStorage.removeItem(k); }

            function persistTokens(tok) {
                const id = tok.id_token;
                const at = tok.access_token;
                const rt = tok.refresh_token;
                if (id) set(LS.idToken, id);
                if (at) set(LS.access, at);
                if (rt) set(LS.refresh, rt);
                const payload = parseJwt(id || at || "");
                if (payload && payload.sub) {
                    set(LS.user, payload.sub);
                    const name = payload.email || payload["cognito:username"] || "User";
                    set(LS.username, name);
                    if (payload.exp) set(LS.exp, payload.exp.toString());
                }
            }

            function signIn() {
                const params = new URLSearchParams({
                    response_type: "token",
                    client_id: cfg.clientId,
                    redirect_uri: cfg.redirectUri,
                    scope: cfg.scope
                });
                window.location = `${cfg.domain}/login?${params.toString()}`;
            }

            function signOut() {
                [LS.idToken,LS.access,LS.refresh,LS.user,LS.username,LS.exp].forEach(del);
                const params = new URLSearchParams({
                    client_id: cfg.clientId,
                    logout_uri: cfg.logoutUri
                });
                window.location = `${cfg.domain}/logout?${params.toString()}`;
            }

            function onRedirect() {
                if (location.hash.startsWith("#id_token") || location.hash.startsWith("#access_token")) {
                    const h = new URLSearchParams(location.hash.slice(1));
                    persistTokens({ 
                        id_token: h.get("id_token"), 
                        access_token: h.get("access_token") 
                    });
                    history.replaceState({}, document.title, location.pathname);
                    return true;
                }
                return false;
            }

            function getIdToken() { return get(LS.idToken); }
            
            function authHeaders() {
                const t = getIdToken();
                return t ? { "Authorization": `Bearer ${t}` } : {};
            }
            
            function getProfile() {
                return {
                    loggedIn: !!get(LS.idToken),
                    userId: get(LS.user) || "ANON",
                    username: get(LS.username) || "Guest User"
                };
            }

            return { signIn, signOut, onRedirect, getIdToken, authHeaders, getProfile };
        })();

        // User management - now uses auth system
        function getUserId() {
            return auth.getProfile().userId;
        }
        
        function getUserEmail() {
            return auth.getProfile().username;
        }
        
        function getUserName() {
            return auth.getProfile().username;
        }
        
        // Tab Management
        function showTab(tabName) {
            document.querySelectorAll('.tab-content').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.nav-tab').forEach(tab => tab.classList.remove('active'));
            document.getElementById(tabName).classList.add('active');
            event.target.classList.add('active');
            
            if (tabName === 'documents') {
                loadDocuments();
            }
        }
        
        // Auth functions
        function toggleDropdown() {
            const dropdown = document.getElementById('dropdownMenu');
            dropdown.style.display = dropdown.style.display === 'block' ? 'none' : 'block';
        }
        
        function toggleAuth() {
            if (auth.getProfile().loggedIn) {
                auth.signOut();
            } else {
                auth.signIn();
            }
        }
        
        function updateAuthUI() {
            const profile = auth.getProfile();
            const authAction = document.getElementById('authAction');
            const userDisplayName = document.getElementById('userDisplayName');
            const userEmail = document.getElementById('userEmail');
            
            if (profile.loggedIn) {
                authAction.textContent = 'Sign Out';
                userDisplayName.textContent = profile.username;
                userEmail.innerHTML = `<strong>${profile.username}</strong><br><small>Authenticated</small>`;
            } else {
                authAction.textContent = 'Sign In';
                userDisplayName.textContent = 'Guest User';
                userEmail.innerHTML = '<strong>guest@example.com</strong><br><small>Free Plan</small>';
            }
        }
        
        function showSettings() {
            if (!auth.getProfile().loggedIn) {
                auth.signIn();
                return;
            }
            alert('Account settings coming soon...');
        }
        
        function showBilling() {
            if (!auth.getProfile().loggedIn) {
                auth.signIn();
                return;
            }
            alert('Billing & plans coming soon...');
        }
        
        function logout() {
            auth.signOut();
        }

        // File Upload
        document.getElementById('uploadArea').addEventListener('click', () => {
            document.getElementById('fileInput').click();
        });

        document.getElementById('fileInput').addEventListener('change', (e) => {
            if (e.target.files.length > 0) {
                document.getElementById('processBtn').disabled = false;
                document.getElementById('processBtn').textContent = `üöÄ Process ${e.target.files.length} Document(s)`;
            }
        });
        // Removed batch file input listener as element doesn't exist

        // Drag and Drop
        ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
            document.getElementById('uploadArea').addEventListener(eventName, preventDefaults, false);
        });

        function preventDefaults(e) {
            e.preventDefault();
            e.stopPropagation();
        }

        ['dragenter', 'dragover'].forEach(eventName => {
            document.getElementById('uploadArea').addEventListener(eventName, () => {
                document.getElementById('uploadArea').classList.add('dragover');
            });
        });

        ['dragleave', 'drop'].forEach(eventName => {
            document.getElementById('uploadArea').addEventListener(eventName, () => {
                document.getElementById('uploadArea').classList.remove('dragover');
            });
        });

        document.getElementById('uploadArea').addEventListener('drop', (e) => {
            const files = e.dataTransfer.files;
            processFiles(files);
        });

        function processSelectedFiles() {
            const files = document.getElementById('fileInput').files;
            if (files.length > 0) {
                processFiles(files);
            }
        }
        
        function refreshPage() {
            window.location.reload();
        }

        // Removed handleBatchFileUpload function as batch processing was removed

        async function processFiles(files) {
            currentFiles = Array.from(files);
            document.getElementById('processingStatus').style.display = 'block';
            document.getElementById('results').style.display = 'none';

            for (let i = 0; i < files.length; i++) {
                const file = files[i];
                updateProgress((i / files.length) * 100, `Processing ${file.name}...`);
                
                try {
                    const result = await processDocument(file);
                    displayResult(result, file.name, file);
                } catch (error) {
                    console.error('Processing error:', error);
                }
            }

            updateProgress(100, 'Processing complete!');
            setTimeout(() => {
                document.getElementById('processingStatus').style.display = 'none';
                document.getElementById('results').style.display = 'grid';
            }, 1000);
        }





        async function processDocument(file) {
            // Check trial usage first
            const usage = await checkTrialUsage();
            if (usage.exceeded) {
                throw new Error('Free trial limit exceeded. Please upgrade to continue.');
            }
            
            // Convert file to base64
            const base64Content = await fileToBase64(file);
            
            // Process document directly
            const proc = await fetch(`${API_BASE}/process-document`, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ 
                    filename: file.name,
                    contentBase64: base64Content
                })
            });
            
            if (!proc.ok) {
                const errorText = await proc.text();
                throw new Error(`Process failed: ${proc.status} - ${errorText}`);
            }
            
            const result = await proc.json();
            console.log('API Response:', result);
            
            // Transform API response to frontend format
            const transformedResult = {
                document_type: result.docType || 'Unknown',
                confidence_score: Math.round((result.docTypeConfidence || 0) * 100),
                extracted_data: {}
            };
            
            // Convert API data format to frontend format with confidence scores
            if (result.fields && typeof result.fields === 'object') {
                Object.entries(result.fields).forEach(([key, value]) => {
                    // Skip error fields and text length fields
                    if (key !== 'error' && key !== 'EXTRACTED_TEXT_LENGTH' && key !== 'raw_text') {
                        transformedResult.extracted_data[key] = {
                            value: value || '',
                            confidence: 95
                        };
                    }
                });
            }
            
            // Add keyValues to extracted_data if no fields
            if (Object.keys(transformedResult.extracted_data).length === 0 && result.keyValues) {
                result.keyValues.forEach(kv => {
                    transformedResult.extracted_data[kv.key] = {
                        value: kv.value || '',
                        confidence: 90
                    };
                });
            }
            
            // Update trial usage
            await updateTrialUsage();
            return transformedResult;
        }
        
        function fileToBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = () => {
                    const dataUrl = reader.result;
                    const base64 = dataUrl.split(',')[1];
                    resolve(base64);
                };
                reader.onerror = reject;
                reader.readAsDataURL(file);
            });
        }

        function updateProgress(percent, text) {
            document.getElementById('progressFill').style.width = percent + '%';
            document.getElementById('statusText').textContent = text;
        }

        function displayResult(result, filename, file) {
            const resultsContainer = document.getElementById('results');
            const resultCard = document.createElement('div');
            resultCard.className = 'result-card';
            
            // Create image preview
            const imageUrl = URL.createObjectURL(file);
            
            resultCard.innerHTML = `
                <h4>üìÑ ${filename}</h4>
                <p><strong>Type:</strong> ${result.document_type} | <strong>Confidence:</strong> ${result.confidence_score}%</p>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 2rem; margin-top: 1rem;">
                    <!-- Image Preview -->
                    <div style="background: #f8fafc; padding: 1rem; border-radius: 8px; border: 1px solid #e2e8f0;">
                        <h5>Document Preview</h5>
                        <img src="${imageUrl}" alt="${filename}" style="width: 100%; max-height: 600px; object-fit: contain; border-radius: 6px; border: 1px solid #cbd5e0;">
                    </div>
                    
                    <!-- Extracted Data -->
                    <div style="background: #f8fafc; padding: 1rem; border-radius: 8px; border: 1px solid #e2e8f0; max-height: 600px; overflow-y: auto;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                            <h5>Extracted Data (${Object.keys(result.extracted_data).length} fields)</h5>
                            <button onclick="editUploadResult('${filename}')" class="btn btn-secondary" style="padding: 0.5rem 1rem; font-size: 0.875rem;">Edit Fields</button>
                        </div>
                        <div id="fields-${filename.replace(/[^a-zA-Z0-9]/g, '')}" style="display: grid; gap: 0.5rem;">
                            ${Object.entries(result.extracted_data).map(([key, data]) => `
                                <div style="background: white; padding: 0.75rem; border-radius: 6px; border-left: 3px solid #667eea;">
                                    <div style="font-weight: 600; font-size: 0.875rem; color: #374151;">${key.replace(/_/g, ' ').toUpperCase()}</div>
                                    <div style="font-size: 1rem; margin-top: 0.25rem;">${data.value}</div>
                                    <div style="color: #10b981; font-size: 0.75rem; margin-top: 0.25rem;">Confidence: ${data.confidence}%</div>
                                </div>
                            `).join('')}
                        </div>
                        <div style="margin-top: 1rem; display: flex; gap: 0.5rem;">
                            <button onclick="downloadUploadResult('${filename}')" class="btn btn-primary" style="padding: 0.5rem 1rem; font-size: 0.875rem;">Download JSON</button>
                        </div>
                    </div>
                </div>
            `;
            
            resultsContainer.appendChild(resultCard);
            
            // Save to persistent storage immediately
            const docData = {
                docId: generateId(),
                filename: filename,
                status: 'completed',
                docType: result.document_type,
                docTypeConfidence: result.confidence_score / 100,
                fields: Object.fromEntries(Object.entries(result.extracted_data).map(([k, v]) => [k, v.value])),
                summary: `Processed ${result.document_type} with ${result.confidence_score}% confidence`,
                uploadDate: new Date().toISOString(),
                userId: getUserId()
            };
            
            // Store in global variable for editing
            window.uploadResults = window.uploadResults || {};
            window.uploadResults[filename] = docData;
            
            saveDocumentToPersistentStorage(docData);
            updateAnalytics();
        }



        // Export Functions
        async function downloadJSON(filename) {
            try {
                const response = await fetch(`${API_BASE}/export/json?filename=${filename}`);
                const blob = await response.blob();
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = filename.replace(/\.[^/.]+$/, '') + '.json';
                a.click();
            } catch (error) {
                alert('Download failed');
            }
        }

        function downloadCSV(filename) {
            // Generate CSV from actual extracted data
            alert('CSV export not implemented yet');
        }

        // Integration Functions
        async function connectGoogleSheets() {
            try {
                const response = await fetch(`${API_BASE}/integrations/sheets`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ action: 'connect' })
                });
                const result = await response.json();
                alert(result.message || 'Google Sheets connected successfully!');
            } catch (error) {
                alert('Google Sheets connection failed');
            }
        }

        // Live Functions
        function openAuthModal() {
            document.getElementById('authModal').style.display = 'flex';
        }
        
        function closeAuthModal() {
            document.getElementById('authModal').style.display = 'none';
        }
        
        function showLogin() {
            document.getElementById('loginForm').style.display = 'block';
            document.getElementById('registerForm').style.display = 'none';
            document.getElementById('loginTab').classList.add('active');
            document.getElementById('registerTab').classList.remove('active');
        }
        
        function showRegister() {
            document.getElementById('loginForm').style.display = 'none';
            document.getElementById('registerForm').style.display = 'block';
            document.getElementById('loginTab').classList.remove('active');
            document.getElementById('registerTab').classList.add('active');
        }
        
        async function handleLogin() {
            const email = document.getElementById('loginEmail').value;
            
            if (!email) {
                document.getElementById('loginError').innerHTML = 'Please enter email';
                return;
            }
            
            // Simulate login for demo
            document.getElementById('authStatus').innerHTML = `‚úÖ Logged in as ${email}`;
            localStorage.setItem('userEmail', email);
            closeAuthModal();
        }
        
        async function handleRegister() {
            const email = document.getElementById('registerEmail').value;
            
            if (!email) {
                document.getElementById('registerError').innerHTML = 'Please enter email';
                return;
            }
            
            // Simulate registration for demo
            document.getElementById('registerError').innerHTML = '‚úÖ Registered successfully! Please login.';
            document.getElementById('registerError').style.color = 'green';
            setTimeout(() => showLogin(), 2000);
        }
        
        async function subscribe(plan) {
            const email = localStorage.getItem('userEmail');
            const authToken = localStorage.getItem('authToken');
            
            if (!authToken) {
                alert('Please login first to subscribe.');
                return;
            }
            
            const priceIds = {
                'micro': 'price_1S59HJBgGYaywldnGTnB64ha',
                'pro': 'price_1S59HtBgGYaywldnpTk4ReM9', 
                'enterprise': 'price_1S59IIBgGYaywldnnvkWZxTb'
            };
            
            const response = await fetch(`${API_BASE}/stripe/create-checkout`, {
                method: 'POST',
                headers: { 
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${authToken}`
                },
                body: JSON.stringify({ 
                    price_id: priceIds[plan],
                    mode: plan === 'micro' ? 'payment' : 'subscription',
                    success_url: window.location.href + '?success=true',
                    cancel_url: window.location.href + '?cancelled=true'
                })
            });
            
            const result = await response.json();
            
            if (response.ok && result.checkout_url) {
                window.location.href = result.checkout_url;
            } else {
                alert('Payment setup failed: ' + (result.error || 'Unknown error'));
            }
        }
        
        // Build chat memory from processed docs
        async function loadChatMemory() {
            const userId = getUserId();
            try {
                const r = await fetch(`${API_BASE}/documents?userId=${encodeURIComponent(userId)}`, { 
                    headers: { ...auth.authHeaders() }
                });
                if (!r.ok) return { facts: [], index: {} };
                const result = await r.json();
                const items = result.items || result || [];

                const latest = items
                    .filter(it => (it.status || 'PROCESSED') === 'PROCESSED')
                    .sort((a, b) => (b.processedAt || 0) - (a.processedAt || 0))
                    .slice(0, 12);

                const index = {};
                const facts = [];
                for (const it of latest) {
                    const rr = await fetch(`${API_BASE}/document?userId=${encodeURIComponent(userId)}&docId=${encodeURIComponent(it.docId)}`, { 
                        headers: { ...auth.authHeaders() }
                    });
                    if (!rr.ok) continue;
                    const doc = await rr.json();
                    const fields = doc.finalFields || doc.fields || {};

                    // Extract facts for Q&A
                    if ((doc.docType || '').toLowerCase().includes('w-2')) {
                        if (fields['Employer EIN']) facts.push(`W-2 Employer EIN: ${unwrapVal(fields['Employer EIN'])}`);
                        if (fields['Employer Name']) facts.push(`W-2 Employer: ${unwrapVal(fields['Employer Name'])}`);
                        if (fields['Box 1 - Wages']) facts.push(`W-2 Box 1 Wages: ${unwrapVal(fields['Box 1 - Wages'])}`);
                    }
                    if ((doc.docType || '').toLowerCase().includes('bank')) {
                        if (fields['Total Deposits']) facts.push(`Bank total deposits: ${unwrapVal(fields['Total Deposits'])}`);
                    }
                    if ((doc.docType || '').toLowerCase().includes('invoice') || (doc.docType || '').toLowerCase().includes('receipt')) {
                        if (fields['Vendor']) facts.push(`Vendor: ${unwrapVal(fields['Vendor'])}`);
                        if (fields['Total']) facts.push(`Total: ${unwrapVal(fields['Total'])}`);
                    }
                    index[it.docId] = { meta: it, fields };
                }
                return { facts, index };
            } catch (error) {
                return { facts: [], index: {} };
            }
        }

        function unwrapVal(v) { 
            return (typeof v === 'object' && v && 'value' in v) ? v.value : v; 
        }

        async function sendChatMessage() {
            const input = document.getElementById('chatInput');
            const message = input.value.trim();
            if (!message) return;
            
            const chatArea = document.querySelector('#chatbot div[style*="background: #f8fafc"]');
            
            // Add user message immediately
            chatArea.innerHTML += `
                <div style="margin-bottom: 1rem; padding: 1rem; background: white; border-radius: 6px;">
                    <strong>You:</strong> ${message}
                </div>
            `;
            input.value = '';
            
            // Add typing indicator
            const typingId = 'typing-' + Date.now();
            chatArea.innerHTML += `
                <div id="${typingId}" style="margin-bottom: 1rem; padding: 1rem; background: #667eea; color: white; border-radius: 6px;">
                    <strong>AI:</strong> <em>Thinking...</em>
                </div>
            `;
            
            try {
                // Use new facts-based chat endpoint
                const response = await fetch(`${API_BASE}/chat-facts`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        ...auth.authHeaders()
                    },
                    body: JSON.stringify({
                        message: message,
                        user_id: getUserId()
                    })
                });
                
                const data = await response.json();
                
                // Remove typing indicator
                document.getElementById(typingId).remove();
                
                // Handle source highlighting
                if (data.source && data.source.bbox) {
                    console.log('Highlight source:', data.source);
                }
                
                // Add AI response
                chatArea.innerHTML += `
                    <div style="margin-bottom: 1rem; padding: 1rem; background: #667eea; color: white; border-radius: 6px;">
                        <strong>AI:</strong> ${data.response || 'Sorry, I could not process your request.'}
                    </div>
                `;
                
            } catch (error) {
                // Remove typing indicator
                document.getElementById(typingId)?.remove();
                
                // Fallback response
                chatArea.innerHTML += `
                    <div style="margin-bottom: 1rem; padding: 1rem; background: #667eea; color: white; border-radius: 6px;">
                        <strong>AI:</strong> I'm here to help with your processed documents. Please process some documents first, then I can answer questions about the extracted data.
                    </div>
                `;
            }
        }
        
        function getLastProcessedData() {
            // Get data from last processed document
            return {};
        }
        
        function getSmartResponse(message) {
            return 'I\'m here to help with your tax documents. Please process a document first, then I can answer questions about the extracted data.';
        }
        
        async function loadAnalytics() {
            try {
                // Load documents with auth headers
                const response = await fetch(`${API_BASE}/documents?userId=${encodeURIComponent(getUserId())}`, {
                    headers: { ...auth.authHeaders() }
                });
                if (response.ok) {
                    const result = await response.json();
                    const docs = result.items || result || [];
                    const analytics = calculateLocalAnalytics(docs);
                    updateAnalyticsDisplay(analytics);
                } else {
                    throw new Error('Backend unavailable');
                }
            } catch (error) {
                // Calculate from local storage
                const docs = JSON.parse(localStorage.getItem(`docs_${getUserId()}`) || '[]');
                const analytics = calculateLocalAnalytics(docs);
                updateAnalyticsDisplay(analytics);
            }
        }
        
        function calculateLocalAnalytics(docs) {
            const total = docs.length;
            const processed = docs.filter(d => d.status === 'completed').length;
            const failed = docs.filter(d => d.status === 'error').length;
            const avgConf = processed > 0 ? 
                docs.filter(d => d.status === 'completed')
                    .reduce((sum, d) => sum + (d.docTypeConfidence || 0), 0) / processed * 100 : 0;
            
            const processingTimes = docs.filter(d => d.processingTime).map(d => d.processingTime);
            const avgProcessingTime = processingTimes.length > 0 ? 
                processingTimes.reduce((a, b) => a + b, 0) / processingTimes.length : 0;
            
            const storageUsed = docs.reduce((sum, d) => sum + (d.fileSize || 0), 0) / (1024 * 1024); // MB
            
            const docTypes = {};
            docs.forEach(d => {
                docTypes[d.docType] = (docTypes[d.docType] || 0) + 1;
            });
            
            return {
                totalDocuments: total,
                processedDocuments: processed,
                successRate: total > 0 ? Math.round((processed / total) * 100) : 0,
                averageConfidence: Math.round(avgConf),
                processingTimeP50: Math.round(avgProcessingTime),
                processingTimeP95: Math.round(avgProcessingTime * 1.2),
                storageUsed: Math.round(storageUsed),
                creditsRemaining: 50 - total,
                documentTypes: docTypes,
                recentActivity: docs.slice(0, 5).map(d => ({
                    filename: d.filename,
                    docType: d.docType,
                    timestamp: d.uploadDate,
                    status: d.status
                }))
            };
        }
        
        function updateAnalyticsDisplay(analytics) {
            document.getElementById('totalDocs').textContent = analytics.totalDocuments || 0;
            document.getElementById('processedDocs').textContent = analytics.processedDocuments || 0;
            document.getElementById('successRate').textContent = (analytics.successRate || 0) + '%';
            document.getElementById('avgConfidence').textContent = (analytics.averageConfidence || 0) + '%';
            document.getElementById('processingTimeP50').textContent = (analytics.processingTimeP50 || 0) + 's';
            document.getElementById('processingTimeP95').textContent = (analytics.processingTimeP95 || 0) + 's';
            document.getElementById('storageUsed').textContent = (analytics.storageUsed || 0) + ' MB';
            document.getElementById('creditsRemaining').textContent = Math.max(0, analytics.creditsRemaining || 0);
            
            // Document types
            const docTypesDiv = document.getElementById('documentTypes');
            if (analytics.documentTypes && Object.keys(analytics.documentTypes).length > 0) {
                docTypesDiv.innerHTML = Object.entries(analytics.documentTypes)
                    .map(([type, count]) => `
                        <div style="display: flex; justify-content: space-between; padding: 0.5rem 0; border-bottom: 1px solid #e2e8f0;">
                            <span>${type}</span>
                            <span style="font-weight: 600;">${count}</span>
                        </div>
                    `).join('');
            } else {
                docTypesDiv.innerHTML = '<p style="color: #64748b; text-align: center;">No documents processed yet</p>';
            }
            
            // Recent activity
            const activityDiv = document.getElementById('recentActivity');
            if (analytics.recentActivity && analytics.recentActivity.length > 0) {
                activityDiv.innerHTML = analytics.recentActivity
                    .map(activity => `
                        <div style="padding: 0.5rem 0; border-bottom: 1px solid #e2e8f0;">
                            <div style="font-weight: 600; font-size: 0.875rem;">${activity.filename}</div>
                            <div style="color: #64748b; font-size: 0.75rem;">${activity.docType} ‚Ä¢ ${new Date(activity.timestamp).toLocaleDateString()}</div>
                        </div>
                    `).join('');
            } else {
                activityDiv.innerHTML = '<p style="color: #64748b; text-align: center;">No recent activity</p>';
            }
        }
        
        function updateAnalytics() {
            loadAnalytics();
        }
        
        async function loadDocuments() {
            try {
                // Load with auth headers
                const response = await fetch(`${API_BASE}/documents?userId=${encodeURIComponent(getUserId())}`, {
                    headers: { ...auth.authHeaders() }
                });
                if (response.ok) {
                    const result = await response.json();
                    documents = result.items || result || [];
                } else {
                    throw new Error('Backend unavailable');
                }
            } catch (error) {
                console.log('Loading from local storage');
                // Fallback to local storage
                documents = JSON.parse(localStorage.getItem(`docs_${getUserId()}`) || '[]');
            }
            
            updateDocumentStats();
            updateDocumentGrid();
        }
        
        function updateDocumentStats() {
            const total = documents.length;
            const processed = documents.filter(d => d.status === 'completed').length;
            const avgConf = processed > 0 ? 
                Math.round(documents.filter(d => d.status === 'completed')
                    .reduce((sum, d) => sum + (d.docTypeConfidence || 0), 0) / processed * 100) : 0;
            
            const thisMonth = documents.filter(d => {
                const docDate = new Date(d.uploadDate || d.createdAt || Date.now());
                const now = new Date();
                return docDate.getMonth() === now.getMonth() && docDate.getFullYear() === now.getFullYear();
            }).length;

            document.getElementById('totalDocsCount').textContent = total;
            document.getElementById('processedDocsCount').textContent = processed;
            document.getElementById('avgConfidenceScore').textContent = avgConf + '%';
            document.getElementById('thisMonthCount').textContent = thisMonth;
        }
        
        function updateDocumentGrid() {
            const grid = document.getElementById('documentsResults');
            const searchTerm = document.getElementById('searchBar').value.toLowerCase();
            const activeFilter = document.querySelector('.filter-tab.active').dataset.filter;

            const filteredDocs = documents.filter(doc => {
                // Filter by type
                if (activeFilter !== 'all' && doc.docType !== activeFilter) return false;
                
                // Filter by search term
                if (searchTerm) {
                    const searchableText = [
                        doc.filename,
                        doc.docType,
                        doc.summary,
                        ...Object.values(doc.fields || {}),
                        ...Object.values(doc.keyValues || []).map(kv => kv.key + ' ' + kv.value)
                    ].join(' ').toLowerCase();
                    
                    if (!searchableText.includes(searchTerm)) return false;
                }
                
                return true;
            });

            if (filteredDocs.length === 0) {
                grid.innerHTML = '<p style="color: #64748b; text-align: center; padding: 2rem;">No documents found. Upload documents in the Upload tab.</p>';
                return;
            }

            grid.innerHTML = filteredDocs.map(doc => createDocumentCard(doc)).join('');
        }
        
        function createDocumentCard(doc) {
            const confidenceClass = getConfidenceClass(doc.docTypeConfidence);
            const docTypeClass = doc.docType.toLowerCase().replace(/[^a-z0-9]/g, '-');
            
            return `
                <div class="result-card" style="position: relative;">
                    ${doc.status === 'completed' ? `
                        <div style="position: absolute; top: 15px; right: 15px; display: flex; gap: 8px;">
                            <button onclick="editDocument('${doc.docId}')" style="background: #f8f9fa; border: 1px solid #ddd; border-radius: 4px; padding: 6px 10px; font-size: 12px; cursor: pointer;">Edit</button>
                            <button onclick="downloadDocument('${doc.docId}')" style="background: #f8f9fa; border: 1px solid #ddd; border-radius: 4px; padding: 6px 10px; font-size: 12px; cursor: pointer;">Download</button>
                        </div>
                    ` : ''}
                    
                    <div style="display: inline-block; padding: 4px 12px; border-radius: 20px; font-size: 12px; font-weight: bold; margin-bottom: 10px; text-transform: uppercase; background: #667eea; color: white;">${doc.docType}</div>
                    <div style="font-size: 12px; color: #7f8c8d; margin-bottom: 10px;">Confidence: ${Math.round((doc.docTypeConfidence || 0) * 100)}%</div>
                    <h4>${doc.filename}</h4>
                    
                    ${doc.summary ? `<div style="background: #f8f9fa; padding: 12px; border-radius: 6px; margin-top: 10px; font-style: italic; color: #5a6c7d; font-size: 14px;">${doc.summary}</div>` : ''}
                    
                    ${renderExtractedFields(doc.fields)}
                </div>
            `;
        }
        
        function getConfidenceClass(confidence) {
            if (confidence >= 0.8) return 'high';
            if (confidence >= 0.6) return 'medium';
            return 'low';
        }
        
        function renderExtractedFields(fields) {
            if (!fields || Object.keys(fields).length === 0) return '';
            
            const items = Object.entries(fields)
                .filter(([_, v]) => v && String(v).trim() !== "" && String(v) !== "null")
                .map(([k, v]) => ({
                    label: formatFieldName(k),
                    value: typeof v === "object" ? v.value : v,
                    confidence: typeof v === "object" ? Math.round(100 * (v.confidence || 0.9)) : 90
                }))
                .sort((a, b) => a.label.localeCompare(b.label));

            if (items.length === 0) return '';

            return `
                <div style="margin-top: 15px;">
                    <strong>Extracted Fields (${items.length}):</strong>
                    ${items.slice(0, 8).map(item => `
                        <div style="display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid #ecf0f1; font-size: 14px;">
                            <span style="font-weight: 600; color: #2c3e50;">${item.label}</span>
                            <span style="color: #34495e; text-align: right; max-width: 60%; word-break: break-word;">${item.value}</span>
                        </div>
                    `).join('')}
                    ${items.length > 8 ? `<div style="padding: 8px 0; font-style: italic;"><em>+${items.length - 8} more fields</em></div>` : ''}
                </div>
            `;
        }
        
        const FIELD_LABELS = {
            employee_ssn: "Employee SSN",
            employer_ein: "Employer EIN",
            employee_name: "Employee Name",
            employer_address: "Employer Address",
            "Employee SSN": "Employee SSN",
            "Employee Name": "Employee Name",
            "Employer EIN": "Employer EIN",
            "Box 1 - Wages": "Wages, tips, other compensation (Box 1)",
            "Box 2 - Federal Tax": "Federal income tax withheld (Box 2)",
            "Box 3 - SS Wages": "Social security wages (Box 3)",
            "Box 4 - SS Tax": "Social security tax withheld (Box 4)",
            "Box 5 - Medicare Wages": "Medicare wages and tips (Box 5)",
            "Box 6 - Medicare Tax": "Medicare tax withheld (Box 6)",
            box1_wages: "Wages, tips, other compensation (Box 1)",
            box2_fed_tax: "Federal income tax withheld (Box 2)",
            box3_ss_wages: "Social security wages (Box 3)",
            box4_ss_tax: "Social security tax withheld (Box 4)",
            box5_medicare_wages: "Medicare wages and tips (Box 5)",
            box6_medicare_tax: "Medicare tax withheld (Box 6)",
            box12a: "Box 12a", box12b: "Box 12b", box12c: "Box 12c", box12d: "Box 12d",
            state: "State (Box 15)", state_wages: "State wages (Box 16)",
            state_tax: "State income tax (Box 17)", local_wages: "Local wages (Box 18)",
            local_tax: "Local income tax (Box 19)", locality: "Locality name (Box 20)",
            taxyear: "Tax Year", "Tax Year": "Tax Year"
        };
        
        function formatFieldName(key) {
            return FIELD_LABELS[key] || key.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
        }
        
        // Edit document functions
        function editDocument(docId) {
            const doc = documents.find(d => d.docId === docId);
            if (!doc) return;

            currentEditingDoc = doc;
            populateEditForm(doc);
            document.getElementById('editModal').style.display = 'flex';
        }
        
        function populateEditForm(doc) {
            const form = document.getElementById('editForm');
            const fields = doc.fields || {};
            
            let formHTML = `
                <div style="margin-bottom: 1rem;">
                    <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #333;">Document Type</label>
                    <input type="text" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px;" value="${doc.docType}" readonly>
                </div>
                <div style="margin-bottom: 1rem;">
                    <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #333;">Filename</label>
                    <input type="text" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px;" value="${doc.filename}" readonly>
                </div>
            `;

            // Add existing fields
            Object.entries(fields).forEach(([key, value]) => {
                const displayValue = typeof value === 'object' ? value.value : value;
                formHTML += `
                    <div style="margin-bottom: 1rem;">
                        <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #333;">${formatFieldName(key)}</label>
                        <div style="display: flex; align-items: center;">
                            <input type="text" style="flex: 1; padding: 10px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px;" data-field="${key}" value="${displayValue || ''}">
                            <button type="button" onclick="removeField('${key}')" style="background: #e74c3c; color: white; border: none; padding: 4px 8px; border-radius: 3px; cursor: pointer; font-size: 12px; margin-left: 10px;">Remove</button>
                        </div>
                    </div>
                `;
            });

            // Add new field section
            formHTML += `
                <div style="margin-bottom: 1rem;">
                    <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #333;">Add New Field</label>
                    <div style="display: flex; gap: 10px; margin-bottom: 10px;">
                        <input type="text" id="newFieldName" style="flex: 1; padding: 10px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px;" placeholder="Field name">
                        <input type="text" id="newFieldValue" style="flex: 1; padding: 10px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px;" placeholder="Field value">
                        <button type="button" onclick="addNewField()" style="background: #27ae60; color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer; font-size: 14px;">Add</button>
                    </div>
                </div>
            `;

            form.innerHTML = formHTML;
        }
        
        function addNewField() {
            const nameInput = document.getElementById('newFieldName');
            const valueInput = document.getElementById('newFieldValue');
            
            if (!nameInput.value.trim() || !valueInput.value.trim()) return;

            const key = nameInput.value.trim();
            const value = valueInput.value.trim();

            // Add to current editing doc
            if (!currentEditingDoc.fields) currentEditingDoc.fields = {};
            currentEditingDoc.fields[key] = value;

            // Refresh form
            populateEditForm(currentEditingDoc);
        }
        
        function removeField(fieldKey) {
            if (currentEditingDoc.fields) {
                delete currentEditingDoc.fields[fieldKey];
                populateEditForm(currentEditingDoc);
            }
        }
        
        async function saveDocument() {
            if (!currentEditingDoc) return;

            // Collect form data
            const formInputs = document.querySelectorAll('#editForm input[data-field]');
            const updatedFields = {};
            
            formInputs.forEach(input => {
                const fieldKey = input.dataset.field;
                const fieldValue = input.value.trim();
                if (fieldValue) {
                    updatedFields[fieldKey] = fieldValue;
                }
            });

            currentEditingDoc.fields = updatedFields;

            try {
                // Save to backend with auth headers
                await fetch(`${API_BASE}/document/${currentEditingDoc.docId}`, {
                    method: 'PATCH',
                    headers: { 
                        'Content-Type': 'application/json',
                        ...auth.authHeaders()
                    },
                    body: JSON.stringify({
                        fields: updatedFields,
                        userId: getUserId()
                    })
                });

                // Update local documents array
                const docIndex = documents.findIndex(d => d.docId === currentEditingDoc.docId);
                if (docIndex !== -1) {
                    documents[docIndex] = { ...currentEditingDoc };
                }
                
                // Update upload results if editing from upload tab
                if (window.uploadResults) {
                    Object.keys(window.uploadResults).forEach(filename => {
                        if (window.uploadResults[filename].docId === currentEditingDoc.docId) {
                            window.uploadResults[filename] = { ...currentEditingDoc };
                            // Update the display
                            const fieldsDiv = document.getElementById(`fields-${filename.replace(/[^a-zA-Z0-9]/g, '')}`);
                            if (fieldsDiv) {
                                fieldsDiv.innerHTML = Object.entries(currentEditingDoc.fields || {}).map(([key, value]) => `
                                    <div style="background: white; padding: 0.75rem; border-radius: 6px; border-left: 3px solid #667eea;">
                                        <div style="font-weight: 600; font-size: 0.875rem; color: #374151;">${key.replace(/_/g, ' ').toUpperCase()}</div>
                                        <div style="font-size: 1rem; margin-top: 0.25rem;">${value}</div>
                                        <div style="color: #10b981; font-size: 0.75rem; margin-top: 0.25rem;">Confidence: 95%</div>
                                    </div>
                                `).join('');
                            }
                        }
                    });
                }

                // Update local storage
                localStorage.setItem(`docs_${getUserId()}`, JSON.stringify(documents));

                closeEditModal();
                updateDocumentGrid();
                updateAnalytics();
                
            } catch (error) {
                console.error('Failed to save document:', error);
                alert('Failed to save changes. Please try again.');
            }
        }
        
        function downloadDocument(docId) {
            const doc = currentEditingDoc || documents.find(d => d.docId === docId);
            if (!doc) return;

            const data = {
                filename: doc.filename,
                docType: doc.docType,
                fields: doc.fields || {},
                extractedAt: new Date().toISOString()
            };

            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `${doc.filename.replace(/\.[^/.]+$/, '')}_extracted.json`;
            a.click();
            URL.revokeObjectURL(url);
        }
        
        function closeEditModal() {
            document.getElementById('editModal').style.display = 'none';
            currentEditingDoc = null;
        }
        
        async function saveDocumentToPersistentStorage(doc) {
            try {
                // Save to backend with auth headers
                await fetch(`${API_BASE}/documents`, {
                    method: 'POST',
                    headers: { 
                        'Content-Type': 'application/json',
                        ...auth.authHeaders()
                    },
                    body: JSON.stringify(doc)
                });
                
                // Also save locally
                const savedDocs = JSON.parse(localStorage.getItem(`docs_${getUserId()}`) || '[]');
                savedDocs.unshift(doc);
                localStorage.setItem(`docs_${getUserId()}`, JSON.stringify(savedDocs));
                
            } catch (error) {
                console.error('Failed to save document:', error);
                // Fallback to local storage only
                const savedDocs = JSON.parse(localStorage.getItem(`docs_${getUserId()}`) || '[]');
                savedDocs.unshift(doc);
                localStorage.setItem(`docs_${getUserId()}`, JSON.stringify(savedDocs));
            }
        }
        
        function generateId() {
            return 'doc_' + Math.random().toString(36).substr(2, 9);
        }
        
        // Upload result editing functions
        function editUploadResult(filename) {
            const docData = window.uploadResults[filename];
            if (!docData) return;
            
            currentEditingDoc = docData;
            populateEditForm(docData);
            document.getElementById('editModal').style.display = 'flex';
        }
        
        function downloadUploadResult(filename) {
            const docData = window.uploadResults[filename];
            if (!docData) return;
            
            const data = {
                filename: docData.filename,
                docType: docData.docType,
                fields: docData.fields || {},
                extractedAt: new Date().toISOString()
            };

            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `${filename.replace(/\.[^/.]+$/, '')}_extracted.json`;
            a.click();
            URL.revokeObjectURL(url);
        }
        

        
        async function startFreeTrial() {
            // Activate trial locally
            localStorage.setItem('trialActive', 'true');
            localStorage.setItem('trialUsage', '0');
            localStorage.setItem('trialStartDate', new Date().toISOString());
            document.getElementById('trialStatus').innerHTML = '‚úÖ Free trial activated! 50 documents remaining.';
        }
        
        async function checkTrialUsage() {
            const usage = parseInt(localStorage.getItem('trialUsage') || '0');
            const isActive = localStorage.getItem('trialActive') === 'true';
            
            if (!isActive) {
                return { exceeded: false, remaining: 50 };
            }
            
            const remaining = Math.max(0, 50 - usage);
            return { 
                exceeded: usage >= 50, 
                remaining,
                used: usage
            };
        }
        
        async function updateTrialUsage() {
            const currentUsage = parseInt(localStorage.getItem('trialUsage') || '0');
            const newUsage = currentUsage + 1;
            localStorage.setItem('trialUsage', newUsage.toString());
            
            const remaining = Math.max(0, 50 - newUsage);
            if (remaining === 0) {
                document.getElementById('trialStatus').innerHTML = '‚ö†Ô∏è Trial limit reached. Upgrade to continue.';
            } else {
                document.getElementById('trialStatus').innerHTML = `‚úÖ ${remaining} documents remaining in trial.`;
            }
        }
        
        // Initialize
        document.addEventListener('DOMContentLoaded', async () => {
            // Handle auth redirect and update UI
            await auth.onRedirect();
            
            // Initialize auth UI
            updateAuthUI();
            
            // Setup event listeners
            document.getElementById('userDropdown').addEventListener('click', (e) => {
                e.stopPropagation();
                toggleDropdown();
            });
            document.addEventListener('click', (e) => {
                if (!e.target.closest('.auth-section')) {
                    document.getElementById('dropdownMenu').style.display = 'none';
                }
            });
            
            // Search and filters
            document.getElementById('searchBar').addEventListener('input', updateDocumentGrid);
            document.getElementById('filterTabs').addEventListener('click', (e) => {
                if (e.target.classList.contains('filter-tab')) {
                    document.querySelectorAll('.filter-tab').forEach(tab => {
                        tab.classList.remove('active');
                        tab.style.background = 'white';
                        tab.style.color = '#333';
                    });
                    e.target.classList.add('active');
                    e.target.style.background = '#667eea';
                    e.target.style.color = 'white';
                    updateDocumentGrid();
                }
            });
            
            // Dropdown hover effects
            document.querySelectorAll('.dropdown-item').forEach(item => {
                item.addEventListener('mouseenter', () => {
                    item.style.background = '#f8f9fa';
                });
                item.addEventListener('mouseleave', () => {
                    item.style.background = 'white';
                });
            });
            
            loadAnalytics();
            loadDocuments();
            
            // Initialize upload results storage
            window.uploadResults = window.uploadResults || {};
            
            // Check trial status on load
            const isTrialActive = localStorage.getItem('trialActive') === 'true';
            if (isTrialActive) {
                checkTrialUsage().then(usage => {
                    if (usage.remaining > 0) {
                        document.getElementById('trialStatus').innerHTML = `‚úÖ ${usage.remaining} documents remaining in trial.`;
                    } else {
                        document.getElementById('trialStatus').innerHTML = '‚ö†Ô∏è Trial limit reached. Upgrade to continue.';
                    }
                });
            }
        });
    </script>
</body>
</html>