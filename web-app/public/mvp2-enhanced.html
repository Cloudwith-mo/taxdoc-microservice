<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TaxDoc Pro - AI-Powered Document Processing</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: #f8fafc; }
        
        .header { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 2rem; text-align: center; }
        .header h1 { font-size: 2.5rem; margin-bottom: 0.5rem; }
        .header p { font-size: 1.2rem; opacity: 0.9; }
        
        .nav-tabs { background: white; padding: 1rem; box-shadow: 0 2px 10px rgba(0,0,0,0.1); display: flex; gap: 1rem; justify-content: center; flex-wrap: wrap; }
        .nav-tab { padding: 0.75rem 1.5rem; border: none; background: #f1f5f9; border-radius: 8px; cursor: pointer; font-weight: 500; transition: all 0.3s; }
        .nav-tab.active { background: #667eea; color: white; }
        .nav-tab:hover { background: #e2e8f0; }
        .nav-tab.active:hover { background: #5a67d8; }
        
        .container { max-width: 1200px; margin: 2rem auto; padding: 0 1rem; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        .tab-btn.active {
            border-bottom-color: #667eea !important;
            color: #667eea;
            font-weight: 600;
        }
        
        .upload-area { background: white; border: 2px dashed #cbd5e0; border-radius: 12px; padding: 3rem; text-align: center; margin-bottom: 2rem; transition: all 0.3s; }
        .upload-area:hover { border-color: #667eea; background: #f7fafc; }
        .upload-area.dragover { border-color: #667eea; background: #edf2f7; }
        
        .template-editor { background: white; border-radius: 12px; padding: 2rem; box-shadow: 0 4px 20px rgba(0,0,0,0.1); }
        .template-grid { display: grid; grid-template-columns: 1fr 300px; gap: 2rem; margin-top: 1rem; }
        .document-preview { position: relative; border: 1px solid #e2e8f0; border-radius: 8px; overflow: hidden; }
        .document-preview img { width: 100%; height: auto; display: block; }
        .field-overlay { position: absolute; border: 2px solid #667eea; background: rgba(102, 126, 234, 0.1); cursor: pointer; }
        
        .field-properties { background: #f8fafc; padding: 1.5rem; border-radius: 8px; }
        .field-item { background: white; padding: 1rem; margin-bottom: 0.5rem; border-radius: 6px; border: 1px solid #e2e8f0; }
        
        .batch-processor { background: white; border-radius: 12px; padding: 2rem; box-shadow: 0 4px 20px rgba(0,0,0,0.1); }
        .file-list { margin-top: 1rem; }
        .file-item { display: flex; align-items: center; justify-content: between; padding: 1rem; border: 1px solid #e2e8f0; border-radius: 8px; margin-bottom: 0.5rem; }
        .status { padding: 0.25rem 0.75rem; border-radius: 20px; font-size: 0.875rem; font-weight: 500; }
        .status.pending { background: #fef3c7; color: #92400e; }
        .status.processing { background: #dbeafe; color: #1e40af; }
        .status.completed { background: #d1fae5; color: #065f46; }
        .status.failed { background: #fee2e2; color: #991b1b; }
        
        .btn { padding: 0.75rem 1.5rem; border: none; border-radius: 8px; font-weight: 500; cursor: pointer; transition: all 0.3s; }
        .btn-primary { background: #667eea; color: white; }
        .btn-primary:hover { background: #5a67d8; }
        .btn-secondary { background: #e2e8f0; color: #4a5568; }
        .btn-secondary:hover { background: #cbd5e0; }
        
        .analytics-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1.5rem; margin-bottom: 2rem; }
        .metric-card { background: white; padding: 1.5rem; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.1); }
        .metric-value { font-size: 2rem; font-weight: 700; color: #667eea; }
        .metric-label { color: #64748b; font-size: 0.875rem; margin-top: 0.5rem; }
        
        .processing-status { background: white; padding: 1.5rem; border-radius: 12px; margin-bottom: 1rem; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .progress-bar { width: 100%; height: 8px; background: #e2e8f0; border-radius: 4px; overflow: hidden; margin-top: 1rem; }
        .progress-fill { height: 100%; background: #667eea; transition: width 0.3s; }
        
        .results-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 1.5rem; }
        .result-card { background: white; padding: 1.5rem; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.1); }
        
        @media (max-width: 768px) {
            .template-grid { grid-template-columns: 1fr; }
            .nav-tabs { flex-direction: column; }
            .analytics-grid { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>
    <div class="header" style="display: flex; justify-content: space-between; align-items: center; padding: 1.5rem 2rem;">
        <div>
            <h1 style="margin: 0;">üèõÔ∏è TaxDoc AI</h1>
            <p style="margin: 0.5rem 0 0 0;">AI-Powered Document Processing</p>
        </div>
        <div class="auth-section" style="position: relative;">
            <button class="user-dropdown" id="userDropdown" style="background: rgba(255,255,255,0.2); color: white; border: none; padding: 10px 15px; border-radius: 6px; cursor: pointer; display: flex; align-items: center; gap: 8px;">
                <span id="userDisplayName">Guest User</span>
                <span>‚ñº</span>
            </button>
            <div class="dropdown-menu" id="dropdownMenu" style="position: absolute; top: 100%; right: 0; background: white; border: 1px solid #ddd; border-radius: 6px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); min-width: 200px; display: none; z-index: 1000;">
                <div class="dropdown-item" id="profileItem" style="padding: 12px 16px; border-bottom: 1px solid #f0f0f0; color: #333;">
                    <strong id="userEmail">guest@example.com</strong><br>
                    <small>Free Plan</small>
                </div>
                <div class="dropdown-item" onclick="showSettings()" style="padding: 12px 16px; border-bottom: 1px solid #f0f0f0; cursor: pointer; color: #333; transition: background 0.2s;">Account Settings</div>
                <div class="dropdown-item" onclick="showBilling()" style="padding: 12px 16px; border-bottom: 1px solid #f0f0f0; cursor: pointer; color: #333; transition: background 0.2s;">Billing & Plans</div>
                <div class="dropdown-item" onclick="logout()" style="padding: 12px 16px; cursor: pointer; color: #333; transition: background 0.2s;">Sign Out</div>
            </div>
        </div>
    </div>

    <div class="nav-tabs">
        <button class="nav-tab active" onclick="showTab('upload')">üì§ Upload Documents</button>
        <button class="nav-tab" onclick="showTab('documents')">üìÑ My Documents</button>
        <button class="nav-tab" onclick="showTab('chatbot')">ü§ñ AI Chatbot</button>
        <button class="nav-tab" onclick="showTab('analytics')">üìä Analytics</button>
        <button class="nav-tab" onclick="showTab('pay')">üí≥ Plans</button>
        <button class="nav-tab" onclick="showTab('integrations')">üîó Integrations</button>
    </div>

    <div class="container">


        <!-- Upload & Batch Tab -->
        <div id="upload" class="tab-content active">
            <div class="upload-area" id="uploadArea">
                <h3>üì§ Upload Tax Documents</h3>
                <p>Drag & drop files here or click to select</p>
                <p style="font-size: 0.875rem; color: #64748b; margin-top: 1rem;">Supports PDF, PNG, JPG ‚Ä¢ Max 10MB per file</p>
                <div id="uploadTrialInfo" style="background: #f0f9ff; padding: 1rem; border-radius: 6px; margin-top: 1rem; border-left: 4px solid #0ea5e9;">
                    <strong>üéÜ Free Trial:</strong> Process up to 50 documents per month at no cost!
                </div>
                <input type="file" id="fileInput" multiple accept=".pdf,.png,.jpg,.jpeg" style="display: none;">
            </div>
            
            <div style="margin-top: 1rem; display: flex; gap: 1rem; justify-content: center;">
                <button class="btn btn-primary" onclick="processSelectedFiles()" id="processBtn" disabled>üöÄ Process Documents</button>
                <button class="btn btn-secondary" onclick="refreshPage()">üîÑ Refresh</button>
            </div>
            
            <div id="processingStatus" class="processing-status" style="display: none;">
                <h4>Processing Documents...</h4>
                <div class="progress-bar">
                    <div class="progress-fill" id="progressFill" style="width: 0%;"></div>
                </div>
                <p id="statusText">Initializing...</p>
            </div>

            <div id="results" class="results-grid" style="display: none;"></div>
        </div>

        <!-- Documents Tab -->
        <div id="documents" class="tab-content">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                <h3>üìÑ My Documents</h3>
                <button class="btn btn-secondary" onclick="loadDocuments()">üîÑ Refresh</button>
            </div>
            
            <div class="analytics-grid" style="margin-bottom: 2rem;">
                <div class="metric-card">
                    <div class="metric-value" id="totalDocsCount">0</div>
                    <div class="metric-label">Total Documents</div>
                </div>
                <div class="metric-card">
                    <div class="metric-value" id="processedDocsCount">0</div>
                    <div class="metric-label">Processed</div>
                </div>
                <div class="metric-card">
                    <div class="metric-value" id="avgConfidenceScore">0%</div>
                    <div class="metric-label">Avg Confidence</div>
                </div>
                <div class="metric-card">
                    <div class="metric-value" id="thisMonthCount">0</div>
                    <div class="metric-label">This Month</div>
                </div>
            </div>
            
            <input type="text" id="searchBar" placeholder="Search documents by content, type, or extracted fields..." style="width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 6px; margin-bottom: 20px; font-size: 16px;">
            
            <div style="display: flex; gap: 10px; margin-bottom: 20px; flex-wrap: wrap;" id="filterTabs">
                <div class="filter-tab active" data-filter="all" style="padding: 8px 16px; border: 1px solid #ddd; border-radius: 20px; background: #667eea; color: white; cursor: pointer; transition: all 0.3s;">All Documents</div>
                <div class="filter-tab" data-filter="W-2" style="padding: 8px 16px; border: 1px solid #ddd; border-radius: 20px; background: white; cursor: pointer; transition: all 0.3s;">W-2 Forms</div>
                <div class="filter-tab" data-filter="1099-NEC" style="padding: 8px 16px; border: 1px solid #ddd; border-radius: 20px; background: white; cursor: pointer; transition: all 0.3s;">1099-NEC</div>
                <div class="filter-tab" data-filter="INVOICE" style="padding: 8px 16px; border: 1px solid #ddd; border-radius: 20px; background: white; cursor: pointer; transition: all 0.3s;">Invoices</div>
                <div class="filter-tab" data-filter="RECEIPT" style="padding: 8px 16px; border: 1px solid #ddd; border-radius: 20px; background: white; cursor: pointer; transition: all 0.3s;">Receipts</div>
                <div class="filter-tab" data-filter="PAYSTUB" style="padding: 8px 16px; border: 1px solid #ddd; border-radius: 20px; background: white; cursor: pointer; transition: all 0.3s;">Paystubs</div>
                <div class="filter-tab" data-filter="BANK_STATEMENT" style="padding: 8px 16px; border: 1px solid #ddd; border-radius: 20px; background: white; cursor: pointer; transition: all 0.3s;">Bank Statements</div>
                <div class="filter-tab" data-filter="UNKNOWN" style="padding: 8px 16px; border: 1px solid #ddd; border-radius: 20px; background: white; cursor: pointer; transition: all 0.3s;">Other</div>
            </div>
            
            <div id="documentsResults" class="results-grid">
                <p>Loading documents...</p>
            </div>
        </div>

        <!-- AI Chatbot Tab -->
        <div id="chatbot" class="tab-content">
            <div style="background: white; padding: 2rem; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.1);">
                <h3>ü§ñ AI Document Chatbot</h3>
                <p>Ask questions about your processed documents</p>
                <div id="chatArea" style="background: #f8fafc; padding: 1rem; border-radius: 8px; margin: 1rem 0; min-height: 300px;">
                    <div style="margin-bottom: 1rem; padding: 1rem; background: #667eea; color: white; border-radius: 6px;">
                        <strong>AI:</strong> Hello! I can help you understand your tax documents. Ask me about wages, taxes, employer information, or any other details from your processed forms.
                    </div>
                </div>
                <div style="display: flex; gap: 1rem;">
                    <input type="text" id="chatInput" placeholder="Ask about your documents..." style="flex: 1; padding: 0.75rem; border: 1px solid #e2e8f0; border-radius: 6px;">
                    <button class="btn btn-primary" onclick="sendChatMessage()">Send</button>
                </div>
            </div>
        </div>

        <!-- Pay Tab -->
        <div id="pay" class="tab-content">
            <div style="background: white; padding: 2rem; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.1); text-align: center;">
                <h3>üí≥ Subscription Plans</h3>
                <p>Choose a plan that fits your document processing needs</p>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 2rem; margin: 2rem 0;">
                    <div style="border: 1px solid #e2e8f0; padding: 2rem; border-radius: 8px;">
                        <h4>Free Trial</h4>
                        <div style="font-size: 2rem; font-weight: bold; color: #10b981;">$0/mo</div>
                        <ul style="text-align: left; margin: 1rem 0;">
                            <li>50 documents/month</li>
                            <li>Basic AI extraction</li>
                            <li>CSV/JSON export</li>
                        </ul>
                        <button class="btn btn-secondary" onclick="startFreeTrial()">Start Free Trial</button>
                        <div id="trialStatus" style="margin-top: 1rem; font-size: 0.875rem;"></div>
                    </div>
                    <div style="border: 1px solid #e2e8f0; padding: 2rem; border-radius: 8px;">
                        <h4>Micro Plan</h4>
                        <div style="font-size: 2rem; font-weight: bold; color: #f59e0b;">$0.99</div>
                        <ul style="text-align: left; margin: 1rem 0;">
                            <li>5 additional documents</li>
                            <li>One-time purchase</li>
                            <li>All extraction features</li>
                        </ul>
                        <button class="btn btn-warning" onclick="subscribe('micro')">Buy Now</button>
                    </div>
                    <div style="border: 1px solid #e2e8f0; padding: 2rem; border-radius: 8px;">
                        <h4>Pro Plan</h4>
                        <div style="font-size: 2rem; font-weight: bold; color: #667eea;">$29/mo</div>
                        <ul style="text-align: left; margin: 1rem 0;">
                            <li>1,000 documents/month</li>
                            <li>AI-powered extraction</li>
                            <li>Batch processing</li>
                        </ul>
                        <button class="btn btn-primary" onclick="subscribe('pro')">Subscribe</button>
                    </div>
                    <div style="border: 2px solid #667eea; padding: 2rem; border-radius: 8px;">
                        <h4>Enterprise</h4>
                        <div style="font-size: 2rem; font-weight: bold; color: #667eea;">$99/mo</div>
                        <ul style="text-align: left; margin: 1rem 0;">
                            <li>Unlimited documents</li>
                            <li>Custom AI models</li>
                            <li>API access</li>
                        </ul>
                        <button class="btn btn-primary" onclick="subscribe('enterprise')">Subscribe</button>
                    </div>
                </div>
            </div>
        </div>





        <!-- Analytics Tab -->
        <div id="analytics" class="tab-content">
            <h3>üìä Processing Analytics</h3>
            
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
                <h3>üìä Processing Analytics</h3>
                <button class="btn btn-secondary" onclick="loadAnalytics()">üîÑ Refresh</button>
            </div>
            
            <div class="analytics-grid">
                <div class="metric-card">
                    <div class="metric-value" id="totalDocs">0</div>
                    <div class="metric-label">Total Documents</div>
                </div>
                <div class="metric-card">
                    <div class="metric-value" id="processedDocs">0</div>
                    <div class="metric-label">Processed</div>
                </div>
                <div class="metric-card">
                    <div class="metric-value" id="successRate">0%</div>
                    <div class="metric-label">Success Rate</div>
                </div>
                <div class="metric-card">
                    <div class="metric-value" id="avgConfidence">0%</div>
                    <div class="metric-label">Avg Confidence</div>
                </div>
                <div class="metric-card">
                    <div class="metric-value" id="processingTimeP50">0s</div>
                    <div class="metric-label">Processing Time (P50)</div>
                </div>
                <div class="metric-card">
                    <div class="metric-value" id="processingTimeP95">0s</div>
                    <div class="metric-label">Processing Time (P95)</div>
                </div>
                <div class="metric-card">
                    <div class="metric-value" id="storageUsed">0 MB</div>
                    <div class="metric-label">Storage Used</div>
                </div>
                <div class="metric-card">
                    <div class="metric-value" id="creditsRemaining">0</div>
                    <div class="metric-label">Credits Remaining</div>
                </div>
            </div>
            
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 2rem; margin-bottom: 2rem;">
                <div style="background: white; padding: 1.5rem; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.1);">
                    <h4>Document Types</h4>
                    <div id="documentTypes"></div>
                </div>
                <div style="background: white; padding: 1.5rem; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.1);">
                    <h4>Recent Activity</h4>
                    <div id="recentActivity"></div>
                </div>
            </div>


        </div>

        <!-- Integrations Tab -->
        <div id="integrations" class="tab-content">
            <h3>üîó Integrations & Export</h3>
            
            <div class="results-grid">
                <div class="result-card">
                    <h4>üìß Email Integration</h4>
                    <p>Forward documents to your unique email address for automatic processing</p>
                    <div style="background: #f8fafc; padding: 1rem; border-radius: 6px; margin: 1rem 0; font-family: monospace;">
                        [Generate your unique email address]
                    </div>
                    <button class="btn btn-primary">Generate Email</button>
                </div>

                <div class="result-card">
                    <h4>üìä Google Sheets</h4>
                    <p>Automatically export extracted data to Google Sheets</p>
                    <button class="btn btn-secondary" onclick="connectGoogleSheets()">Connect Sheets</button>
                </div>

                <div class="result-card">
                    <h4>‚ö° Zapier Integration</h4>
                    <p>Connect to 5000+ apps via Zapier webhooks</p>
                    <input type="url" placeholder="Webhook URL" style="width: 100%; padding: 0.5rem; border: 1px solid #e2e8f0; border-radius: 6px; margin: 0.5rem 0;">
                    <button class="btn btn-primary">Save Webhook</button>
                </div>

                <div class="result-card">
                    <h4>üîÑ API Access</h4>
                    <p>Programmatic access to document processing</p>
                    <div style="background: #f8fafc; padding: 1rem; border-radius: 6px; margin: 1rem 0; font-family: monospace; font-size: 0.875rem;">
                        POST /api/v1/process<br>
                        Authorization: Bearer your-api-key
                    </div>
                    <button class="btn btn-secondary">Generate API Key</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Edit Document Modal -->
    <div id="editModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 2000; align-items: center; justify-content: center;">
        <div style="background: white; border-radius: 12px; padding: 30px; max-width: 600px; width: 90%; max-height: 80vh; overflow-y: auto;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; padding-bottom: 15px; border-bottom: 1px solid #eee;">
                <h3 style="margin: 0;">Edit Document Fields</h3>
                <button onclick="closeEditModal()" style="background: none; border: none; font-size: 24px; cursor: pointer; color: #999; padding: 0; width: 30px; height: 30px;">&times;</button>
            </div>
            <div id="editForm">
                <!-- Form fields will be populated here -->
            </div>
            <div style="margin-top: 20px; display: flex; gap: 10px; justify-content: flex-end;">
                <button class="btn btn-secondary" onclick="closeEditModal()">Cancel</button>
                <button class="btn" onclick="saveDocument()" style="background: #27ae60; color: white;">Save Changes</button>
                <button class="btn btn-primary" onclick="downloadDocument()">Download</button>
            </div>
        </div>
    </div>

    <script>
        let currentFiles = [];
        let documents = [];
        let currentEditingDoc = null;
        const API_BASE = "https://iljpaj6ogl.execute-api.us-east-1.amazonaws.com/prod";

        // User management
        function getUserId() {
            return localStorage.getItem('userId') || 'ANON';
        }
        
        function getUserEmail() {
            return localStorage.getItem('userEmail') || 'guest@example.com';
        }
        
        function getUserName() {
            return localStorage.getItem('userName') || 'Guest User';
        }
        
        // Tab Management
        function showTab(tabName) {
            document.querySelectorAll('.tab-content').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.nav-tab').forEach(tab => tab.classList.remove('active'));
            document.getElementById(tabName).classList.add('active');
            event.target.classList.add('active');
            
            if (tabName === 'documents') {
                loadDocuments();
            }
        }
        
        // Auth functions
        function toggleDropdown() {
            document.getElementById('dropdownMenu').classList.toggle('show');
        }
        
        function showSettings() {
            alert('Account settings coming soon...');
        }
        
        function showBilling() {
            alert('Billing & plans coming soon...');
        }
        
        function logout() {
            localStorage.removeItem('userId');
            localStorage.removeItem('userEmail');
            localStorage.removeItem('userName');
            window.location.reload();
        }

        // File Upload
        document.getElementById('uploadArea').addEventListener('click', () => {
            document.getElementById('fileInput').click();
        });

        document.getElementById('fileInput').addEventListener('change', (e) => {
            if (e.target.files.length > 0) {
                document.getElementById('processBtn').disabled = false;
                document.getElementById('processBtn').textContent = `üöÄ Process ${e.target.files.length} Document(s)`;
            }
        });
        document.getElementById('batchFileInput').addEventListener('change', handleBatchFileUpload);

        // Drag and Drop
        ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
            document.getElementById('uploadArea').addEventListener(eventName, preventDefaults, false);
        });

        function preventDefaults(e) {
            e.preventDefault();
            e.stopPropagation();
        }

        ['dragenter', 'dragover'].forEach(eventName => {
            document.getElementById('uploadArea').addEventListener(eventName, () => {
                document.getElementById('uploadArea').classList.add('dragover');
            });
        });

        ['dragleave', 'drop'].forEach(eventName => {
            document.getElementById('uploadArea').addEventListener(eventName, () => {
                document.getElementById('uploadArea').classList.remove('dragover');
            });
        });

        document.getElementById('uploadArea').addEventListener('drop', (e) => {
            const files = e.dataTransfer.files;
            processFiles(files);
        });

        function processSelectedFiles() {
            const files = document.getElementById('fileInput').files;
            if (files.length > 0) {
                processFiles(files);
            }
        }
        
        function refreshPage() {
            window.location.reload();
        }

        function handleBatchFileUpload(e) {
            batchFiles = Array.from(e.target.files);
            displayBatchFiles();
            document.getElementById('processBatchBtn').disabled = false;
        }

        async function processFiles(files) {
            currentFiles = Array.from(files);
            document.getElementById('processingStatus').style.display = 'block';
            document.getElementById('results').style.display = 'none';

            for (let i = 0; i < files.length; i++) {
                const file = files[i];
                updateProgress((i / files.length) * 100, `Processing ${file.name}...`);
                
                try {
                    const result = await processDocument(file);
                    displayResult(result, file.name, file);
                } catch (error) {
                    console.error('Processing error:', error);
                }
            }

            updateProgress(100, 'Processing complete!');
            setTimeout(() => {
                document.getElementById('processingStatus').style.display = 'none';
                document.getElementById('results').style.display = 'grid';
            }, 1000);
        }





        async function processDocument(file) {
            // Check trial usage first
            const usage = await checkTrialUsage();
            if (usage.exceeded) {
                throw new Error('Free trial limit exceeded. Please upgrade to continue.');
            }
            
            // Convert file to base64
            const base64Content = await fileToBase64(file);
            
            // Process document directly
            const proc = await fetch(`${API_BASE}/process-document`, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ 
                    filename: file.name,
                    contentBase64: base64Content
                })
            });
            
            if (!proc.ok) {
                const errorText = await proc.text();
                throw new Error(`Process failed: ${proc.status} - ${errorText}`);
            }
            
            const result = await proc.json();
            console.log('API Response:', result);
            
            // Transform API response to frontend format
            const transformedResult = {
                document_type: result.docType || 'Unknown',
                confidence_score: Math.round((result.docTypeConfidence || 0) * 100),
                extracted_data: {}
            };
            
            // Convert API data format to frontend format with confidence scores
            if (result.fields && typeof result.fields === 'object') {
                Object.entries(result.fields).forEach(([key, value]) => {
                    // Skip error fields and text length fields
                    if (key !== 'error' && key !== 'EXTRACTED_TEXT_LENGTH' && key !== 'raw_text') {
                        transformedResult.extracted_data[key] = {
                            value: value || '',
                            confidence: 95
                        };
                    }
                });
            }
            
            // Add keyValues to extracted_data if no fields
            if (Object.keys(transformedResult.extracted_data).length === 0 && result.keyValues) {
                result.keyValues.forEach(kv => {
                    transformedResult.extracted_data[kv.key] = {
                        value: kv.value || '',
                        confidence: 90
                    };
                });
            }
            
            // Update trial usage
            await updateTrialUsage();
            return transformedResult;
        }
        
        function fileToBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = () => {
                    const dataUrl = reader.result;
                    const base64 = dataUrl.split(',')[1];
                    resolve(base64);
                };
                reader.onerror = reject;
                reader.readAsDataURL(file);
            });
        }

        function updateProgress(percent, text) {
            document.getElementById('progressFill').style.width = percent + '%';
            document.getElementById('statusText').textContent = text;
        }

        function displayResult(result, filename, file) {
            const resultsContainer = document.getElementById('results');
            const resultCard = document.createElement('div');
            resultCard.className = 'result-card';
            
            // Create image preview
            const imageUrl = URL.createObjectURL(file);
            
            resultCard.innerHTML = `
                <h4>üìÑ ${filename}</h4>
                <p><strong>Type:</strong> ${result.document_type} | <strong>Confidence:</strong> ${result.confidence_score}%</p>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 2rem; margin-top: 1rem;">
                    <!-- Image Preview -->
                    <div style="background: #f8fafc; padding: 1rem; border-radius: 8px; border: 1px solid #e2e8f0;">
                        <h5>Document Preview</h5>
                        <img src="${imageUrl}" alt="${filename}" style="width: 100%; max-height: 600px; object-fit: contain; border-radius: 6px; border: 1px solid #cbd5e0;">
                    </div>
                    
                    <!-- Extracted Data -->
                    <div style="background: #f8fafc; padding: 1rem; border-radius: 8px; border: 1px solid #e2e8f0; max-height: 600px; overflow-y: auto;">
                        <h5>Extracted Data (${Object.keys(result.extracted_data).length} fields)</h5>
                        <div style="display: grid; gap: 0.5rem; margin-top: 1rem;">
                            ${Object.entries(result.extracted_data).map(([key, data]) => `
                                <div style="background: white; padding: 0.75rem; border-radius: 6px; border-left: 3px solid #667eea;">
                                    <div style="font-weight: 600; font-size: 0.875rem; color: #374151;">${key.replace(/_/g, ' ').toUpperCase()}</div>
                                    <div style="font-size: 1rem; margin-top: 0.25rem;">${data.value}</div>
                                    <div style="color: #10b981; font-size: 0.75rem; margin-top: 0.25rem;">Confidence: ${data.confidence}%</div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                </div>
            `;
            
            resultsContainer.appendChild(resultCard);
            
            // Save to persistent storage and refresh documents tab
            setTimeout(async () => {
                await saveDocumentToPersistentStorage({
                    docId: generateId(),
                    filename: filename,
                    status: 'completed',
                    docType: result.document_type,
                    docTypeConfidence: result.confidence_score / 100,
                    fields: Object.fromEntries(Object.entries(result.extracted_data).map(([k, v]) => [k, v.value])),
                    summary: `Processed ${result.document_type} with ${result.confidence_score}% confidence`,
                    uploadDate: new Date().toISOString(),
                    userId: getUserId()
                });
                loadDocuments();
            }, 2000);
        }



        // Export Functions
        async function downloadJSON(filename) {
            try {
                const response = await fetch(`${API_BASE}/export/json?filename=${filename}`);
                const blob = await response.blob();
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = filename.replace(/\.[^/.]+$/, '') + '.json';
                a.click();
            } catch (error) {
                alert('Download failed');
            }
        }

        function downloadCSV(filename) {
            // Generate CSV from actual extracted data
            alert('CSV export not implemented yet');
        }

        // Integration Functions
        async function connectGoogleSheets() {
            try {
                const response = await fetch(`${API_BASE}/integrations/sheets`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ action: 'connect' })
                });
                const result = await response.json();
                alert(result.message || 'Google Sheets connected successfully!');
            } catch (error) {
                alert('Google Sheets connection failed');
            }
        }

        // Live Functions
        function openAuthModal() {
            document.getElementById('authModal').style.display = 'flex';
        }
        
        function closeAuthModal() {
            document.getElementById('authModal').style.display = 'none';
        }
        
        function showLogin() {
            document.getElementById('loginForm').style.display = 'block';
            document.getElementById('registerForm').style.display = 'none';
            document.getElementById('loginTab').classList.add('active');
            document.getElementById('registerTab').classList.remove('active');
        }
        
        function showRegister() {
            document.getElementById('loginForm').style.display = 'none';
            document.getElementById('registerForm').style.display = 'block';
            document.getElementById('loginTab').classList.remove('active');
            document.getElementById('registerTab').classList.add('active');
        }
        
        async function handleLogin() {
            const email = document.getElementById('loginEmail').value;
            
            if (!email) {
                document.getElementById('loginError').innerHTML = 'Please enter email';
                return;
            }
            
            // Simulate login for demo
            document.getElementById('authStatus').innerHTML = `‚úÖ Logged in as ${email}`;
            localStorage.setItem('userEmail', email);
            closeAuthModal();
        }
        
        async function handleRegister() {
            const email = document.getElementById('registerEmail').value;
            
            if (!email) {
                document.getElementById('registerError').innerHTML = 'Please enter email';
                return;
            }
            
            // Simulate registration for demo
            document.getElementById('registerError').innerHTML = '‚úÖ Registered successfully! Please login.';
            document.getElementById('registerError').style.color = 'green';
            setTimeout(() => showLogin(), 2000);
        }
        
        async function subscribe(plan) {
            const email = localStorage.getItem('userEmail');
            const authToken = localStorage.getItem('authToken');
            
            if (!authToken) {
                alert('Please login first to subscribe.');
                return;
            }
            
            const priceIds = {
                'micro': 'price_1S59HJBgGYaywldnGTnB64ha',
                'pro': 'price_1S59HtBgGYaywldnpTk4ReM9', 
                'enterprise': 'price_1S59IIBgGYaywldnnvkWZxTb'
            };
            
            const response = await fetch(`${API_BASE}/stripe/create-checkout`, {
                method: 'POST',
                headers: { 
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${authToken}`
                },
                body: JSON.stringify({ 
                    price_id: priceIds[plan],
                    mode: plan === 'micro' ? 'payment' : 'subscription',
                    success_url: window.location.href + '?success=true',
                    cancel_url: window.location.href + '?cancelled=true'
                })
            });
            
            const result = await response.json();
            
            if (response.ok && result.checkout_url) {
                window.location.href = result.checkout_url;
            } else {
                alert('Payment setup failed: ' + (result.error || 'Unknown error'));
            }
        }
        
        async function sendChatMessage() {
            const input = document.getElementById('chatInput');
            const message = input.value.trim();
            if (!message) return;
            
            const chatArea = document.querySelector('#chatbot div[style*="background: #f8fafc"]');
            
            // Add user message immediately
            chatArea.innerHTML += `
                <div style="margin-bottom: 1rem; padding: 1rem; background: white; border-radius: 6px;">
                    <strong>You:</strong> ${message}
                </div>
            `;
            input.value = '';
            
            // Add typing indicator
            const typingId = 'typing-' + Date.now();
            chatArea.innerHTML += `
                <div id="${typingId}" style="margin-bottom: 1rem; padding: 1rem; background: #667eea; color: white; border-radius: 6px;">
                    <strong>AI:</strong> <em>Thinking...</em>
                </div>
            `;
            
            try {
                const response = await fetch(`${API_BASE}/chatbot`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        question: message,
                        context: {
                            document_type: 'W-2',
                            extracted_data: getLastProcessedData()
                        }
                    })
                });
                
                const result = await response.json();
                
                // Remove typing indicator
                document.getElementById(typingId).remove();
                
                // Add AI response
                const aiResponse = result.response || 'I can help you with questions about your processed documents.';
                chatArea.innerHTML += `
                    <div style="margin-bottom: 1rem; padding: 1rem; background: #667eea; color: white; border-radius: 6px;">
                        <strong>AI:</strong> ${aiResponse}
                    </div>
                `;
                
                // Add suggested actions if available
                if (result.response?.suggested_actions?.length > 0) {
                    chatArea.innerHTML += `
                        <div style="margin-bottom: 1rem; padding: 0.75rem; background: #f0f9ff; border-radius: 6px; border-left: 3px solid #0ea5e9;">
                            <strong>Suggestions:</strong><br>
                            ${result.response.suggested_actions.map(action => `‚Ä¢ ${action}`).join('<br>')}
                        </div>
                    `;
                }
                
            } catch (error) {
                // Remove typing indicator
                document.getElementById(typingId)?.remove();
                
                // Smart fallback based on message content
                let smartResponse = getSmartResponse(message);
                
                chatArea.innerHTML += `
                    <div style="margin-bottom: 1rem; padding: 1rem; background: #667eea; color: white; border-radius: 6px;">
                        <strong>AI:</strong> ${smartResponse}
                    </div>
                `;
            }
        }
        
        function getLastProcessedData() {
            // Get data from last processed document
            return {};
        }
        
        function getSmartResponse(message) {
            return 'I\'m here to help with your tax documents. Please process a document first, then I can answer questions about the extracted data.';
        }
        
        async function loadAnalytics() {
            /* disabled until route exists */
        }
        
        async function loadDocuments() {
            try {
                // Try to load from backend first
                const response = await fetch(`${API_BASE}/documents?userId=${getUserId()}`);
                if (response.ok) {
                    documents = await response.json();
                } else {
                    throw new Error('Backend unavailable');
                }
            } catch (error) {
                console.log('Loading from local storage');
                // Fallback to local storage
                documents = JSON.parse(localStorage.getItem(`docs_${getUserId()}`) || '[]');
            }
            
            updateDocumentStats();
            updateDocumentGrid();
        }
        
        function updateDocumentStats() {
            const total = documents.length;
            const processed = documents.filter(d => d.status === 'completed').length;
            const avgConf = processed > 0 ? 
                Math.round(documents.filter(d => d.status === 'completed')
                    .reduce((sum, d) => sum + (d.docTypeConfidence || 0), 0) / processed * 100) : 0;
            
            const thisMonth = documents.filter(d => {
                const docDate = new Date(d.uploadDate || d.createdAt || Date.now());
                const now = new Date();
                return docDate.getMonth() === now.getMonth() && docDate.getFullYear() === now.getFullYear();
            }).length;

            document.getElementById('totalDocsCount').textContent = total;
            document.getElementById('processedDocsCount').textContent = processed;
            document.getElementById('avgConfidenceScore').textContent = avgConf + '%';
            document.getElementById('thisMonthCount').textContent = thisMonth;
        }
        
        function updateDocumentGrid() {
            const grid = document.getElementById('documentsResults');
            const searchTerm = document.getElementById('searchBar').value.toLowerCase();
            const activeFilter = document.querySelector('.filter-tab.active').dataset.filter;

            const filteredDocs = documents.filter(doc => {
                // Filter by type
                if (activeFilter !== 'all' && doc.docType !== activeFilter) return false;
                
                // Filter by search term
                if (searchTerm) {
                    const searchableText = [
                        doc.filename,
                        doc.docType,
                        doc.summary,
                        ...Object.values(doc.fields || {}),
                        ...Object.values(doc.keyValues || []).map(kv => kv.key + ' ' + kv.value)
                    ].join(' ').toLowerCase();
                    
                    if (!searchableText.includes(searchTerm)) return false;
                }
                
                return true;
            });

            if (filteredDocs.length === 0) {
                grid.innerHTML = '<p style="color: #64748b; text-align: center; padding: 2rem;">No documents found. Upload documents in the Upload tab.</p>';
                return;
            }

            grid.innerHTML = filteredDocs.map(doc => createDocumentCard(doc)).join('');
        }
        
        function createDocumentCard(doc) {
            const confidenceClass = getConfidenceClass(doc.docTypeConfidence);
            const docTypeClass = doc.docType.toLowerCase().replace(/[^a-z0-9]/g, '-');
            
            return `
                <div class="result-card" style="position: relative;">
                    ${doc.status === 'completed' ? `
                        <div style="position: absolute; top: 15px; right: 15px; display: flex; gap: 8px;">
                            <button onclick="editDocument('${doc.docId}')" style="background: #f8f9fa; border: 1px solid #ddd; border-radius: 4px; padding: 6px 10px; font-size: 12px; cursor: pointer;">Edit</button>
                            <button onclick="downloadDocument('${doc.docId}')" style="background: #f8f9fa; border: 1px solid #ddd; border-radius: 4px; padding: 6px 10px; font-size: 12px; cursor: pointer;">Download</button>
                        </div>
                    ` : ''}
                    
                    <div style="display: inline-block; padding: 4px 12px; border-radius: 20px; font-size: 12px; font-weight: bold; margin-bottom: 10px; text-transform: uppercase; background: #667eea; color: white;">${doc.docType}</div>
                    <div style="font-size: 12px; color: #7f8c8d; margin-bottom: 10px;">Confidence: ${Math.round((doc.docTypeConfidence || 0) * 100)}%</div>
                    <h4>${doc.filename}</h4>
                    
                    ${doc.summary ? `<div style="background: #f8f9fa; padding: 12px; border-radius: 6px; margin-top: 10px; font-style: italic; color: #5a6c7d; font-size: 14px;">${doc.summary}</div>` : ''}
                    
                    ${renderExtractedFields(doc.fields)}
                </div>
            `;
        }
        
        function getConfidenceClass(confidence) {
            if (confidence >= 0.8) return 'high';
            if (confidence >= 0.6) return 'medium';
            return 'low';
        }
        
        function renderExtractedFields(fields) {
            if (!fields || Object.keys(fields).length === 0) return '';
            
            const items = Object.entries(fields)
                .filter(([_, v]) => v && String(v).trim() !== "" && String(v) !== "null")
                .map(([k, v]) => ({
                    label: formatFieldName(k),
                    value: typeof v === "object" ? v.value : v,
                    confidence: typeof v === "object" ? Math.round(100 * (v.confidence || 0.9)) : 90
                }))
                .sort((a, b) => a.label.localeCompare(b.label));

            if (items.length === 0) return '';

            return `
                <div style="margin-top: 15px;">
                    <strong>Extracted Fields (${items.length}):</strong>
                    ${items.slice(0, 8).map(item => `
                        <div style="display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid #ecf0f1; font-size: 14px;">
                            <span style="font-weight: 600; color: #2c3e50;">${item.label}</span>
                            <span style="color: #34495e; text-align: right; max-width: 60%; word-break: break-word;">${item.value}</span>
                        </div>
                    `).join('')}
                    ${items.length > 8 ? `<div style="padding: 8px 0; font-style: italic;"><em>+${items.length - 8} more fields</em></div>` : ''}
                </div>
            `;
        }
        
        const FIELD_LABELS = {
            employee_ssn: "Employee SSN",
            employer_ein: "Employer EIN",
            employee_name: "Employee Name",
            employer_address: "Employer Address",
            "Employee SSN": "Employee SSN",
            "Employee Name": "Employee Name",
            "Employer EIN": "Employer EIN",
            "Box 1 - Wages": "Wages, tips, other compensation (Box 1)",
            "Box 2 - Federal Tax": "Federal income tax withheld (Box 2)",
            "Box 3 - SS Wages": "Social security wages (Box 3)",
            "Box 4 - SS Tax": "Social security tax withheld (Box 4)",
            "Box 5 - Medicare Wages": "Medicare wages and tips (Box 5)",
            "Box 6 - Medicare Tax": "Medicare tax withheld (Box 6)",
            box1_wages: "Wages, tips, other compensation (Box 1)",
            box2_fed_tax: "Federal income tax withheld (Box 2)",
            box3_ss_wages: "Social security wages (Box 3)",
            box4_ss_tax: "Social security tax withheld (Box 4)",
            box5_medicare_wages: "Medicare wages and tips (Box 5)",
            box6_medicare_tax: "Medicare tax withheld (Box 6)",
            box12a: "Box 12a", box12b: "Box 12b", box12c: "Box 12c", box12d: "Box 12d",
            state: "State (Box 15)", state_wages: "State wages (Box 16)",
            state_tax: "State income tax (Box 17)", local_wages: "Local wages (Box 18)",
            local_tax: "Local income tax (Box 19)", locality: "Locality name (Box 20)",
            taxyear: "Tax Year", "Tax Year": "Tax Year"
        };
        
        function formatFieldName(key) {
            return FIELD_LABELS[key] || key.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
        }
        
        // Edit document functions
        function editDocument(docId) {
            const doc = documents.find(d => d.docId === docId);
            if (!doc) return;

            currentEditingDoc = doc;
            populateEditForm(doc);
            document.getElementById('editModal').style.display = 'flex';
        }
        
        function populateEditForm(doc) {
            const form = document.getElementById('editForm');
            const fields = doc.fields || {};
            
            let formHTML = `
                <div style="margin-bottom: 1rem;">
                    <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #333;">Document Type</label>
                    <input type="text" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px;" value="${doc.docType}" readonly>
                </div>
                <div style="margin-bottom: 1rem;">
                    <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #333;">Filename</label>
                    <input type="text" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px;" value="${doc.filename}" readonly>
                </div>
            `;

            // Add existing fields
            Object.entries(fields).forEach(([key, value]) => {
                const displayValue = typeof value === 'object' ? value.value : value;
                formHTML += `
                    <div style="margin-bottom: 1rem;">
                        <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #333;">${formatFieldName(key)}</label>
                        <div style="display: flex; align-items: center;">
                            <input type="text" style="flex: 1; padding: 10px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px;" data-field="${key}" value="${displayValue || ''}">
                            <button type="button" onclick="removeField('${key}')" style="background: #e74c3c; color: white; border: none; padding: 4px 8px; border-radius: 3px; cursor: pointer; font-size: 12px; margin-left: 10px;">Remove</button>
                        </div>
                    </div>
                `;
            });

            // Add new field section
            formHTML += `
                <div style="margin-bottom: 1rem;">
                    <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #333;">Add New Field</label>
                    <div style="display: flex; gap: 10px; margin-bottom: 10px;">
                        <input type="text" id="newFieldName" style="flex: 1; padding: 10px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px;" placeholder="Field name">
                        <input type="text" id="newFieldValue" style="flex: 1; padding: 10px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px;" placeholder="Field value">
                        <button type="button" onclick="addNewField()" style="background: #27ae60; color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer; font-size: 14px;">Add</button>
                    </div>
                </div>
            `;

            form.innerHTML = formHTML;
        }
        
        function addNewField() {
            const nameInput = document.getElementById('newFieldName');
            const valueInput = document.getElementById('newFieldValue');
            
            if (!nameInput.value.trim() || !valueInput.value.trim()) return;

            const key = nameInput.value.trim();
            const value = valueInput.value.trim();

            // Add to current editing doc
            if (!currentEditingDoc.fields) currentEditingDoc.fields = {};
            currentEditingDoc.fields[key] = value;

            // Refresh form
            populateEditForm(currentEditingDoc);
        }
        
        function removeField(fieldKey) {
            if (currentEditingDoc.fields) {
                delete currentEditingDoc.fields[fieldKey];
                populateEditForm(currentEditingDoc);
            }
        }
        
        async function saveDocument() {
            if (!currentEditingDoc) return;

            // Collect form data
            const formInputs = document.querySelectorAll('#editForm input[data-field]');
            const updatedFields = {};
            
            formInputs.forEach(input => {
                const fieldKey = input.dataset.field;
                const fieldValue = input.value.trim();
                if (fieldValue) {
                    updatedFields[fieldKey] = fieldValue;
                }
            });

            currentEditingDoc.fields = updatedFields;

            try {
                // Save to backend
                await fetch(`${API_BASE}/document/${currentEditingDoc.docId}`, {
                    method: 'PATCH',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        fields: updatedFields,
                        userId: getUserId()
                    })
                });

                // Update local documents array
                const docIndex = documents.findIndex(d => d.docId === currentEditingDoc.docId);
                if (docIndex !== -1) {
                    documents[docIndex] = { ...currentEditingDoc };
                }

                // Update local storage
                localStorage.setItem(`docs_${getUserId()}`, JSON.stringify(documents));

                closeEditModal();
                updateDocumentGrid();
                
            } catch (error) {
                console.error('Failed to save document:', error);
                alert('Failed to save changes. Please try again.');
            }
        }
        
        function downloadDocument(docId) {
            const doc = currentEditingDoc || documents.find(d => d.docId === docId);
            if (!doc) return;

            const data = {
                filename: doc.filename,
                docType: doc.docType,
                fields: doc.fields || {},
                extractedAt: new Date().toISOString()
            };

            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `${doc.filename.replace(/\.[^/.]+$/, '')}_extracted.json`;
            a.click();
            URL.revokeObjectURL(url);
        }
        
        function closeEditModal() {
            document.getElementById('editModal').style.display = 'none';
            currentEditingDoc = null;
        }
        
        async function saveDocumentToPersistentStorage(doc) {
            try {
                // Save to backend
                await fetch(`${API_BASE}/documents`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(doc)
                });
                
                // Also save locally
                const savedDocs = JSON.parse(localStorage.getItem(`docs_${getUserId()}`) || '[]');
                savedDocs.unshift(doc);
                localStorage.setItem(`docs_${getUserId()}`, JSON.stringify(savedDocs));
                
            } catch (error) {
                console.error('Failed to save document:', error);
                // Fallback to local storage only
                const savedDocs = JSON.parse(localStorage.getItem(`docs_${getUserId()}`) || '[]');
                savedDocs.unshift(doc);
                localStorage.setItem(`docs_${getUserId()}`, JSON.stringify(savedDocs));
            }
        }
        
        function generateId() {
            return 'doc_' + Math.random().toString(36).substr(2, 9);
        }
        

        
        async function startFreeTrial() {
            // Activate trial locally
            localStorage.setItem('trialActive', 'true');
            localStorage.setItem('trialUsage', '0');
            localStorage.setItem('trialStartDate', new Date().toISOString());
            document.getElementById('trialStatus').innerHTML = '‚úÖ Free trial activated! 50 documents remaining.';
        }
        
        async function checkTrialUsage() {
            const usage = parseInt(localStorage.getItem('trialUsage') || '0');
            const isActive = localStorage.getItem('trialActive') === 'true';
            
            if (!isActive) {
                return { exceeded: false, remaining: 50 };
            }
            
            const remaining = Math.max(0, 50 - usage);
            return { 
                exceeded: usage >= 50, 
                remaining,
                used: usage
            };
        }
        
        async function updateTrialUsage() {
            const currentUsage = parseInt(localStorage.getItem('trialUsage') || '0');
            const newUsage = currentUsage + 1;
            localStorage.setItem('trialUsage', newUsage.toString());
            
            const remaining = Math.max(0, 50 - newUsage);
            if (remaining === 0) {
                document.getElementById('trialStatus').innerHTML = '‚ö†Ô∏è Trial limit reached. Upgrade to continue.';
            } else {
                document.getElementById('trialStatus').innerHTML = `‚úÖ ${remaining} documents remaining in trial.`;
            }
        }
        
        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            // Initialize auth UI
            document.getElementById('userDisplayName').textContent = getUserName();
            document.getElementById('userEmail').textContent = getUserEmail();
            
            // Setup event listeners
            document.getElementById('userDropdown').addEventListener('click', toggleDropdown);
            document.addEventListener('click', (e) => {
                if (!e.target.closest('.auth-section')) {
                    const dropdown = document.getElementById('dropdownMenu');
                    if (dropdown.style.display === 'block') {
                        dropdown.style.display = 'none';
                    }
                }
            });
            
            // Search and filters
            document.getElementById('searchBar').addEventListener('input', updateDocumentGrid);
            document.getElementById('filterTabs').addEventListener('click', (e) => {
                if (e.target.classList.contains('filter-tab')) {
                    document.querySelectorAll('.filter-tab').forEach(tab => {
                        tab.classList.remove('active');
                        tab.style.background = 'white';
                        tab.style.color = '#333';
                    });
                    e.target.classList.add('active');
                    e.target.style.background = '#667eea';
                    e.target.style.color = 'white';
                    updateDocumentGrid();
                }
            });
            
            // Dropdown hover effects
            document.querySelectorAll('.dropdown-item').forEach(item => {
                item.addEventListener('mouseenter', () => {
                    item.style.background = '#f8f9fa';
                });
                item.addEventListener('mouseleave', () => {
                    item.style.background = 'white';
                });
            });
            
            loadAnalytics();
            loadDocuments();
            
            // Check trial status on load
            const isTrialActive = localStorage.getItem('trialActive') === 'true';
            if (isTrialActive) {
                checkTrialUsage().then(usage => {
                    if (usage.remaining > 0) {
                        document.getElementById('trialStatus').innerHTML = `‚úÖ ${usage.remaining} documents remaining in trial.`;
                    } else {
                        document.getElementById('trialStatus').innerHTML = '‚ö†Ô∏è Trial limit reached. Upgrade to continue.';
                    }
                });
            }
        });
    </script>
</body>
</html>